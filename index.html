<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- V29 ä¿®æ­£ç‰ˆ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      background: #f3f4f6;
      font-family: "Microsoft JhengHei", sans-serif;
    }

    /* 1. ä¿®æ­£ï¼šé è¨­éš±è—åˆ—å°å°ˆç”¨å€å¡Šï¼Œ
      è§£æ±ºã€Œç•«é¢è·‘å‡ºå…©å€‹é è¦½ã€çš„å•é¡Œ 
    */
    .print-only-layout {
      display: none;
    }

   /* =================================================
       âœ… ä¿®æ­£å¾Œçš„åˆ—å°å°ˆç”¨ CSS
    ================================================= */
    @media print {
      /* 1. å¼·åˆ¶é‡ç½®æ‰€æœ‰å®¹å™¨ï¼Œå–æ¶ˆ Flex æ’ç‰ˆ */
      body, 
      #root, 
      .quote-editor-root-container, 
      div {
        display: block !important; /* é—œéµï¼šå–æ¶ˆ flexï¼Œæ”¹ç‚ºå€å¡Š */
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        position: static !important;
        background: white;
      }

      /* 2. éš±è—ä¸éœ€è¦åˆ—å°çš„å…ƒç´  */
      .no-print,
      .live-preview-box,
      aside, /* å¦‚æœå´é‚Šæ¬„æ˜¯ç”¨ aside */
      nav {
        display: none !important;
      }

      /* 3. è¨­å®šåˆ—å°å€åŸŸæ»¿ç‰ˆ */
      .print-only-layout {
        display: block !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’å¤§å¯¬åº¦ */
      }

      /* 4. è¡¨æ ¼è¨­å®š */
      table {
        width: 100% !important;
        border-collapse: collapse;
        table-layout: fixed; /* è®“æ¬„ä½å¯¬åº¦ä¾ç…§è¨­å®šçš„ % è·‘ï¼Œä¸è¦è¢«å…§å®¹æ’é–‹æˆ–å£“ç¸® */
      }

      thead {
        display: table-header-group;
      }

      tr {
        page-break-inside: avoid;
      }

      /* 5. ç¢ºä¿æ–‡å­—ä¸æœƒå› ç‚ºå¤ªæ“ è€Œè®Šç›´å‘ */
      td, th {
        white-space: normal; /* å…è¨±æ›è¡Œ */
        word-wrap: break-word; /*é•·å–®å­—æ›è¡Œ*/
        vertical-align: middle; /* å‚ç›´ç½®ä¸­ */
      }

      .print-footer-block,
      .print-signature-area {
        page-break-inside: avoid;
      }

      @page {
        size: A4;
        margin: 10mm; /* é‚Šè·è¨­ç‚º 10mmï¼Œè®“ç©ºé–“æ›´å¤§ */
      }
    }
  </style>
</head>

<body class="text-gray-900">
  <div id="root"></div>

  <script type="text/babel">

/***********************************************************
 * P1 â€” å…¬å¸è³‡æ–™ / å‚™è¨» / ä»˜æ¬¾æ¢ä»¶ / æ¨¡å¼æ¨¡æ¿
 ***********************************************************/
const COMPANY_DATA = {
  herhsin: {
    name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
    taxId: "76380260",  
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
    stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
    prefix: "QH",
  },
  sinchang: {
    name: "è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸",
    taxId: "53896738",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
    stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
    prefix: "QS",
  },
};

const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;
 
// =========================================================
// å ±åƒ¹æ¨¡å¼è¨­å®š (å·²ç§»é™¤è¨­å‚™éŠ·å”®ï¼Œä¸¦æ›´æ–°æ¼æ¼¿æ¨¡å¼æ‰€æœ‰ç´°ç¯€)
// =========================================================
const QUOTE_MODES = [
  {
    id: "mode_leak_repair",
    name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›å·¥ç¨‹",
    description: "æ‹Œåˆæ©Ÿæ¼æ¼¿ä¿®å¾©ï¼ŒåŒ…å·¥åŒ…æ–™é …ç›®å¦è¨ˆï¼Œé›¶ä»¶å¯¦æ”¯å¯¦ä»˜",
    
    // 1. ä¸»è¦å·¥ç¨‹é …ç›® (å·²åŠ å…¥é è¨­ç”¨æ–™æ˜ç´°)
    defaultItems: [
      {
        name: "æ›´æ› 3mÂ³ æ‹Œåˆæ©Ÿã€æ¸›é€Ÿæ©Ÿå´ã€‘æ¼æ¼¿ï¼ˆå«å·¥è³‡åŠææ–™ï¼‰",
        unit: "å¼",
        qty: 1,
        price: 0,
        specMain: "å«æ‹†è£ã€èª¿æ•´ã€æ¸¬è©¦",
        specMaterial: "1.Aã€Båº§å„2åª 2.å¹³é¢æµ®å‹•æ²¹å°x2åª 3.é‹¼ç’°è“‹ã€é‹¼ç’°ç‰‡å„4ç‰‡ 4.æ”ªæ‹Œè‡‚èºçµ²x8çµ„",
        remarks: "",
        type: "main",
        subItems: []
      },
      {
        name: "æ›´æ› 3mÂ³ æ‹Œåˆæ©Ÿã€éæ¸›é€Ÿæ©Ÿå´ã€‘æ¼æ¼¿ï¼ˆå«å·¥è³‡åŠææ–™ï¼‰",
        unit: "å¼",
        qty: 1,
        price: 0,
        specMain: "å«æ‹†è£ã€èª¿æ•´ã€æ¸¬è©¦",
        specMaterial: "1.Aã€Båº§å„2åª 2.å¹³é¢æµ®å‹•æ²¹å°x2åª 3.é‹¼ç’°è“‹ã€é‹¼ç’°ç‰‡å„4ç‰‡ 4.æ”ªæ‹Œè‡‚èºçµ²x8çµ„",
        remarks: "",
        type: "main",
        subItems: []
      }
    ],

    // 2. å¯¦æ”¯å¯¦ä»˜é›¶ä»¶ (å·²åŒ…å«ä¸‹æ‹‰é¸å–®åˆ‡æ›å°è£½/å¾·è£½)
    defaultLeakageParts: [
      { 
        name: "è¯è»¸å™¨", 
        spec: "å°ç£è£½é€ ", 
        unit: "çµ„", 
        price: 30000,
        variants: [
          { label: "å°è£½ (å°ç£è£½é€ )", spec: "å°ç£è£½é€ ", price: 30000 },
          { label: "å¾·è£½ (å¾·åœ‹åŸè£)", spec: "å¾·åœ‹åŸè£", price: 58000 }
        ]
      },
      { 
        name: "è¯è»¸å™¨æ©¡è† å¢Šåœˆ", 
        spec: "å°ç£è£½é€ ", 
        unit: "åª", 
        price: 2000,
        variants: [
          { label: "å°è£½ (å°ç£è£½é€ )", spec: "å°ç£è£½é€ ", price: 2000 },
          { label: "å¾·è£½ (å¾·åœ‹åŸè£)", spec: "å¾·åœ‹åŸè£", price: 9500 }
        ]
      },
      { name: "æ¸›é€Ÿæ©Ÿé¬†ç·Šå™¨", spec: "çµæ¥èºæ “åŠæ’éŠ·", unit: "å¼", price: 5000 },
      { name: "æ¸›é€Ÿæ©Ÿæ”¯æ’èª¿æ•´å™¨", spec: "åŠçœ¼èºçµ²", unit: "å¼", price: 3150 },
      { name: "æ²¹å°", spec: "TC 140x180x14", unit: "åª", price: 350 },
      { name: "è»¸æ‰¿", spec: "å‹è™Ÿï¼š23124", unit: "åª", price: 8000 },
      { name: "ä¸»è»¸å¥—ç­’", spec: "120x140x120", unit: "å¼", price: 2600 },
      { name: "éµæ§½çµ„", spec: "å¹³éµ 32x18x315L åŠæ–œéµ 10x7x50", unit: "å¼", price: 1800 },
      { name: "Oå‹ç’°", spec: "3x120x126", unit: "åª", price: 200 },
      { name: "å‡æ—¥æ–½å·¥åŠ åƒ¹", spec: "éå·¥ä½œæ—¥å‡ºå‹¤è²»ç”¨", unit: "å¼", price: 15000 },
    ],

    referenceItems: [],
    
    // 3. å‚™è¨» (å·²åŠ å…¥ç¬¬7é»å‡æ—¥æ–½å·¥èªªæ˜)
    defaultNotes: DEFAULT_NOTES + "\n7. æœ¬å ±åƒ¹ç‚ºå¹³æ—¥æ–½å·¥è²»ç”¨ï¼Œå¦‚éœ€å‡æ—¥æ–½å·¥å‰‡éœ€å¦å¤–åŠ åƒ¹(åƒè€ƒå¯¦æ”¯å¯¦ä»˜æ˜ç´°è¡¨)",
    
    // 4. ä»˜æ¬¾æ¢ä»¶ (å·²æ”¹æˆå®Œå·¥å¾Œ 100%)
    defaultPayment: "å®Œå·¥å¾Œæ”¯ä»˜ 100%"
  },
  
  // (åŸæœ¬çš„ modeB è¨­å‚™éŠ·å”®å·²åˆªé™¤)

  {
    id: "modeC",
    name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
    description: "é©ç”¨æ•´æ©Ÿæ›´æ–°ã€å–®æ©ŸéŠ·å”®èˆ‡å®‰è£ã€æ–™ä»¶æ›´æ›å·¥ç¨‹ã€‚", // æè¿°ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ï¼Œæ¶µè“‹ç¯„åœæ›´å»£
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  }
];
/***********************************************************
  * P2 â€” å·¥å…·å‡½å¼
 ***********************************************************/
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatDate(dateStr = new Date()) {
    const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
}

function formatMoney(num) {
    if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "0"; 
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
    const qty = Number(item.qty || 0);
    const price = Number(item.price || 0);
    return qty * price;
}

function calcTotal(items) {
    return items.reduce((sum, it) => {
        if (it.type === "reference") return sum;

        let mainAmt = calcAmount(it);
        let subs = 0;

        if (it.subItems && it.subItems.length > 0) {
            subs = it.subItems.reduce(
                (s, sub) => (sub.type === "item" ? s + calcAmount(sub) : s),
                0
            );
        }

        return sum + mainAmt + subs;
    }, 0);
}

function calcNegotiated(total, discountPercent, customPrice) {
    const cp = Number(customPrice || 0);
    const dp = Number(discountPercent || 0);
    
    if (cp > 0) return cp;
    
    if (dp > 0 && dp <= 100) {
        return Math.round(total * (1 - dp / 100));
    }
    
    return total;
}

function generateQuoteNo(companyKey = "sinchang") {
  const prefix = COMPANY_DATA[companyKey]?.prefix || "QS";

  const d = new Date();
  const yy = String(d.getFullYear()).slice(-2);
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");

  const dateKey = `${yy}${mm}${dd}`;
  const storageKey = `quote_seq_${companyKey}_${dateKey}`;

  let seq = Number(localStorage.getItem(storageKey) || "0") + 1;

  if (seq > 99) {
    alert("ä»Šæ—¥å ±åƒ¹å–®å·²è¶…é 99 å¼µï¼Œè«‹ç¢ºèª");
    seq = 99;
  }

  localStorage.setItem(storageKey, seq);

  const nn = String(seq).padStart(2, "0");
  return `${prefix}${dateKey}${nn}`;
}


// ========================================================
// å·¥å…·å‡½å¼ï¼šè¼‰å…¥ CSV æª”æ¡ˆ (ä¿®æ­£ä¸­æ–‡äº‚ç¢¼å•é¡Œ)
// ========================================================
function loadCSV(url) {
  return new Promise((resolve, reject) => {
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        // â­ é—œéµä¿®æ­£ 1: è«‹æ±‚æ™‚ï¼ŒæŒ‡å®šè®€å–ç‚º ArrayBuffer (åŸå§‹äºŒé€²åˆ¶)
        return response.arrayBuffer(); 
      })
      .then(arrayBuffer => {
        // â­ é—œéµä¿®æ­£ 2: ä½¿ç”¨ TextDecoder è™•ç† UTF-8 ç·¨ç¢¼
        // å°‡ ArrayBuffer è½‰æ›ç‚ºæ–‡å­—ï¼Œç¢ºä¿ä½¿ç”¨ UTF-8 ç·¨ç¢¼è§£æ
        const decoder = new TextDecoder('utf-8');
        const csvText = decoder.decode(arrayBuffer);

        // ä½¿ç”¨ XLSX.read è™•ç† CSV å…§å®¹
        // ç”±æ–¼æˆ‘å€‘å·²ç¶“è™•ç†äº†ç·¨ç¢¼ï¼Œé€™è£¡å¯ä»¥å°‡é¡å‹è¨­ç‚º 'binary' æˆ– 'text' è®“å®ƒè§£æ
        const workbook = XLSX.read(csvText, { type: 'string' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        
        // å°‡ Sheet è½‰æ›ç‚º JSON é™£åˆ— (åŒ…å«æ¨™é¡Œåˆ—)
        const data = XLSX.utils.sheet_to_json(sheet); 
        resolve(data);
      })
      .catch(error => {
        console.error("Error loading CSV and fixing encoding:", error);
        alert(`è¼‰å…¥è³‡æ–™å¤±æ•—ã€‚è«‹æª¢æŸ¥ Google Sheet ç¶²å€åŠç™¼å¸ƒæ¬Šé™ã€‚éŒ¯èª¤: ${error.message}`);
        reject(error);
      });
  });
}
/***********************************************************
 * P3 â€” AppContextï¼ˆè³‡æ–™ä¸­å¿ƒï¼‰
 ***********************************************************/
const AppContext = React.createContext();
// ========================================================
// â­ å…¨å±€è¨­å®šï¼šå®¢æˆ¶è³‡æ–™ CSV ç¶²å€ (æ­¤è™•ä¿æŒä¸è®Š) â­
// ========================================================
const CUSTOMER_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?gid=312161947&single=true&output=csv";
// è¦æ ¼ CSV ç¶²å€
const SPEC_CSV_URL = "https://docs.google.com/spreadsheets/d/1wjoNesgvgmkVoG4bI9ppl_1EktH88WZ6bxT9IeyX4YM/export?format=csv";


function AppProvider({ children }) {
  const [company, setCompany] = React.useState("herhsin");
  const [quotes, setQuotes] = React.useState([]);
  const [activeQuoteId, setActiveQuoteId] = React.useState(null);
  const [specItems, setSpecItems] = React.useState([]);
  // â­ 1. æ–°å¢ï¼šå®¢æˆ¶è³‡æ–™ç‹€æ…‹
  const [customers, setCustomers] = React.useState([]); 

  // è¼‰å…¥è¦æ ¼ (ä¿æŒä¸è®Š)
  const loadSpecItems = React.useCallback(() => {
    loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
  }, []);

  // â­ 2. æ–°å¢ï¼šè¼‰å…¥å®¢æˆ¶è³‡æ–™çš„å‡½å¼
  const loadCustomers = React.useCallback(() => {
    if (CUSTOMER_CSV_URL && CUSTOMER_CSV_URL.includes("http")) {
        loadCSV(CUSTOMER_CSV_URL).then(data => {
            console.log("Customer data loaded successfully. Count:", data.length);
            setCustomers(data);
        }).catch(error => {
            console.error("Failed to load customer data:", error);
            setCustomers([]);
        });
    }
  }, []); 

  /* ========================================================
    1. å»ºç«‹æ–°å ±åƒ¹å–® (createQuote) - ä¿æŒä¸è®Š
    ======================================================== */
  const createQuote = React.useCallback((modeId) => {
    const mode = QUOTE_MODES.find(m => m.id === modeId);
    
    // 1. è™•ç†ä¸»é …ç›® (çµ¦äºˆå…¨æ–° ID)
    const defaultItems = mode 
      ? JSON.parse(JSON.stringify(mode.defaultItems)).map(item => ({
          ...item,
          id: uuid() 
        }))
      : [];

    // 2. è™•ç†å¯¦æ”¯å¯¦ä»˜é›¶ä»¶ (å¦‚æœæœ‰è¨­å®šçš„è©±) 
    const defaultLeakageParts = (mode && mode.defaultLeakageParts)
      ? JSON.parse(JSON.stringify(mode.defaultLeakageParts)).map(part => ({
          ...part,
          id: uuid() // ä¸€æ¨£çµ¦äºˆå…¨æ–° ID
        }))
      : [];

    const newQuote = {
        id: uuid(),
        company: company,
        quoteNo: generateQuoteNo(company),
        title: "",
        customerName: "",
        contact: "",
        phone: "",
        location: "",
        date: formatDate(),
        items: defaultItems,
        leakageParts: defaultLeakageParts, 
        notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
        payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
        discountPercent: 0,
        negotiatedPrice: 0
    };

    setQuotes(prev => [newQuote, ...prev]);
    setActiveQuoteId(newQuote.id);
  }, [company]);

  /* ========================================================
    2. åˆªé™¤å ±åƒ¹å–® (deleteQuote) - ä¿æŒä¸è®Š
    ======================================================== */
  const deleteQuote = React.useCallback((id) => {
    setQuotes(prev => prev.filter(q => q.id !== id));
    if (activeQuoteId === id) setActiveQuoteId(null);
  }, [activeQuoteId]);

  /* ========================================================
    æ–°å¢åŠŸèƒ½ï¼šè¤‡è£½å ±åƒ¹å–® (duplicateQuote) - ä¿æŒä¸è®Š
    ======================================================== */
  const duplicateQuote = React.useCallback((id) => {
    const sourceQuote = quotes.find(q => q.id === id);
    if (!sourceQuote) return;

    const newQuote = {
      ...JSON.parse(JSON.stringify(sourceQuote)), 
      id: uuid(), 
      quoteNo: generateQuoteNo(sourceQuote.company), 
      title: `${sourceQuote.title} (å‰¯æœ¬)`, 
      date: formatDate(), 
      items: sourceQuote.items.map(item => ({ ...item, id: uuid() })),
      leakageParts: (sourceQuote.leakageParts || []).map(part => ({ ...part, id: uuid() }))
    };

    setQuotes(prev => [newQuote, ...prev]);
    setActiveQuoteId(newQuote.id);
  }, [quotes]);

  /* ========================================================
    3. æ›´æ–°å ±åƒ¹å–® (updateQuote) - ä¿æŒä¸è®Š
    ======================================================== */
  const updateQuote = React.useCallback((id, data) => {
    setQuotes(prev => prev.map(q => q.id === id ? { ...q, ...data } : q));
  }, []);

  /* ========================================================
    4. å¥—ç”¨æ¨¡å¼ (applyMode) - ä¿æŒä¸è®Š
    ======================================================== */
  const applyMode = React.useCallback((modeId) => {
    if (!activeQuoteId) return;
    const mode = QUOTE_MODES.find(m => m.id === modeId);
    if (!mode) return;

    if (!window.confirm("ç¢ºå®šè¦è¦†è“‹ç•¶å‰å ±åƒ¹å–®å…§å®¹å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;

    // ä¸»é …ç›®
    const newItems = JSON.parse(JSON.stringify(mode.defaultItems)).map(item => ({
        ...item,
        id: uuid() 
    }));
    
    // å¥—ç”¨é›¶ä»¶
    const newLeakageParts = (mode.defaultLeakageParts)
      ? JSON.parse(JSON.stringify(mode.defaultLeakageParts)).map(part => ({
          ...part,
          id: uuid()
        }))
      : [];

    updateQuote(activeQuoteId, {
        items: newItems,
        leakageParts: newLeakageParts,
        notes: mode.defaultNotes,
        payment: mode.defaultPayment
    });
  }, [activeQuoteId, updateQuote]);

  // è¼‰å…¥ localStorage (ä¿æŒä¸è®Š)
  React.useEffect(() => {
    const saved = localStorage.getItem("HERHSIN_QUOTES");
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (Array.isArray(parsed)) {
          setQuotes(parsed);
          if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
        }
      } catch (e) {
        setQuotes([]);
        setActiveQuoteId(null);
      }
    }
  }, []);

  // å„²å­˜åˆ° localStorage (ä¿æŒä¸è®Š)
  React.useEffect(() => {
    localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
  }, [quotes]);

  // â­ 3. æ–°å¢ï¼šå•Ÿå‹•æ™‚è¼‰å…¥è¦æ ¼å’Œå®¢æˆ¶è³‡æ–™
  React.useEffect(() => {
    loadSpecItems();
    loadCustomers(); 
  }, [loadSpecItems, loadCustomers]); // åŠ å…¥ loadCustomers ä¾è³´

  const activeQuote = quotes.find(q => q.id === activeQuoteId);

  // 4. åŒ¯å‡ºä¸Šä¸‹æ–‡å€¼
  const value = {
    company,
    setCompany,
    quotes,
    setQuotes,
    activeQuote,
    activeQuoteId,
    setActiveQuoteId,
    specItems,
    customers, // â­ å¿…é ˆå°‡ customers å‚³éå‡ºå»
    loadSpecItems,
    createQuote,
    deleteQuote,
    updateQuote,
    applyMode,
    duplicateQuote
  };

  window.__APP_CONTEXT__ = value;

  return (
    <AppContext.Provider value={value}>
      {children}
    </AppContext.Provider>
  );
}

/***********************************************************
 * P4-1 â€” å…¬å¸åˆ‡æ› / æ¨¡å¼é¸æ“‡ / å ±åƒ¹å–®åˆ—è¡¨
 ***********************************************************/
function CompanySelector() {
  const { company, setCompany, activeQuote, updateQuote } = React.useContext(AppContext);

  const handleSetCompany = (newCompany) => {
    setCompany(newCompany);
    if (activeQuote) {
      updateQuote(activeQuote.id, {
        company: newCompany,
        quoteNo: generateQuoteNo(newCompany)
      });
    }
  };

  return (
    <div className="mb-8 no-print">
      <div className="text-base font-semibold text-gray-700 mb-3">
        é¸æ“‡å…¬å¸
      </div>

      <div className="flex gap-3">
        <button
          className={`flex-1 px-4 py-2 text-base rounded-md transition ${
            company === "herhsin"
              ? "bg-blue-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => handleSetCompany("herhsin")}
        >
          ä½•é‘«å¯¦æ¥­
        </button>

        <button
          className={`flex-1 px-4 py-2 text-base rounded-md transition ${
            company === "sinchang"
              ? "bg-blue-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => handleSetCompany("sinchang")}
        >
          è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸
        </button>
      </div>
    </div>
  );
}

function ModeSelector() {
  const { createQuote, applyMode } = React.useContext(AppContext);

  const [selectedMode, setSelectedMode] = React.useState("");
  const [isNew, setIsNew] = React.useState(true);

  const handleApply = () => {
    if (!selectedMode) return;
    isNew ? createQuote(selectedMode) : applyMode(selectedMode);
    setSelectedMode("");
  };

  return (
    <div className="mb-8 pb-6 border-b border-gray-300 no-print">
      <div className="text-base font-semibold text-gray-700 mb-3">
        æ¨¡å¼å¥—ç”¨ï¼ˆ{isNew ? "æ–°å»º" : "è¦†è“‹"}ï¼‰
      </div>

      <div className="flex gap-3 mb-4">
        <button
          className={`flex-1 px-4 py-2 text-base rounded-md ${
            isNew
              ? "bg-green-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => setIsNew(true)}
        >
          æ–°å»ºå ±åƒ¹å–®
        </button>

        <button
          className={`flex-1 px-4 py-2 text-base rounded-md ${
            !isNew
              ? "bg-orange-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => setIsNew(false)}
        >
          å¥—ç”¨è‡³ç•¶å‰
        </button>
      </div>

      <select
        className="w-full border px-3 py-2 mb-4 rounded-md text-base"
        value={selectedMode}
        onChange={e => setSelectedMode(e.target.value)}
      >
        <option value="" disabled>è«‹é¸æ“‡å ±åƒ¹æ¨¡å¼</option>
        {QUOTE_MODES.map(mode => (
          <option key={mode.id} value={mode.id}>
            {mode.name} â€” {mode.description}
          </option>
        ))}
      </select>

      <button
        className="w-full bg-blue-600 text-white py-2.5 rounded-md text-base hover:bg-blue-700 disabled:opacity-50"
        onClick={handleApply}
        disabled={!selectedMode}
      >
        {isNew ? "æ–°å»ºå ±åƒ¹å–®ä¸¦å¥—ç”¨æ¨¡å¼" : "å¥—ç”¨æ¨¡å¼è‡³ç•¶å‰å ±åƒ¹å–®"}
      </button>
    </div>
  );
}

/* ========================================================
   çµ„ä»¶ï¼šå ±åƒ¹å–®åˆ—è¡¨ (QuoteList) â€” å‡ç´šç‰ˆ
   åŠŸèƒ½ï¼šé¡¯ç¤ºåˆ—è¡¨ã€æ”¯æ´åˆ‡æ›ã€åˆªé™¤ã€è¤‡è£½
   ======================================================== */
function QuoteList({ quotes, activeId, selectQuote, deleteQuote, duplicateQuote }) {
  // 1. å¦‚æœæ²’æœ‰å–®æ“šï¼Œé¡¯ç¤ºæç¤º
  if (!quotes || quotes.length === 0) {
    return (
        <div className="text-gray-400 text-sm text-center mt-10 p-4 border-2 border-dashed border-gray-200 rounded-lg">
            å°šç„¡å ±åƒ¹å–®<br/>è«‹ç”±ä¸Šæ–¹é¸æ“‡æ¨¡å¼æ–°å¢
        </div>
    );
  }

  return (
    <div className="space-y-3 pb-20"> {/* pb-20 æ˜¯ç‚ºäº†é¿å…è¢«åº•éƒ¨æ“‹ä½ */}
      {quotes.map((quote) => (
        <div
          key={quote.id}
          onClick={() => selectQuote(quote.id)}
          className={`p-4 rounded-lg cursor-pointer border transition-all relative group ${
            quote.id === activeId
              ? "bg-blue-50 border-blue-500 shadow-md ring-1 ring-blue-500"
              : "bg-white border-gray-200 hover:border-blue-300 hover:shadow-sm"
          }`}
        >
          {/* ä¸Šæ’ï¼šå…¬å¸æ¨™ç±¤ + å–®è™Ÿ */}
          <div className="flex justify-between items-center mb-2">
            <div className="flex items-center gap-2">
               {/* å…¬å¸æ¨™ç±¤ï¼šæ ¹æ“šå…¬å¸ä»£è™Ÿè®Šè‰² */}
               <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded text-white ${
                   quote.company === 'herhsin' ? 'bg-blue-600' : 'bg-green-600'
               }`}>
                 {quote.company === 'herhsin' ? 'ä½•é‘«' : 'è–ªæ˜Œ'}
               </span>
               <span className="text-xs text-gray-400 font-mono">
                 {quote.quoteNo}
               </span>
            </div>
          </div>

          {/* ä¸­æ’ï¼šæ¨™é¡Œ */}
          <div className="font-bold text-gray-800 mb-1 text-sm truncate pr-4">
            {quote.title || "ï¼ˆæœªå‘½åå·¥ç¨‹ï¼‰"}
          </div>

          {/* ä¸‹æ’ï¼šå®¢æˆ¶ + æ—¥æœŸ */}
          <div className="text-xs text-gray-500 flex justify-between items-center mt-2 border-t pt-2 border-gray-100">
             <span className="truncate max-w-[60%]">{quote.customerName || "æœªçŸ¥å®¢æˆ¶"}</span>
             <span>{quote.date}</span>
          </div>

          {/* â–¼â–¼â–¼ æ‡¸æµ®æŒ‰éˆ•å€ (æ»‘é¼ ç§»éå»æ‰æœƒå‡ºç¾) â–¼â–¼â–¼ */}
          <div className="absolute top-2 right-2 hidden group-hover:flex gap-1">
             {/* ğŸ“‹ è¤‡è£½æŒ‰éˆ• */}
             <button
                onClick={(e) => {
                  e.stopPropagation(); // é˜»æ­¢é»æ“Šè§¸ç™¼ã€Œé¸å–å ±åƒ¹å–®ã€
                  duplicateQuote(quote.id);
                }}
                className="p-1.5 bg-white text-gray-500 border border-gray-200 rounded hover:bg-blue-50 hover:text-blue-600 hover:border-blue-400 shadow-sm transition-colors"
                title="è¤‡è£½æ­¤å ±åƒ¹å–® (å»ºç«‹å‰¯æœ¬)"
             >
                ğŸ“‹
             </button>

             {/* âœ• åˆªé™¤æŒ‰éˆ• */}
             <button
                onClick={(e) => {
                  e.stopPropagation();
                  if(window.confirm(`ç¢ºå®šè¦åˆªé™¤å–®è™Ÿ ${quote.quoteNo} å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) {
                      deleteQuote(quote.id);
                  }
                }}
                className="p-1.5 bg-white text-gray-400 border border-gray-200 rounded hover:bg-red-50 hover:text-red-600 hover:border-red-400 shadow-sm transition-colors"
                title="åˆªé™¤"
             >
                âœ•
             </button>
          </div>

        </div>
      ))}
    </div>
  );
}

/***********************************************************
 * P4-2 â€” å–®ä¸€å ±åƒ¹é …ç›®ç·¨è¼¯ï¼ˆç·Šæ¹Šå„ªåŒ–ç‰ˆï¼‰
 ***********************************************************/
function QuoteItem({ item, index, updateItem, deleteItem }) {
  const { specItems } = React.useContext(AppContext);

  /* --- é‚è¼¯ä¿æŒä¸è®Š --- */
  const handleChange = (field, value) => {
    updateItem({ [field]: value });
  };

  const handleAddSubText = () => {
    const newSub = {
      id: uuid(),
      type: "text",
      name: "",
      remarks: ""
    };
    updateItem({ subItems: [...(item.subItems || []), newSub] });
  };

  const handleAddSubImage = (file) => {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const newSub = {
        id: uuid(),
        type: "image",
        name: "",
        imageData: reader.result
      };
      updateItem({ subItems: [...(item.subItems || []), newSub] });
    };
    reader.readAsDataURL(file);
  };

  const handleDeleteSub = (subId) => {
    const newSubItems = item.subItems.filter(s => s.id !== subId);
    updateItem({ subItems: newSubItems });
  };

  const handleUpdateSub = (subId, field, value) => {
    const newSubItems = item.subItems.map(s => 
      s.id === subId ? { ...s, [field]: value } : s
    );
    updateItem({ subItems: newSubItems });
  };

  return (
    <div className="mb-3 border rounded-lg bg-white shadow-sm overflow-hidden text-sm">
      
      {/* ===== ç¬¬ä¸€å€ï¼šæ ¸å¿ƒè¼¸å…¥ (é è¨­é¡¯ç¤º) ===== */}
      <div className="p-3 grid grid-cols-12 gap-3 items-start">
        
        {/* 1. é …æ¬¡èˆ‡åˆªé™¤ */}
        <div className="col-span-12 flex justify-between items-center border-b pb-2 mb-1">
          <div className="font-bold text-blue-700 text-base">
            é …æ¬¡ {index + 1}
          </div>
          <button
            onClick={() => deleteItem(item.id)}
            className="text-red-500 hover:text-red-700 px-2 py-1 text-xs border border-red-200 rounded hover:bg-red-50 transition"
          >
            ğŸ—‘ åˆªé™¤æ­¤é …
          </button>
        </div>

        {/* 2. å“å */}
        <div className="col-span-12 md:col-span-4">
          <label className="block text-xs text-gray-500 mb-1">å“å</label>
          <input
            type="text"
            list={`spec-list-${item.id}`}
            className="w-full border rounded px-2 py-1.5 focus:ring-2 focus:ring-blue-300 outline-none"
            placeholder="è¼¸å…¥æˆ–é¸æ“‡å“å..."
            value={item.name || ""}
            onChange={(e) => handleChange("name", e.target.value)}
            onBlur={(e) => {
              const value = e.target.value;
              const matched = specItems.find(r => (r["å“å"] || "") === value);
              if (!matched) return;

              const materials = [matched["ç”¨æ–™1"], matched["ç”¨æ–™2"], matched["ç”¨æ–™3"]]
                .filter(v => typeof v === "string" && v.trim() !== "")
                .join("ã€");

              updateItem({
                name: matched["å“å"] || "",
                unit: matched["å–®ä½"] || "",
                price: matched["å–®åƒ¹"] || 0, // é€™è£¡ä¿æŒæ•¸å€¼æˆ–æ˜¯å­—ä¸²éƒ½è¡Œ
                specMain: matched["è¦æ ¼"] || "",  
                specMaterial: materials             
              });
            }}
          />
          <datalist id={`spec-list-${item.id}`}>
            {specItems.map((r, i) => (
              <option key={i} value={r["å“å"] || ""}>
                {r["è¦æ ¼"] ? `(${r["è¦æ ¼"]})` : ""}
              </option>
            ))}
          </datalist>
        </div>

        {/* 3. è¦æ ¼èªªæ˜ */}
        <div className="col-span-12 md:col-span-8">
          <label className="block text-xs text-gray-500 mb-1">è¦æ ¼èªªæ˜</label>
          <input
            type="text"
            className="w-full border rounded px-2 py-1.5 focus:ring-2 focus:ring-blue-300 outline-none"
            value={item.specMain || ""}
            onChange={(e) => handleChange("specMain", e.target.value)}
          />
        </div>

        {/* 4. å–®ä½ */}
        <div className="col-span-3 md:col-span-1">
          <label className="block text-xs text-gray-500 mb-1">å–®ä½</label>
          <input
            type="text"
            className="w-full border rounded px-2 py-1.5 text-center outline-none"
            value={item.unit || ""}
            onChange={(e) => handleChange("unit", e.target.value)}
          />
        </div>

        {/* 5. æ•¸é‡ (ä¿®æ­£ï¼šç§»é™¤ Number() å¼·åˆ¶è½‰å‹) */}
        <div className="col-span-3 md:col-span-1">
          <label className="block text-xs text-gray-500 mb-1">æ•¸é‡</label>
          <input
            type="number"
            className="w-full border rounded px-2 py-1.5 text-center outline-none"
            value={item.qty}
            // â¬‡ï¸ ä¿®æ­£é»ï¼šç›´æ¥å‚³å…¥ e.target.valueï¼Œè®“ä½¿ç”¨è€…å¯ä»¥åˆªé™¤æˆç©ºç™½é‡æ–°è¼¸å…¥
            onChange={(e) => handleChange("qty", e.target.value)}
          />
        </div>

        {/* 6. å–®åƒ¹ (ä¿®æ­£ï¼šç§»é™¤ Number() å¼·åˆ¶è½‰å‹) */}
        <div className="col-span-6 md:col-span-2">
          <label className="block text-xs text-gray-500 mb-1">å–®åƒ¹</label>
          <input
            type="number"
            className="w-full border rounded px-2 py-1.5 text-right outline-none"
            value={item.price}
            // â¬‡ï¸ ä¿®æ­£é»ï¼šç›´æ¥å‚³å…¥ e.target.value
            onChange={(e) => handleChange("price", e.target.value)}
          />
        </div>

        {/* 7. å°è¨ˆ (ç´”é¡¯ç¤º) */}
        <div className="col-span-6 md:col-span-2">
          <label className="block text-xs text-gray-500 mb-1">å°è¨ˆ</label>
          <div className="w-full bg-gray-100 rounded px-2 py-1.5 text-right text-gray-700 font-medium">
             {/* é€™è£¡åŠ å› Number() ç¢ºä¿é‹ç®—æ­£ç¢º */}
             {(Number(item.qty || 0) * Number(item.price || 0)).toLocaleString()}
          </div>
        </div>

        {/* 8. å“ç‰Œ/ç”¢åœ° (Variants) */}
        {Array.isArray(item.variants) && item.variants.length > 0 && (
           <div className="col-span-12 md:col-span-6">
             <label className="block text-xs text-gray-500 mb-1">å“ç‰Œé¸é …</label>
             <select
               className="w-full border rounded px-2 py-1.5"
               value={item.selected}
               onChange={(e) => {
                 const selectedKey = e.target.value;
                 const variant = item.variants.find(v => v.key === selectedKey);
                 updateItem({
                   selected: selectedKey,
                   price: variant ? variant.defaultPrice : item.price
                 });
               }}
             >
               {item.variants.map(v => (
                 <option key={v.key} value={v.key}>{v.label}</option>
               ))}
             </select>
           </div>
        )}

      </div>

      {/* ===== ç¬¬äºŒå€ï¼šé€²éšè¼¸å…¥ (æ‘ºç–Šå€) ===== */}
      <details className="group border-t border-gray-100 bg-gray-50">
        <summary className="cursor-pointer list-none p-2 text-center text-xs text-blue-600 hover:bg-blue-50 font-medium select-none flex items-center justify-center gap-2 transition-colors">
          <span>ğŸ“ ç·¨è¼¯ç”¨æ–™æ˜ç´° / å‚™è¨» / è£œå……åœ–ç‰‡èˆ‡æ–‡å­— ({item.subItems?.length || 0})</span>
          <span className="group-open:rotate-180 transition-transform duration-200">â–¼</span>
        </summary>
        
        <div className="p-4 grid grid-cols-1 gap-4 animate-fade-in">
          
          {/* ç”¨æ–™æ˜ç´° & å‚™è¨» */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-xs text-gray-500 mb-1">ç”¨æ–™æ˜ç´° (åˆ—å°æ™‚é¡¯ç¤º)</label>
              <textarea
                className="w-full border rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-300 outline-none"
                rows="3"
                value={item.specMaterial || ""}
                onChange={(e) => handleChange("specMaterial", e.target.value)}
                placeholder="è¼¸å…¥è©³ç´°ç”¨æ–™..."
              />
            </div>
            <div>
              <label className="block text-xs text-gray-500 mb-1">å‚™è¨»</label>
              <textarea
                className="w-full border rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-300 outline-none"
                rows="3"
                value={item.remarks || ""}
                onChange={(e) => handleChange("remarks", e.target.value)}
                placeholder="è¼¸å…¥å…§éƒ¨å‚™è¨»..."
              />
            </div>
          </div>

          {/* å­é …ç›®åˆ—è¡¨ */}
          {(item.subItems || []).length > 0 && (
            <div className="space-y-2 mt-2">
              <div className="text-xs font-bold text-gray-400">è£œå……é …ç›®åˆ—è¡¨ï¼š</div>
              {(item.subItems || []).map((sub, idx) => (
                <div key={sub.id} className="border p-2 rounded bg-white flex gap-3 items-start shadow-sm">
                  <div className="text-xs text-gray-400 mt-1">{idx + 1}.</div>
                  
                  {sub.type === "image" && (
                    <div className="flex-1">
                      <div className="text-xs text-blue-600 font-bold mb-1">åœ–ç‰‡</div>
                      <img src={sub.imageData} alt="upload" className="h-20 w-auto rounded border object-contain" />
                    </div>
                  )}

                  {sub.type === "text" && (
                    <div className="flex-1 space-y-1">
                      <div className="text-xs text-blue-600 font-bold">æ–‡å­—èªªæ˜</div>
                      <input 
                        type="text" 
                        placeholder="æ¨™é¡Œ..."
                        className="w-full border p-1 text-sm rounded"
                        value={sub.name}
                        onChange={e => handleUpdateSub(sub.id, "name", e.target.value)}
                      />
                      <textarea 
                        placeholder="å…§å®¹..."
                        className="w-full border p-1 text-sm rounded"
                        rows="1"
                        value={sub.remarks}
                        onChange={e => handleUpdateSub(sub.id, "remarks", e.target.value)}
                      />
                    </div>
                  )}

                  <button 
                    className="text-red-400 hover:text-red-600 text-sm px-2"
                    onClick={() => handleDeleteSub(sub.id)}
                  >
                    Ã—
                  </button>
                </div>
              ))}
            </div>
          )}

          {/* æŒ‰éˆ•å€ */}
          <div className="flex gap-3 pt-2">
            <button
              className="flex-1 py-2 bg-white border border-gray-300 rounded text-sm hover:bg-gray-50 transition shadow-sm text-gray-700"
              onClick={handleAddSubText}
            >
              ï¼‹ è£œå……æ–‡å­—
            </button>

            <label className="flex-1 py-2 bg-white border border-gray-300 rounded text-sm hover:bg-gray-50 transition shadow-sm text-gray-700 cursor-pointer text-center">
              ï¼‹ è£œå……åœ–ç‰‡
              <input
                type="file"
                accept="image/*"
                className="hidden"
                onChange={(e) => {
                  handleAddSubImage(e.target.files[0]);
                  e.target.value = '';
                }}
              />
            </label>
          </div>

        </div>
      </details>
    </div>
  );
}
// ========================================================
// å®¢æˆ¶åç¨±æœå°‹å…ƒä»¶ (å–ä»£ datalist)
// ========================================================
function CustomerSearchInput({ value, onChange, onSelect }) {
  const { customers } = React.useContext(AppContext); // å¾ Context è®€å–å®¢æˆ¶è³‡æ–™
  const [searchTerm, setSearchTerm] = React.useState(value);
  const [showSuggestions, setShowSuggestions] = React.useState(false);
  const wrapperRef = React.useRef(null);

  // ç•¶ QuoteEditor å‚³å…¥çš„ value æ”¹è®Šæ™‚ï¼Œæ›´æ–° searchTerm (é€šå¸¸æ˜¯è¼‰å…¥æ–°å ±åƒ¹å–®æ™‚)
  React.useEffect(() => {
    setSearchTerm(value);
  }, [value]);

  // é»æ“Šå¤–éƒ¨æ™‚éš±è—å»ºè­°æ¸…å–®
  React.useEffect(() => {
    function handleClickOutside(event) {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setShowSuggestions(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [wrapperRef]);
  
  // ç¯©é¸å®¢æˆ¶åˆ—è¡¨çš„é‚è¼¯ (åªè¦è¼¸å…¥ä¸€å€‹å­—å…ƒå°±é–‹å§‹ç¯©é¸)
  const filteredCustomers = React.useMemo(() => {
    if (!searchTerm || searchTerm.trim().length === 0) return [];
    
    const lowerCaseSearch = searchTerm.trim().toLowerCase();
    
    // é—œéµï¼šç¯©é¸é‚è¼¯ï¼Œåªè¦ã€Œå®¢æˆ¶åç¨±ã€åŒ…å«é—œéµå­—å°±é¡¯ç¤º
    return (customers || [])
        .filter(c => c["å®¢æˆ¶åç¨±"]?.toLowerCase().includes(lowerCaseSearch))
        .slice(0, 10); // åªé¡¯ç¤ºå‰ 10 ç­†
  }, [customers, searchTerm]);

  const handleInputChange = (e) => {
    const newValue = e.target.value;
    setSearchTerm(newValue); // æ›´æ–°æœå°‹ç‹€æ…‹ï¼Œè®“ filteredCustomers é‡æ–°è¨ˆç®—
    onChange(newValue); // æ›´æ–° QuoteEditor çš„ activeQuote
    setShowSuggestions(true); // é¡¯ç¤ºå»ºè­°æ¸…å–®
  };

  const handleSuggestionClick = (customer) => {
    onSelect(customer); // å‘¼å«çˆ¶å…ƒä»¶çš„é¸æ“‡è™•ç†é‚è¼¯ (å¸¶å…¥æ‰€æœ‰è³‡æ–™)
    setSearchTerm(customer["å®¢æˆ¶åç¨±"]); // ç¢ºä¿è¼¸å…¥æ¡†é¡¯ç¤ºå®Œæ•´åç¨±
    setShowSuggestions(false); // éš±è—æ¸…å–®
  };

  return (
    <div className="relative" ref={wrapperRef}>
      <input
        type="text"
        value={value} // é€™è£¡ä½¿ç”¨ valueï¼Œç¢ºä¿è¼¸å…¥æ¡†èˆ‡ QuoteEditor ç‹€æ…‹åŒæ­¥
        onChange={handleInputChange}
        onFocus={() => setShowSuggestions(true)}
        className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
        placeholder="è¼¸å…¥é—œéµå­—..."
        autoComplete="off" // é¿å…ç€è¦½å™¨å…§å»ºçš„è‡ªå‹•å¡«å……å¹²æ“¾
      />
      
      {/* æœå°‹å»ºè­°æ¸…å–®ï¼šåªæœ‰åœ¨ showSuggestions ä¸”æœ‰ç¯©é¸çµæœæ™‚æ‰é¡¯ç¤º */}
      {(showSuggestions && filteredCustomers.length > 0) && (
        <ul className="absolute z-10 w-full max-h-48 overflow-y-auto bg-white border border-gray-400 rounded mt-1 shadow-lg">
          {filteredCustomers.map((c, i) => (
            <li
              key={i}
              className="px-3 py-2 text-sm cursor-pointer hover:bg-blue-100 border-b border-gray-200"
              onClick={() => handleSuggestionClick(c)}
            >
              <span className="font-bold">{c["å®¢æˆ¶åç¨±"]}</span>
              {c["è¯çµ¡äºº"] && <span className="text-gray-500 ml-2 text-xs">({c["è¯çµ¡äºº"]})</span>}
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}
/***********************************************************
 * P4-3 â€” QuoteEditor / ExportButton / PrintButton / PrintLayout
 ***********************************************************/
// å ±åƒ¹å–®ç·¨è¼¯ä¸»å…ƒä»¶
function QuoteEditor() {
    // ä¿®æ­£ï¼šå¾ Context ä¸­è§£æ§‹å‡º customers
    const { activeQuote, updateQuote, customers } = React.useContext(AppContext);
    
    // æ–°å¢ï¼šé˜²å‘†æ©Ÿåˆ¶ã€‚å¦‚æœå®¢æˆ¶åˆ—è¡¨å°šæœªè¼‰å…¥ï¼Œå‰‡ä½¿ç”¨ç©ºé™£åˆ—ã€‚
    const customerList = customers || []; // é›–ç„¶åœ¨é€™å€‹å…ƒä»¶ä¸­æ²’è¢«ç›´æ¥ç”¨ï¼Œä½†ç•™è‘—æ˜¯å¥½ç¿’æ…£

    const componentRef = React.useRef(null);

    if (!activeQuote) {
        return (
            <div className="p-8 text-center text-gray-500 text-xl">
                è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹å ±åƒ¹å–®æˆ–æ–°å»ºä¸€å€‹å ±åƒ¹å–®ã€‚
            </div>
        );
    }
    
    const handleChange = (field, value) => {
        updateQuote(activeQuote.id, { [field]: value });
    };

    const handleUpdateItem = (itemId, data) => {
        const newItems = activeQuote.items.map(item => 
            item.id === itemId ? { ...item, ...data } : item
        );
        updateQuote(activeQuote.id, { items: newItems });
    };

    const handleDeleteItem = (itemId) => {
        const newItems = activeQuote.items.filter(item => item.id !== itemId);
        updateQuote(activeQuote.id, { items: newItems });
    };

    const handleAddItem = () => {
        const newItem = {
            id: uuid(),
            name: "", 
            specMain: "",
            unit: "å¼",
            qty: 1,
            price: 0,
            subItems: [],
            remarks: "",
            specMaterial: ""
        };
        updateQuote(activeQuote.id, { items: [...activeQuote.items, newItem] });
    };
    
    const totalAmount = calcTotal(activeQuote.items);
    
    const negotiatedAmount = calcNegotiated(
        totalAmount,
        activeQuote.discountPercent,
        activeQuote.negotiatedPrice
    );

    // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºæœ€çµ‚å ±åƒ¹ï¼ˆåªè¦æœ‰æŠ˜æ‰£ OR æœ‰è‡ªå®šç¾©åƒ¹æ ¼ï¼Œå°±é¡¯ç¤ºï¼‰
    const showFinalPrice = (activeQuote.discountPercent > 0) || (activeQuote.negotiatedPrice > 0);

    return (
    <div className="quote-editor-root-container text-lg">
        {/* ç·¨è¼¯å€ (æœ‰ .no-print) */}
        <div className="p-8 bg-gray-100 rounded-xl shadow-xl no-print">

            {/* ===== æ¨™é¡Œ ===== */}
            <h1 className="text-3xl font-bold mb-6 border-b pb-3">
                ç·¨è¼¯å ±åƒ¹å–®ï¼š{activeQuote.title || "æœªå‘½å"}
            </h1>

            {/* ===== å ±åƒ¹å–®åŸºæœ¬è³‡æ–™ï¼ˆè¡¨é ­å¡ - ç·Šæ¹Šç‰ˆï¼‰ ===== */}
            <div className="bg-white p-4 rounded-lg mb-6 border border-gray-300 shadow-sm text-sm">
                
                {/* ä½¿ç”¨ grid-cols-4 è®“ç©ºé–“åˆ©ç”¨æ›´æœ‰æ•ˆç‡ï¼Œgap ç¸®å°ç‚º 3 */}
                <div className="grid grid-cols-4 gap-3">

                    {/* ç¬¬ä¸€åˆ—ï¼šå–®è™Ÿ (ä½”1) + æ—¥æœŸ (ä½”1) + æ¨™é¡Œ (ä½”2) */}
                    <div className="col-span-1">
                        <label className="block text-xs font-bold text-gray-500 mb-1">å ±åƒ¹å–®ç·¨è™Ÿ</label>
                        <div className="font-mono font-bold text-blue-700 text-base leading-tight mt-1">
                            {activeQuote.quoteNo}
                        </div>
                    </div>

                    <div className="col-span-1">
                        <label className="block text-xs font-bold text-gray-500 mb-1">å ±åƒ¹æ—¥æœŸ</label>
                        <input
                            type="date"
                            value={activeQuote.date}
                            onChange={(e) => handleChange("date", e.target.value)}
                            className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                        />
                    </div>

                    <div className="col-span-2">
                        <label className="block text-xs font-bold text-gray-500 mb-1">å·¥ç¨‹åç¨± / æ¨™é¡Œ</label>
                        <input
                            type="text"
                            value={activeQuote.title}
                            onChange={(e) => handleChange("title", e.target.value)}
                            className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                            placeholder="è«‹è¼¸å…¥å·¥ç¨‹åç¨±"
                        />
                    </div>

                    {/* ç¬¬äºŒåˆ—ï¼šå®¢æˆ¶ (ä½”1) - ä½¿ç”¨è‡ªå®šç¾©æœå°‹å…ƒä»¶ */}
                    <div className="col-span-1">
                        <label className="block text-xs font-bold text-gray-500 mb-1">å®¢æˆ¶åç¨± (å¯æœå°‹)</label>
                        <CustomerSearchInput
                            value={activeQuote.customerName}
                            onChange={(val) => handleChange("customerName", val)}
                            // æ–°å¢ï¼šonSelect é‚è¼¯ï¼Œè™•ç†é¸å–æ™‚è‡ªå‹•å¸¶å…¥æ‰€æœ‰è³‡æ–™
                            onSelect={(found) => {
                                // 1. ç¢ºä¿å„²å­˜ä½¿ç”¨è€…æœ€çµ‚è¼¸å…¥çš„åç¨±
                                handleChange("customerName", found["å®¢æˆ¶åç¨±"]);

                                // 2. å¦‚æœæ˜¯èˆŠå®¢æˆ¶ï¼šå¼·åˆ¶è¦†è“‹æ‰€æœ‰ç›¸é—œæ¬„ä½
                                updateQuote(activeQuote.id, {
                                    customerName: found["å®¢æˆ¶åç¨±"],
                                    contact: found["è¯çµ¡äºº"] || activeQuote.contact || "",
                                    phone: found["é›»è©±"] || activeQuote.phone || "",
                                    location: found["åœ°å€"] || activeQuote.location || ""
                                });
                            }}
                        />
                    </div>
                    
                    {/* è¯çµ¡äºº (ä½”1) */}
                    <div className="col-span-1">
                        <label className="block text-xs font-bold text-gray-500 mb-1">è¯çµ¡äºº</label>
                        <input
                            type="text"
                            value={activeQuote.contact}
                            onChange={(e) => handleChange("contact", e.target.value)}
                            className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                        />
                    </div>

                    {/* é›»è©± (ä½”1) */}
                    <div className="col-span-1">
                        <label className="block text-xs font-bold text-gray-500 mb-1">è¯çµ¡é›»è©±</label>
                        <input
                            type="text"
                            value={activeQuote.phone}
                            onChange={(e) => handleChange("phone", e.target.value)}
                            className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                        />
                    </div>

                    {/* åœ°é» (ä½”1) */}
                    <div className="col-span-1">
                        <label className="block text-xs font-bold text-gray-500 mb-1">å·¥ç¨‹åœ°é»</label>
                        <input
                            type="text"
                            value={activeQuote.location}
                            onChange={(e) => handleChange("location", e.target.value)}
                            className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                        />
                    </div>

                </div>

                {/* ===== é‡‘é¡æ‘˜è¦å€ (æ©«å‘æ’åˆ—ï¼Œç¯€çœå‚ç›´ç©ºé–“) ===== */}
<div className="mt-4 pt-3 border-t border-gray-200 flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
    {/* å·¦é‚Šï¼šç¸½é‡‘é¡ */}
    <div className="flex items-center gap-2">
        <span className="text-gray-600 font-bold">ç¸½è¨ˆé‡‘é¡(æœªç¨…)ï¼š</span>
        {/* â­ ä¿®æ­£ï¼šç¸½é‡‘é¡æ”¾å¤§åˆ° 2XLï¼Œä¸¦åŠ ç²— */}
        <span className="text-2xl font-extrabold text-blue-700">
            NT$ {formatMoney(totalAmount)}
        </span>
    </div>

    {/* å³é‚Šï¼šæŠ˜æ‰£èˆ‡æœ€çµ‚å ±åƒ¹ (ä¸¦æ’é¡¯ç¤º) */}
    <div className="flex items-center gap-4">
        <div className="flex items-center gap-2">
            <span className="text-xs font-bold text-gray-500">æŠ˜æ‰£(%)</span>
            <input
                type="number"
                value={activeQuote.discountPercent}
                onChange={(e) => handleChange("discountPercent", Number(e.target.value))}
                className="w-16 border border-gray-300 rounded px-2 py-1 text-sm text-right focus:ring-1 focus:ring-blue-500 outline-none"
            />
        </div>
        
        <div className="flex items-center gap-2">
            <span className="text-xs font-bold text-gray-500">è‡ªå®šç¾©æœ€çµ‚åƒ¹</span>
            <input
                type="number"
                value={activeQuote.negotiatedPrice}
                onChange={(e) => handleChange("negotiatedPrice", Number(e.target.value))}
                className="w-24 border border-gray-300 rounded px-2 py-1 text-sm text-right focus:ring-1 focus:ring-blue-500 outline-none"
            />
        </div>

        {/* å¦‚æœæœ‰æœ€çµ‚å ±åƒ¹ï¼Œé¡¯ç¤ºç´…è‰²é‡‘é¡ */}
        {showFinalPrice && (
            <div className="pl-4 border-l border-gray-300">
                {/* â­ ä¿®æ­£ï¼šæœ€çµ‚å ±åƒ¹é‡‘é¡æ”¾å¤§åˆ° 2XLï¼Œä¸¦åŠ ç²— */}
                <span className="text-red-600 font-extrabold text-2xl">
                    NT$ {formatMoney(negotiatedAmount)}
                </span>
            </div>
        )}
    </div>
</div>
            </div>

            {/* ===== å ±åƒ¹é …ç›®åˆ—è¡¨ ===== */}
            <h2 className="text-2xl font-bold mt-10 mb-4 border-b pb-2">
                å ±åƒ¹é …ç›®åˆ—è¡¨
            </h2>

            <button
                className="bg-green-600 text-white px-5 py-2 rounded-lg mb-6 hover:bg-green-700 text-base"
                onClick={handleAddItem}
            >
                ï¼‹ æ–°å¢å·¥ç¨‹å¤§é …
            </button>

            <div className="quote-items-container space-y-6">
                {activeQuote.items.map((item, index) => (
                    <QuoteItem
                        key={item.id}
                        item={item}
                        index={index}
                        updateItem={(data) => handleUpdateItem(item.id, data)}
                        deleteItem={handleDeleteItem}
                    />
                ))}
            </div>

            {/* â–¼â–¼â–¼ æ’å…¥é€™è£¡ï¼šå¦‚æœæœ‰é›¶ä»¶è³‡æ–™ï¼Œå°±é¡¯ç¤ºç·¨è¼¯å™¨ â–¼â–¼â–¼ */}
            {activeQuote.leakageParts && (
                <LeakagePartsEditor 
                    parts={activeQuote.leakageParts} 
                    updateQuote={(data) => updateQuote(activeQuote.id, data)} 
                />
            )}
            {/* ===== å‚™è¨» / ä»˜æ¬¾æ¢ä»¶ ===== */}
            <div className="mt-10 grid grid-cols-2 gap-8">
                <div>
                    <h3 className="font-bold text-lg mb-2">å‚™è¨»ï¼ˆä¸å«ç¨…ï¼‰</h3>
                    <textarea
                        value={activeQuote.notes}
                        onChange={(e) => handleChange("notes", e.target.value)}
                        rows="8"
                        className="w-full border rounded-lg px-3 py-2"
                    />
                </div>

                <div>
                    <h3 className="font-bold text-lg mb-2">ä»˜æ¬¾æ¢ä»¶</h3>
                    <textarea
                        value={activeQuote.payment}
                        onChange={(e) => handleChange("payment", e.target.value)}
                        rows="8"
                        className="w-full border rounded-lg px-3 py-2"
                    />
                </div>
            </div>

            {/* ===== åŒ¯å‡º / åˆ—å° ===== */}
            <div className="mt-10 pt-6 border-t flex gap-4 justify-end no-print">
                <ExportButton />
                <ExportWordButton componentRef={componentRef} />
                <PrintButton componentRef={componentRef} />
            </div>

            {/* ===== å³æ™‚é è¦½ï¼ˆç•«é¢ç”¨ï¼‰ ===== */}
            <div className="live-preview-box mt-12 no-print">
                <h3 className="text-center font-bold text-2xl text-blue-700 mb-6">
                    å¯¦æ™‚é è¦½å€ï¼ˆéåˆ—å°å°ºå¯¸ï¼‰
                </h3>

                {/* â–¼â–¼â–¼ é€™è£¡æ˜¯é è¦½ç‰ˆé¢çš„å®¹å™¨ â–¼â–¼â–¼ */}
                <div 
                    style={{ 
                        backgroundColor: "#525659", 
                        padding: "40px 0",  
                        overflowX: "auto", 
                        border: "1px solid #ccc"
                    }}
                >
                    <div 
                        className="print-page"
                        style={{
                            backgroundColor: "white", 
                            width: "210mm", 
                            minHeight: "297mm", 
                            margin: "0 auto", 
                            padding: "20mm", 
                            boxShadow: "0 0 20px rgba(0,0,0,0.5)",
                            boxSizing: "border-box"
                        }}
                    >
                        <PrintLayout
                            quote={activeQuote}
                            totalAmount={totalAmount}
                            negotiatedAmount={negotiatedAmount}
                            isPreview={true}
                        />
                    </div>
                </div>
            </div>
            {/* â¬†ï¸ é€™è£¡çµæŸ .no-print å®¹å™¨ */}

            {/* âš ï¸ åˆ—å°å°ˆç”¨çš„éš±è—ç‰ˆé¢ */}
            <div
                ref={componentRef}
                className="print-only-layout"
            >
                <PrintLayout
                    quote={activeQuote}
                    totalAmount={totalAmount}
                    negotiatedAmount={negotiatedAmount}
                    isPreview={false}
                />
            </div>
        </div>
    </div> 
    );
}
// ========================================================
// ExportButton å…ƒä»¶ï¼šå°ˆé–€ç”¨æ–¼ Excel (XLSX) è¼¸å‡º (å„ªåŒ–å…¬å¼å’Œç¸½çµ)
// ========================================================
function ExportButton() {
    const { activeQuote } = React.useContext(AppContext);

    if (!activeQuote) return null;

    const exportToExcel = () => {
        if (!activeQuote.title) {
            alert("è«‹å…ˆè¼¸å…¥å·¥ç¨‹åç¨±å†åŒ¯å‡º Excelã€‚");
            return;
        }

        const data = [];
        
        // --- å ±åƒ¹å–®åŸºæœ¬è³‡è¨Š ---
        data.push([{ v: 'å ±åƒ¹å–®ç·¨è™Ÿ', s: { font: { bold: true } } }, activeQuote.quoteNo]);
        data.push([{ v: 'å·¥ç¨‹åç¨±', s: { font: { bold: true } } }, activeQuote.title]);
        data.push([{ v: 'å®¢æˆ¶åç¨±', s: { font: { bold: true } } }, activeQuote.customerName]);
        data.push([{ v: 'å·¥ç¨‹åœ°é»', s: { font: { bold: true } } }, activeQuote.location]);
        data.push([]); // ç©ºè¡Œåˆ†éš”
        
        // --- å ±åƒ¹é …ç›®è¡¨é ­ ---
        data.push([
            { v: 'é …æ¬¡', s: { font: { bold: true } } },
            { v: 'å“å', s: { font: { bold: true } } },
            { v: 'è¦æ ¼ / è£œå……å…§å®¹', s: { font: { bold: true } } },
            { v: 'å–®ä½', s: { font: { bold: true } } },
            { v: 'æ•¸é‡', s: { font: { bold: true } } },
            { v: 'å–®åƒ¹', s: { font: { bold: true } } },
            { v: 'é‡‘é¡(å°è¨ˆ)', s: { font: { bold: true } } },
            { v: 'å‚™è¨»', s: { font: { bold: true } } },
        ]);

        // --- å ±åƒ¹é …ç›®å…§å®¹ (å¸¶å…¥å…¬å¼) ---
        const startRow = data.length + 1; // è¨˜éŒ„é …ç›®èµ·å§‹è¡Œæ•¸ (å¾ 1 é–‹å§‹è¨ˆç®—)
        let currentRow = startRow;
        
        activeQuote.items.forEach((item, index) => {
            // ä¸»é …ç›®
            data.push([
                index + 1, // A
                item.name, // B
                item.specMain, // C
                item.unit, // D
                item.qty, // E
                item.price, // F
                // â­ é—œéµï¼šé‡‘é¡å°è¨ˆæ¬„ä½ (Gæ¬„)ï¼Œä½¿ç”¨å…¬å¼
                { f: `E${currentRow}*F${currentRow}` }, // G
                item.remarks // H
            ]);
            currentRow++;

            // å­é …ç›® (è¦æ ¼æ˜ç´°)
            item.subItems.filter(sub => sub.type === 'text').forEach(sub => {
                data.push([
                    '', 
                    'â””â”€ è¦æ ¼æ˜ç´°:', 
                    sub.name + ': ' + (sub.remarks || ''), 
                    '', '', '', '', 
                    ''
                ]);
                currentRow++;
            });
        });
        
        // --- ç¸½è¨ˆè¨ˆç®—èˆ‡ç¨…é¡ ---
        data.push([]); // ç©ºè¡Œ
        const totalRow = currentRow + 1; // ç¸½è¨ˆè¡Œæ•¸
        const taxRow = totalRow + 1; // ç¨…é¡è¡Œæ•¸
        const totalTaxRow = taxRow + 1; // ç¸½è¨ˆ(å«ç¨…)è¡Œæ•¸
        
        // 1. è¨ˆç®—ç¸½è¨ˆé‡‘é¡ (æœªç¨…)
        data.push([
            { v: 'ç¸½è¨ˆé‡‘é¡ (æœªç¨…)', s: { font: { bold: true } } }, 
            '', '', '', '', '', 
            // â­ é—œéµï¼šç¸½å’Œå…¬å¼ï¼Œç¸½çµæ‰€æœ‰å°è¨ˆé‡‘é¡ (Gæ¬„)
            { f: `SUM(G${startRow}:G${currentRow})`, s: { font: { bold: true, sz: 14 } } }
        ]);
        
        // 2. ç¨…é¡ (5%)
        data.push([
            { v: 'ç¨…é¡ (5%)', s: { font: { bold: true } } }, 
            '', '', '', '', '', 
            // â­ é—œéµï¼šç¨…é¡å…¬å¼
            { f: `G${totalRow}*0.05` }
        ]);

        // 3. åˆè¨ˆé‡‘é¡ (å«ç¨…)
        data.push([
            { v: 'åˆè¨ˆé‡‘é¡ (å«ç¨…)', s: { font: { bold: true } } }, 
            '', '', '', '', '', 
            // â­ é—œéµï¼šå«ç¨…ç¸½å’Œå…¬å¼
            { f: `G${totalRow}+G${taxRow}`, s: { font: { bold: true, sz: 16 } } }
        ]);

        // --- æœ€çµ‚å ±åƒ¹ (å¦‚æœé©ç”¨) ---
        if (activeQuote.discountPercent > 0 || activeQuote.negotiatedPrice > 0) {
            data.push([]); // ç©ºè¡Œ
            const finalPriceRow = totalTaxRow + 2;

            // æœ€çµ‚å ±åƒ¹ï¼ˆæœªç¨…ï¼‰
            data.push([
                { v: 'æœ€çµ‚å ±åƒ¹é‡‘é¡ (æœªç¨…)', s: { font: { bold: true, color: { rgb: "FF0000" } } } }, 
                '', '', '', '', '', 
                // â­ é—œéµï¼šä½¿ç”¨è‡ªå®šç¾©çš„åƒ¹æ ¼ä½œç‚ºæœ€çµ‚é‡‘é¡
                { v: activeQuote.negotiatedPrice || (calcTotal(activeQuote.items) * (1 - activeQuote.discountPercent / 100)), s: { font: { bold: true, sz: 18, color: { rgb: "FF0000" } } } }
            ]);
            
            // æœ€çµ‚å ±åƒ¹ï¼ˆå«ç¨…ï¼‰
            data.push([
                { v: 'æœ€çµ‚å ±åƒ¹é‡‘é¡ (å«ç¨…)', s: { font: { bold: true, color: { rgb: "FF0000" } } } }, 
                '', '', '', '', '', 
                // â­ é—œéµï¼šæœ€çµ‚åƒ¹æ ¼å«ç¨…å…¬å¼
                { f: `G${finalPriceRow}*1.05`, s: { font: { bold: true, sz: 20, color: { rgb: "FF0000" } } } }
            ]);
        }
        
        // --- å‚™è¨»å’Œä»˜æ¬¾æ¢ä»¶ ---
        data.push([]); 
        data.push([{ v: 'å‚™è¨»:', s: { font: { bold: true } } }]);
        data.push([activeQuote.notes]);
        data.push([]); 
        data.push([{ v: 'ä»˜æ¬¾æ¢ä»¶:', s: { font: { bold: true } } }]);
        data.push([activeQuote.payment]);


        // è½‰æ›ç‚ºå·¥ä½œè¡¨
        const ws = XLSX.utils.aoa_to_sheet(data);

        // æ ¼å¼åŒ–ç‚ºè²¨å¹£ (Gæ¬„)
        const formatRange = `G${startRow}:G${totalTaxRow + 5}`;
        for (let R = startRow - 1; R < data.length; R++) {
            const cell = `G${R + 1}`;
            if (ws[cell] && (ws[cell].t === 'n' || ws[cell].f)) {
                 // å¼·åˆ¶åŠ ä¸Š NT$ è²¨å¹£æ ¼å¼
                ws[cell].z = 'NT$ #,##0'; 
            }
        }
        
        // è¼¸å‡ºæª”æ¡ˆ
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, activeQuote.title);
        XLSX.writeFile(wb, `${activeQuote.title} - ${activeQuote.customerName} å ±åƒ¹å–®.xlsx`);
    };

    return (
        <button 
            onClick={exportToExcel}
            className="bg-green-700 text-white px-5 py-2 rounded-lg hover:bg-green-800 text-base shadow-lg"
        >
            åŒ¯å‡º Excel (æ•¸æ“šç‰ˆ)
        </button>
    );
}
// ===============================
// Word åŒ¯å‡º (æ¥µé™ç‰ˆ v4ï¼šæ¸…æ™°å¯è®€ï¼Œä¿®æ­£é ‚éƒ¨ç•™ç™½)
// ===============================
function ExportWordButton() {
  const { activeQuote } = React.useContext(AppContext);

  const handleExportWord = () => {
    if (!activeQuote) {
      alert("è«‹å…ˆé¸æ“‡å ±åƒ¹å–®");
      return;
    }

    // 1. æº–å‚™è³‡æ–™
    const companyKey = activeQuote.company || "herhsin";
    const companyInfo = COMPANY_DATA[companyKey];
    const totalAmount = calcTotal(activeQuote.items);
    const negotiatedAmount = calcNegotiated(
        totalAmount, 
        activeQuote.discountPercent, 
        activeQuote.negotiatedPrice
    );
    const showFinalPrice = (activeQuote.discountPercent > 0) || (activeQuote.negotiatedPrice > 0);
    const hasLeakageParts = activeQuote.leakageParts && activeQuote.leakageParts.length > 0;
    
    // 2. ç”¢ç”Ÿ Word HTML (æ¸…æ™°å¯è®€æ’ç‰ˆ)
    const wordContent = `
      <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
     <head>
Â  Â  Â  Â  <meta charset="utf-8">
Â  Â  Â  Â  <title>${activeQuote.title}</title>
Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  /* 1. é‚Šç•Œè¨­å®š */
Â  Â  Â  Â  Â  @page {
Â  Â  Â  Â  Â  Â  mso-page-orientation: portrait;
Â  Â  Â  Â  Â  Â  size: 210mm 297mm;
Â  Â  Â  Â  Â  Â  margin: 5mm 8mm 5mm 8mm; 
Â  Â  Â  Â  Â  Â  mso-header-margin: 0;
Â  Â  Â  Â  Â  Â  mso-footer-margin: 0;
Â  Â  Â  Â  Â  Â  mso-margin-top-header: 0;
Â  Â  Â  Â  Â  Â  mso-margin-bottom-footer: 0;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  /* 2. åŸºç¤å­—é«”èª¿æ•´ */
Â  Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: "Microsoft JhengHei", "PMingLiU", serif;
Â  Â  Â  Â  Â  Â  /* â­ ä¿®æ­£ï¼šåŸºç¤å­—é«”å¾ 9pt/10pt æ”¾å¤§åˆ° 12pt â­ */
Â  Â  Â  Â  Â  Â  font-size: 12pt; 
Â  Â  Â  Â  Â  Â  line-height: 1.05; 
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  /* è¡¨æ ¼è¨­å®š */
Â  Â  Â  Â  Â  table {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  Â  Â  border-spacing: 0;
Â  Â  Â  Â  Â  Â  margin-bottom: 3px; 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  /* å„²å­˜æ ¼å…§è·å¾®èª¿ */
Â  Â  Â  Â  Â  td, th {
Â  Â  Â  Â  Â  Â  border: 1px solid black;
Â  Â  Â  Â  Â  Â  padding: 2px 3px; 
Â  Â  Â  Â  Â  Â  vertical-align: top; 
Â  Â  Â  Â  Â  Â  /* â­ ä¿®æ­£ï¼šå„²å­˜æ ¼å­—é«”å¾ 9pt/10pt æ”¾å¤§åˆ° 12pt â­ */
Â  Â  Â  Â  Â  Â  font-size: 12pt;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  /* æ•¸å­—æ¬„ä½å­—é«” */
Â  Â  Â  Â  Â  .num-cell {
Â  Â  Â  Â  Â  Â  /* â­ ä¿®æ­£ï¼šæ•¸å­—å­—é«”å¾ 9pt/10pt æ”¾å¤§åˆ° 12pt â­ */
Â  Â  Â  Â  Â  Â  font-size: 12pt; 
Â  Â  Â  Â  Â  Â  font-weight: bold; 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  /* å‚™è¨»/ç”¨æ–™æ˜ç´°ç¸®å°åˆ° 10pt (ç¶­æŒæ¸…æ™°åº¦ï¼Œå› ç‚ºåŸºç¤å·²æ˜¯ 12pt) */
Â  Â  Â  Â  Â  .detail-row td {
Â  Â  Â  Â  Â  Â  Â padding: 1px 3px !important; 
Â  Â  Â  Â  Â  Â  Â font-size: 10pt; 
Â  Â  Â  Â  Â  Â  Â color: #444;
Â  Â  Â  Â  Â  Â  Â border-top: 1px dashed #ccc;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  .no-border, .no-border td { border: none !important; }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  /* 3. æ¨™é¡Œèˆ‡é™„å±¬è³‡è¨Šå¾®èª¿ */
Â  Â  Â  Â  Â  h1 { font-size: 18pt; text-align: center; margin: 0; padding-top: 0; line-height: 1.1; } /* æ¨™é¡Œå¾®èª¿æ”¾å¤§ */
Â  Â  Â  Â  Â  h2 { font-size: 14pt; text-align: center; margin: 2px 0; text-decoration: underline; } /* å‰¯æ¨™é¡Œå¾®èª¿æ”¾å¤§ */
Â  Â  Â  Â  Â  .sub-info { font-size: 10pt; text-align: center; margin-bottom: 2px; color: #444; } /* å…¬å¸è³‡è¨Šèª¿æ•´åˆ° 10pt */
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  .text-center { text-align: center; }
Â  Â  Â  Â  Â  .text-right { text-align: right; }
Â  Â  Â  Â  Â  .font-bold { font-weight: bold; }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  /* 4. ç°½åæ¬„é«˜åº¦å£“ç¸® */
Â  Â  Â  Â  Â  .sig-box { height: 40px; vertical-align: top; } 
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  /* å‚™è¨»/ä»˜æ¬¾æ¢ä»¶å­—é«”èª¿æ•´ç‚º 10pt */
Â  Â  Â  Â  Â  .note-text { font-size: 10pt; margin-top: 1px; white-space: pre-wrap; line-height: 1.2; }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  </style>
Â  Â  Â  </head>
      <body>
        
        <table class="no-border" style="margin-bottom: 0; mso-yfti-tbllook:1184;">
          <tr>
            <td class="text-center" style="padding: 0;">
              <h1>${companyInfo.name}</h1>
              <div class="sub-info">
                çµ±ç·¨ï¼š${companyInfo.taxId} ï½œ é›»è©±ï¼š${companyInfo.tel} ï½œ å‚³çœŸï¼š${companyInfo.fax} <br/>
                ${companyInfo.address}
              </div>
              <h2>å·¥ç¨‹å ±åƒ¹å–®</h2>
            </td>
          </tr>
        </table>

        <table class="no-border" style="margin-bottom: 3px;">
          <tr>
            <td width="60%" valign="top" style="line-height: 1.2;">
              <strong>å®¢æˆ¶åç¨±ï¼š</strong>${activeQuote.customerName || ""}<br/>
              <strong>å·¥ç¨‹åç¨±ï¼š</strong>${activeQuote.title || ""}<br/>
              <strong>å·¥ç¨‹åœ°é»ï¼š</strong>${activeQuote.location || ""}<br/>
              <strong>è¯çµ¡é›»è©±ï¼š</strong>${activeQuote.phone || ""}
            </td>
            <td width="40%" valign="top" class="text-right" style="line-height: 1.2;">
              <strong>å ±åƒ¹å–®è™Ÿï¼š</strong>${activeQuote.quoteNo}<br/>
              <strong>å ±åƒ¹æ—¥æœŸï¼š</strong>${activeQuote.date}<br/>
              <strong>è¯çµ¡äººï¼šï¼š</strong>${activeQuote.contact || ""}
            </td>
          </tr>
        </table>

        <table style="margin-bottom: 3px;">
          <thead>
            <tr style="background-color: #f0f0f0;">
              <th width="5%">é …æ¬¡</th>
              <th width="30%">å“å</th>
              <th width="30%">è¦æ ¼</th>
              <th width="6%">å–®ä½</th>
              <th width="6%">æ•¸é‡</th>
              <th width="10%">å–®åƒ¹</th>
              <th width="13%">å°è¨ˆ</th>
            </tr>
          </thead>
          <tbody>
            ${activeQuote.items.map((item, index) => `
              <tr>
                <td class="text-center">${index + 1}</td>
                <td>${item.name || ""}</td>
                <td>${item.specMain || ""}</td>
                <td class="text-center">${item.unit || ""}</td>
                <td class="text-center num-cell">${item.qty}</td>
                <td class="text-right num-cell">${item.price ? formatMoney(item.price) : "-"}</td>
                <td class="text-right num-cell font-bold">${calcAmount(item) ? formatMoney(calcAmount(item)) : "-"}</td>
              </tr>
              ${item.specMaterial ? `
              <tr class="detail-row">
                <td style="border-top: none;"></td>
                <td colspan="6">
                  <strong>ç”¨æ–™ï¼š</strong>${item.specMaterial}
                </td>
              </tr>` : ""}
              ${item.remarks ? `
              <tr class="detail-row">
                <td style="border-top: none;"></td>
                <td colspan="6">
                  å‚™è¨»ï¼š${item.remarks}
                </td>
              </tr>` : ""}
            `).join("")}
            
            <tr style="height: 18px;">
              <td colspan="5" class="no-border"></td>
              <td class="text-center font-bold" style="background-color: #f0f0f0; font-size: 9pt;">ç¸½è¨ˆé‡‘é¡</td>
              <td class="text-right font-bold num-cell" style="background-color: #f0f0f0; font-size: 9pt;">${formatMoney(totalAmount)}</td>
            </tr>
            
            ${showFinalPrice ? `
            <tr style="height: 18px;">
               <td colspan="5" class="no-border"></td>
               <td class="text-center font-bold" style="color: red; border-top: none; font-size: 9pt;">æœ€çµ‚å ±åƒ¹</td>
               <td class="text-right font-bold num-cell" style="color: red; border-top: none; font-size: 9pt;">${formatMoney(negotiatedAmount)}</td>
            </tr>
            ` : ""}
          </tbody>
        </table>

        ${hasLeakageParts ? `
        <div style="border-left: 3px solid #000; padding-left: 5px; font-weight: bold; margin: 2px 0 1px 0; font-size: 9pt;">
          â€» å¯¦æ”¯å¯¦ä»˜ç¶­ä¿®é›¶ä»¶ <span style="font-size: 8pt; font-weight: normal;">(ä¸è¨ˆå…¥ç¸½é¡)</span>
        </div>
        <table style="margin-bottom: 2px;">
          <thead>
            <tr style="background-color: #f0f0f0;">
              <th width="40%">å“å</th>
              <th width="35%">è¦æ ¼</th>
              <th width="10%">å–®ä½</th>
              <th width="15%">å–®åƒ¹</th>
            </tr>
          </thead>
          <tbody>
            ${activeQuote.leakageParts.map(part => `
              <tr>
                <td>${part.name || ""}</td>
                <td>${part.spec || ""}</td>
                <td class="text-center">${part.unit || ""}</td>
                <td class="text-right num-cell font-bold">${part.price ? formatMoney(part.price) : "-"}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
        ` : ""}

        <table style="margin-top: 3px;">
          <tr>
             <td width="50%" valign="top" style="padding: 2px 3px;">
                <strong>å‚™è¨»ï¼š</strong><br/>
                <div class="note-text">${activeQuote.notes || ""}</div>
             </td>
             <td width="50%" valign="top" style="padding: 2px 3px;">
                <strong>ä»˜æ¬¾æ¢ä»¶ï¼š</strong><br/>
                <div class="note-text">${activeQuote.payment || ""}</div>
             </td>
          </tr>
        </table>

        <table style="margin-top: 1px;">
          <tr>
            <td width="50%" class="sig-box">
               <strong>å…¬å¸å ±åƒ¹ç« </strong><br/>
               ${companyInfo.stamp ? `<img src="${companyInfo.stamp}" width="55" height="55" style="display:block; margin: 0 auto;" />` : ""}
            </td>
            <td width="50%" class="sig-box">
               <strong>å®¢æˆ¶å›ç°½</strong>
            </td>
          </tr>
          <tr>
             <td class="text-center" style="font-size: 8pt; border-top: none; padding-top: 0;">æ—¥æœŸï¼š</td>
             <td class="text-center" style="font-size: 8pt; border-top: none; padding-top: 0;">æ—¥æœŸï¼š</td>
          </tr>
        </table>

      </body>
      </html>
    `;

    // 3. ä¸‹è¼‰
    const filename = `${activeQuote.quoteNo}_${activeQuote.customerName || "å®¢æˆ¶"}_å ±åƒ¹å–®.doc`;
    const blob = new Blob(["\ufeff", wordContent], { type: "application/msword;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <button onClick={handleExportWord} className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
      åŒ¯å‡º Word (æ¥µé™ç‰ˆ v3)
    </button>
  );
}
// ===============================
// PrintButton (åˆ—å°æŒ‰éˆ•) - ä¿®æ­£ç‰ˆ
// ===============================
function PrintButton() {
  
  const handlePrint = () => {
      // 1. ç¢ºä¿å ±åƒ¹å–®å…§å®¹å·²æ¸²æŸ“
      const printContent = document.querySelector('.print-page');

      if (!printContent) {
          alert("æ‰¾ä¸åˆ°å ±åƒ¹å–®é è¦½å…§å®¹ã€‚è«‹å…ˆé¸æ“‡æˆ–æ–°å¢å ±åƒ¹å–®ã€‚");
          return;
      }

      // 2. å–å¾—å ±åƒ¹å–®çš„ HTML å…§å®¹
      const content = printContent.outerHTML;

      // 3. å‰µå»ºä¸€å€‹æ–°çš„ iframe/è¦–çª—ç”¨æ–¼åˆ—å°ï¼Œä»¥éš”é›¢å…§å®¹
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
          alert("ç„¡æ³•é–‹å•Ÿåˆ—å°è¦–çª—ï¼Œè«‹æª¢æŸ¥æ˜¯å¦è¢«ç€è¦½å™¨é˜»æ“‹å½ˆå‡ºè¦–çª—ã€‚");
          return;
      }

      // 4. æº–å‚™åˆ—å°æ‰€éœ€çš„å®Œæ•´ HTML çµæ§‹
      const printDoc = `
          <!DOCTYPE html>
          <html>
          <head>
              <title>å ±åƒ¹å–®åˆ—å°</title>
              <meta charset="utf-8">
              <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2/dist/tailwind.min.css" rel="stylesheet">
              <style>
                  /* ç¢ºä¿ PrintLayout å…§éƒ¨çš„ style æ¨™ç±¤èƒ½ç”Ÿæ•ˆ */
                  @media print {
                      @page { margin: 10mm 10mm 10mm 10mm; size: A4; }
                      body { margin: 0; padding: 0; }
                      .print-page { width: 100%; }
                      /* ç¢ºä¿ä¸­æ–‡å­—é«”èƒ½æ­£ç¢ºé¡¯ç¤º */
                      body, table, td, th { font-family: "Microsoft JhengHei", "PMingLiU", serif; }
                  }
              </style>
          </head>
          <body>
              ${content}
          </body>
          </html>
      `;

      // 5. å¯«å…¥å…§å®¹ä¸¦é–‹å•Ÿåˆ—å°
      printWindow.document.write(printDoc);
      printWindow.document.close();

      // 6. ç¢ºä¿å…§å®¹åŠ è¼‰å®Œæˆå¾Œå†åŸ·è¡Œåˆ—å°
      printWindow.onload = function() {
          // çµ¦äºˆå¾®å°å»¶é²ç¢ºä¿ç€è¦½å™¨æ¸²æŸ“å®Œæˆ
          setTimeout(() => {
              printWindow.focus();
              printWindow.print();
              printWindow.close();
          }, 300); 
      };
      
      // Fallback æ©Ÿåˆ¶ (å¦‚æœ onload æ²’æœ‰è§¸ç™¼)
      setTimeout(() => {
          if (printWindow && printWindow.document.readyState !== 'loading') {
               printWindow.focus();
               printWindow.print();
          }
      }, 1500);
  };

  return (
    <button
      onClick={handlePrint} // å‘¼å«æ–°çš„è‡ªå®šç¾©å‡½å¼
      className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
    >
      åˆ—å°å ±åƒ¹å–®
    </button>
  );
}
/***********************************************************
 * åˆ—å°æ’ç‰ˆçµ„ä»¶ï¼ˆPrintLayoutï¼‰â€” æœ€çµ‚ç‰ˆ (å­—é«”æ”¾å¤§)
 ***********************************************************/
function PrintLayout({ quote, totalAmount, negotiatedAmount, isPreview }) {
  // 1. é˜²å‘†æª¢æŸ¥
  if (!quote || !COMPANY_DATA[quote.company]) {
    return (
      <div style={{ textAlign: "center", padding: 20, color: "#888" }}>
        è«‹é¸æ“‡æˆ–æ–°å¢å ±åƒ¹å–®ä»¥é¡¯ç¤ºé è¦½
      </div>
    );
  }

  // 2. è®Šæ•¸å®šç¾©
  const companyInfo = COMPANY_DATA[quote.company];
  const isLeakageMode = quote.items.some(i => i.name?.includes("æ¼æ¼¿")) || quote.title?.includes("æ¼æ¼¿");
  const itemsToPrint = isLeakageMode ? quote.items.filter(item => item.qty > 0) : quote.items;
  const showFinalPrice = (quote.discountPercent > 0) || (quote.negotiatedPrice > 0);
  const calcAmount = (item) => item.price * item.qty;

  // 3. æ¨£å¼å®šç¾© (ä½¿ç”¨çµ•å°åƒç´ å€¼ï¼Œç¢ºä¿ä¸€è‡´æ€§)
  const BASE_FONT_SIZE = "16px"; // â­ æ ¸å¿ƒä¿®æ­£ï¼šåŸºç¤å­—é«”å¤§å° 16px
  const SMALL_FONT_SIZE = "14px"; // å“é …æ˜ç´°/å­é …ç›®ä½¿ç”¨ 14px
  const LARGE_FONT_SIZE = "18px"; // â­ ä¿®æ­£ï¼šç”¨æ–™æ˜ç´°/å‚™è¨»/ä»˜æ¬¾æ¢ä»¶æ¨™é¡Œä½¿ç”¨ 18px

  const TH_TD = { border: "1px solid #000", padding: "3px 4px", fontSize: BASE_FONT_SIZE, verticalAlign: "middle", lineHeight: "1.2" };
  const TH = { ...TH_TD, background: "#f0f0f0", fontWeight: "bold", textAlign: "center", padding: "4px" };
  const TD_RIGHT = { ...TH_TD, textAlign: "right" };
  const TD_CENTER = { ...TH_TD, textAlign: "center" };

  return (
    <div className="print-page">
      {/* ä¿®æ­£ï¼šå°‡ä¸Šæ–¹é‚Šç•Œæ”¹å› 10mm ä»¥å…è£åˆ‡ */}
      <style>{`
        @media print {
          @page { margin: 10mm 10mm 10mm 10mm; size: auto; }
          body { margin: 0; }
        }
      `}</style>

      <div className="print-content">
        
        {/* ==========================================
            Part 1: è¡¨é ­è³‡æ–™å€
            ========================================== */}
        <table style={{ width: "100%", borderCollapse: "collapse", marginBottom: 5 }}>
          <tbody>
            <tr>
              <td colSpan="2" style={{ textAlign: "center", paddingBottom: 5 }}>
                <h2 style={{ margin: 0, fontSize: "24px", lineHeight: "1.2" }}>{companyInfo.name}</h2>
                <div style={{ fontSize: 11, marginTop: 4 }}>
                  çµ±ç·¨ï¼š{companyInfo.taxId} ï½œ é›»è©±ï¼š{companyInfo.tel} ï½œ å‚³çœŸï¼š{companyInfo.fax}
                </div>
                <div style={{ fontSize: 11 }}>{companyInfo.address}</div>
                <h3 style={{ marginTop: 8, fontSize: "20px", borderBottom: "2px solid #333", display: "inline-block", paddingBottom: 2 }}>å·¥ç¨‹å ±åƒ¹å–®</h3>
              </td>
            </tr>
            <tr>
              {/* å®¢æˆ¶åŸºæœ¬è³‡æ–™ (å·¦å´) */}
              {/* â­ ä¿®æ­£ï¼šå®¢æˆ¶åŸºæœ¬è³‡æ–™æ–‡å­—æ”¹ 16px (BASE_FONT_SIZE) */}
              <td style={{ verticalAlign: "bottom", width: "60%", fontSize: BASE_FONT_SIZE, lineHeight: "1.4em" }}>
                  <div><strong>å®¢æˆ¶åç¨±ï¼š</strong>{quote.customerName}</div>
                  <div><strong>å·¥ç¨‹åç¨±ï¼š</strong>{quote.title}</div>
                  <div><strong>å·¥ç¨‹åœ°é»ï¼š</strong>{quote.location}</div>
                  <div><strong>è¯çµ¡é›»è©±ï¼š</strong>{quote.phone}</div>
              </td>
              {/* å ±åƒ¹å–®è™Ÿ/æ—¥æœŸ/è¯çµ¡äºº (å³å´) */}
              {/* â­ ä¿®æ­£ï¼šå ±åƒ¹å–®å…§çš„æ–‡å­—æ”¹ 16px (BASE_FONT_SIZE) */}
              <td style={{ verticalAlign: "bottom", width: "40%", textAlign: "right", fontSize: BASE_FONT_SIZE, lineHeight: "1.4em" }}>
                  <div><strong>å ±åƒ¹å–®è™Ÿï¼š</strong>{quote.quoteNo}</div>
                  {/* â­ ä¿®æ­£ï¼šæ—¥æœŸæ–‡å­—æ”¹ 16px (å·²åŒ…å«åœ¨ BASE_FONT_SIZE) */}
                  <div><strong>å ±åƒ¹æ—¥æœŸï¼š</strong>{quote.date}</div>
                  <div><strong>è¯çµ¡äººï¼š</strong>{quote.contact}</div>
              </td>
            </tr>
          </tbody>
        </table>Â 


        {/* ==========================================
            Part 2: ä¸»é …ç›®åˆ—è¡¨
            ========================================== */}
        <table style={{ width: "100%", borderCollapse: "collapse", border: "2px solid black" }}>
          <colgroup>
            <col style={{ width: "5%" }} />
            <col style={{ width: "28%" }} />
            <col style={{ width: "28%" }} />
            <col style={{ width: "5%" }} />
            <col style={{ width: "6%" }} />
            <col style={{ width: "10%" }} />
            <col style={{ width: "10%" }} />
            <col style={{ width: "8%" }} />
          </colgroup>
          <thead>
            {/* è¡¨æ ¼æ¨™é¡Œè¡Œæœƒç¹¼æ‰¿ TH_TD çš„ BASE_FONT_SIZE (16px) */}
            <tr>
              <th style={TH}>é …<br />æ¬¡</th>
              <th style={TH}>å“å</th>
              <th style={TH}>è¦æ ¼</th>
              <th style={TH}>å–®ä½</th>
              <th style={TH}>æ•¸é‡</th>
              <th style={TH}>å–®åƒ¹</th>
              <th style={TH}>å°è¨ˆ</th>
              <th style={TH}>å‚™è¨»</th>
            </tr>
          </thead>
          <tbody>
            {itemsToPrint.map((item, index) => (
              <React.Fragment key={item.id || index}>
                {/* å ±åƒ¹é …ç›®ä¸»è¡Œ */}
                <tr>
                    {/* é …ç›®å…§å®¹æœƒç¹¼æ‰¿ TH_TD çš„ BASE_FONT_SIZE (16px) */}
                    <td style={TD_CENTER}>{index + 1}</td>
                    <td style={TH_TD}>{item.name}</td>
                    <td style={{ ...TH_TD, color: "#444" }}>{item.specMain}</td>
                    <td style={TD_CENTER}>{item.unit}</td>
                    <td style={TD_CENTER}>{item.qty}</td>
                    <td style={TD_RIGHT}>
                        {item.price > 0 ? formatMoney(item.price) : "-"}
                    </td>
                    <td style={{ ...TD_RIGHT, fontWeight: "bold" }}>
                        {calcAmount(item) > 0 ? formatMoney(calcAmount(item)) : "-"}
                    </td>
                    <td style={TH_TD}>{item.remarks}</td>
                </tr>
                {/* ç”¨æ–™æ˜ç´°è¡Œ */}
                {item.specMaterial && (
                  <tr>
                    <td style={{ ...TH_TD, borderTop: "none" }}></td>
                    {/* â­ ä¿®æ­£ï¼šç”¨æ–™æ˜ç´°æ–‡å­—æ”¾å¤§ä¸€è™Ÿåˆ° 18px (LARGE_FONT_SIZE) */}
                    <td colSpan="7" style={{ ...TH_TD, color: "#444", fontSize: LARGE_FONT_SIZE, borderTop: "1px dashed #ccc" }}>
                      <span style={{ fontWeight: "bold" }}>ç”¨æ–™ï¼š</span>{item.specMaterial}
                    </td>
                  </tr>
                )}
                {/* å­é …ç›®è¡Œ */}
                {item.subItems && item.subItems.map(sub => (
                    <tr key={sub.id}>
                          <td style={{ ...TH_TD, borderTop: "none" }}></td>
                          {/* å­é …ç›®ç¶­æŒ 16px (BASE_FONT_SIZE) æˆ–å¯ä½¿ç”¨æ›´å°çš„ 14px ä¿æŒå±¤æ¬¡æ„Ÿ */}
                          <td colSpan="7" style={{ ...TH_TD, color: "#666", fontSize: SMALL_FONT_SIZE, textAlign: sub.type === "image" ? "center" : "left" }}>
                             {sub.type === "image" ? (
                               <img src={sub.imageData} alt="åœ–ç‰‡" style={{ maxWidth: "50%", maxHeight: "150px", display: "block", margin: "0 auto" }} />
                             ) : (
                               <span><span style={{fontWeight: "bold"}}>{sub.name}</span>ï¼š{sub.remarks}</span>
                             )}
                          </td>
                    </tr>
                ))}
              </React.Fragment>
            ))}

            {itemsToPrint.length === 0 && (
                <tr><td colSpan={8} style={{...TD_CENTER, padding: 10, color: "#999", fontSize: BASE_FONT_SIZE}}>ç„¡é …ç›®</td></tr>
            )}
            
            {/* é‡‘é¡ç¸½è¨ˆè¡Œï¼šä½¿ç”¨ 16px (BASE_FONT_SIZE) */}
            <tr style={{ height: "18px" }}>
              <td colspan="5" style={{ border: "none" }}></td>
              <td style={{ ...TH_TD, textAlign: "center", fontWeight: "bold", background: "#f0f0f0", fontSize: BASE_FONT_SIZE }}>ç¸½è¨ˆé‡‘é¡</td>
              <td style={{ ...TD_RIGHT, fontWeight: "bold", background: "#f0f0f0", fontSize: BASE_FONT_SIZE }}>{formatMoney(totalAmount)}</td>
              <td style={{ ...TH_TD, background: "#f0f0f0", fontSize: BASE_FONT_SIZE }}></td>
            </tr>
            
            {/* æœ€çµ‚å ±åƒ¹è¡Œï¼šä½¿ç”¨ 16px (BASE_FONT_SIZE) */}
            {showFinalPrice ? (
            <tr style={{ height: "18px" }}>
               <td colspan="5" style={{ border: "none" }}></td>
               <td style={{ ...TH_TD, textAlign: "center", fontWeight: "bold", color: "red", borderTop: "none", fontSize: BASE_FONT_SIZE }}>æœ€çµ‚å ±åƒ¹</td>
               <td style={{ ...TD_RIGHT, fontWeight: "bold", color: "red", borderTop: "none", fontSize: BASE_FONT_SIZE }}>{formatMoney(negotiatedAmount)}</td>
               <td style={{ ...TH_TD, borderTop: "none" }}></td>
            </tr>
            ) : null}
          </tbody>
        </table>


        {/* ==========================================
            Part 3: é‡‘é¡ç¸½çµ (åº•éƒ¨æµ®å‹•é‡‘é¡ï¼Œé‡‘é¡æ”¾å¤§åˆ° 21px)
            ========================================== */}
        <table style={{ width: "100%", borderCollapse: "collapse", marginTop: 5 }}>
          <colgroup>
            <col style={{ width: "75%" }} />
            <col style={{ width: "20%" }} />
            <col style={{ width: "5%" }} />
          </colgroup>
          <tbody>
            <tr>
              <td style={{ ...TD_RIGHT, fontWeight: "bold", border: "none", fontSize: BASE_FONT_SIZE }}>
                ç¸½è¨ˆé‡‘é¡ï¼ˆæœªç¨…ï¼‰
              </td>
              <td style={{ 
                ...TD_RIGHT, 
                fontWeight: "bold", 
                whiteSpace: "nowrap", 
                borderBottom: "1px solid #000",
                fontSize: "21px" // â­ æ ¸å¿ƒé‡‘é¡å­—é«” 21px
              }}>
                {formatMoney(totalAmount)}
              </td>
              <td style={{ ...TH_TD, border: "none" }}></td>
            </tr>
            {showFinalPrice && (
                <tr>
                  <td style={{ ...TD_RIGHT, fontWeight: "bold", border: "none", fontSize: BASE_FONT_SIZE }}>
                    æœ€çµ‚å ±åƒ¹é‡‘é¡ï¼ˆæœªç¨…ï¼‰
                  </td>
                  <td style={{ 
                    ...TD_RIGHT, 
                    fontWeight: "bold", 
                    color: "red", 
                    whiteSpace: "nowrap", 
                    borderBottom: "1px solid #000",
                    fontSize: "21px" // â­ æ ¸å¿ƒé‡‘é¡å­—é«” 21px
                  }}>
                    {formatMoney(negotiatedAmount)}
                  </td>
                  <td style={{ ...TH_TD, border: "none" }}></td>
                </tr>
            )}
          </tbody>
        </table>

        {/* ==========================================
            Part 4: å¯¦æ”¯å¯¦ä»˜é›¶ä»¶è¡¨
            ========================================== */}
        {quote.leakageParts && quote.leakageParts.length > 0 && (
        <div className="mt-2 mb-2 page-break-inside-avoid">
            <div className="font-bold text-gray-800 mb-1 pl-2 border-l-2 border-blue-600" style={{fontSize: BASE_FONT_SIZE}}>
            â€» å¯¦æ”¯å¯¦ä»˜ç¶­ä¿®é›¶ä»¶åƒ¹ç›®è¡¨
            <span className="font-normal text-gray-500 ml-2" style={{fontSize: SMALL_FONT_SIZE}}>
                (ä¸è¨ˆå…¥ç¸½é¡ï¼Œä¾å¯¦ä½œæ•¸é‡è¨ˆåƒ¹)
            </span>
            </div>
            
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: SMALL_FONT_SIZE, border: "1px solid #ccc" }}>
            {/* è¡¨é ­å’Œå…§å®¹éƒ½ä½¿ç”¨ 14px (SMALL_FONT_SIZE) */}
            <thead>
                <tr style={{ backgroundColor: "#f4f4f4", borderBottom: "1px solid #ccc" }}>
                    <th style={{ padding: "2px 4px", textAlign: "left", width: "35%" }}>å“å</th>
                    <th style={{ padding: "2px 4px", textAlign: "left", width: "35%" }}>è¦æ ¼</th>
                    <th style={{ padding: "2px 4px", textAlign: "center", width: "10%" }}>å–®ä½</th>
                    <th style={{ padding: "2px 4px", textAlign: "right", width: "20%" }}>å–®åƒ¹</th>
                </tr>
            </thead>
            <tbody>
                {quote.leakageParts.map((part, idx) => (
                    <tr key={idx} style={{ borderBottom: "1px solid #eee" }}>
                        <td style={{ padding: "1px 4px" }}>{part.name}</td>
                        <td style={{ padding: "1px 4px", color: "#555" }}>{part.spec}</td>
                        <td style={{ padding: "1px 4px", textAlign: "center" }}>{part.unit}</td>
                        <td style={{ padding: "1px 4px", textAlign: "right", fontWeight: "bold" }}>
                            ${Number(part.price).toLocaleString()}
                        </td>
                    </tr>
                ))}
            </tbody>
            </table>
        </div>
        )}


        {/* ==========================================
            Part 5: é å°¾ & ç°½å
            ========================================== */}
        <div className="print-footer-block">
            <table style={{ width: "100%", borderCollapse: "collapse", marginTop: 5 }}>
                <tbody>
                <tr>
                    {/* å‚™è¨»å€å¡Š */}
                    <td style={{ ...TH_TD, width: "50%", verticalAlign: "top", fontSize: BASE_FONT_SIZE }}>
                        {/* â­ ä¿®æ­£ï¼šå‚™è¨»æ¨™é¡Œæ–‡å­—æ”¾å¤§ä¸€è™Ÿåˆ° 18px (LARGE_FONT_SIZE) */}
                        <strong style={{fontSize: LARGE_FONT_SIZE}}>å‚™è¨»ï¼š</strong><br/>
                        <div style={{ whiteSpace: "pre-wrap", marginTop: 2 }}>{quote.notes}</div>
                    </td>
                    {/* ä»˜æ¬¾æ¢ä»¶å€å¡Š */}
                    <td style={{ ...TH_TD, width: "50%", verticalAlign: "top", fontSize: BASE_FONT_SIZE }}>
                        {/* â­ ä¿®æ­£ï¼šä»˜æ¬¾æ¢ä»¶æ¨™é¡Œæ–‡å­—æ”¾å¤§ä¸€è™Ÿåˆ° 18px (LARGE_FONT_SIZE) */}
                        <strong style={{fontSize: LARGE_FONT_SIZE}}>ä»˜æ¬¾æ¢ä»¶ï¼š</strong><br/>
                        <div style={{ whiteSpace: "pre-wrap", marginTop: 2 }}>{quote.payment}</div>
                    </td>
                </tr>
                </tbody>
            </table>
            
            <table className="print-signature-area" style={{ width: "98%", margin: "10px auto", borderCollapse: "collapse", borderRight: "1px solid #000" }}>
                <tbody>
                <tr>
                    {/* å ±åƒ¹ç« /å›ç°½å€å¡Šç¶­æŒ 16px (BASE_FONT_SIZE) */}
                    <td style={{ ...TH_TD, width: "50%", height: 80, verticalAlign: "top", padding: "5px", borderRight: "1px solid #000", fontSize: BASE_FONT_SIZE }}>
                        <strong>å…¬å¸å ±åƒ¹ç« </strong>
                        {companyInfo.stamp && (
                            <img src={companyInfo.stamp} alt="å…¬å¸å°ç« " style={{ display: "block", margin: "2px auto", maxHeight: 60 }} />
                        )}
                    </td>
                    <td style={{ ...TH_TD, width: "50%", height: 80, verticalAlign: "top", padding: "5px", borderRight: "1px solid #000", fontSize: BASE_FONT_SIZE }}>
                        <strong>å®¢æˆ¶å›ç°½</strong>
                    </td>
                </tr>
                <tr>
                    {/* æ—¥æœŸå€å¡Šç¶­æŒ 16px (BASE_FONT_SIZE) */}
                    <td style={{...TH_TD, borderTop: "none", fontSize: BASE_FONT_SIZE, borderRight: "1px solid #000"}}>æ—¥æœŸï¼š</td>
                    <td style={{...TH_TD, borderTop: "none", fontSize: BASE_FONT_SIZE, borderRight: "1px solid #000"}}>æ—¥æœŸï¼š</td>
                </tr>
                </tbody>
            </table>
        </div>

      </div>
    </div>
  );
}

/* ========================================================
   â˜… æ–°å¢çµ„ä»¶ï¼šå¯¦æ”¯å¯¦ä»˜é›¶ä»¶ç·¨è¼¯å™¨ (LeakagePartsEditor)
   ======================================================== */
function LeakagePartsEditor({ parts, updateQuote }) {
  const handleChange = (id, field, value) => {
    const newParts = parts.map(p => p.id === id ? { ...p, [field]: value } : p);
    updateQuote({ leakageParts: newParts });
  };

  // â­ æ–°å¢ï¼šè™•ç†è¦æ ¼åˆ‡æ›çš„å‡½å¼
  const handleVariantChange = (id, variantLabel) => {
    const targetPart = parts.find(p => p.id === id);
    if (!targetPart || !targetPart.variants) return;

    // æ‰¾åˆ°å°æ‡‰çš„é¸é …è³‡æ–™
    const selectedVariant = targetPart.variants.find(v => v.label === variantLabel);
    if (selectedVariant) {
      // åŒæ™‚æ›´æ–°ï¼šè¦æ ¼ã€å–®åƒ¹ (ä¹Ÿå¯ä»¥é¸æ“‡æ˜¯å¦æ›´æ–°å“åï¼Œé€™è£¡ä¿ç•™åŸå“å)
      const newParts = parts.map(p => p.id === id ? { 
        ...p, 
        spec: selectedVariant.spec, 
        price: selectedVariant.price,
        selectedVariantLabel: variantLabel // ç´€éŒ„ç•¶å‰é¸åˆ°çš„ï¼Œæ–¹ä¾¿ UI é¡¯ç¤º
      } : p);
      updateQuote({ leakageParts: newParts });
    }
  };

  const handleDelete = (id) => {
    if(!window.confirm("ç¢ºå®šåˆªé™¤æ­¤é›¶ä»¶å—ï¼Ÿ")) return;
    const newParts = parts.filter(p => p.id !== id);
    updateQuote({ leakageParts: newParts });
  };

  const handleAdd = () => {
    const newPart = { id: uuid(), name: "", spec: "", unit: "å¼", price: 0 };
    updateQuote({ leakageParts: [...(parts || []), newPart] });
  };

  return (
    <div className="mt-8 mb-6 border-t pt-6 page-break-inside-avoid">
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-bold text-gray-700 border-l-4 border-blue-500 pl-2">
          â€» å¯¦æ”¯å¯¦ä»˜ç¶­ä¿®é›¶ä»¶æ¸…å–®
          <span className="text-sm font-normal text-gray-500 ml-2">(æ­¤å€ä¸è¨ˆå…¥ç¸½å ±åƒ¹)</span>
        </h3>
        <button 
          onClick={handleAdd} 
          className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 shadow flex items-center gap-1"
        >
          <span>ï¼‹</span> æ–°å¢é›¶ä»¶
        </button>
      </div>

      <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
        <div className="grid grid-cols-12 gap-2 text-sm text-gray-500 mb-2 px-2">
           <div className="col-span-4">å“å</div>
           <div className="col-span-4">è¦æ ¼èªªæ˜ (å¯åˆ‡æ›ç‰ˆæœ¬)</div>
           <div className="col-span-1 text-center">å–®ä½</div>
           <div className="col-span-2 text-right">å–®åƒ¹</div>
           <div className="col-span-1"></div>
        </div>

        {(parts || []).map((part, index) => (
          <div key={part.id} className="grid grid-cols-12 gap-2 mb-2 items-center">
             
             {/* 1. å“å */}
             <div className="col-span-4">
                <input 
                  className="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none" 
                  placeholder="è¼¸å…¥é›¶ä»¶åç¨±..."
                  value={part.name} 
                  onChange={(e) => handleChange(part.id, "name", e.target.value)}
                />
             </div>

             {/* 2. è¦æ ¼èªªæ˜ (å¦‚æœæœ‰é¸é …ï¼Œé¡¯ç¤ºä¸‹æ‹‰é¸å–®ï¼›å¦å‰‡é¡¯ç¤ºè¼¸å…¥æ¡†) */}
             <div className="col-span-4">
                {part.variants && part.variants.length > 0 ? (
                  <div className="flex gap-1">
                    {/* ä¸‹æ‹‰é¸å–®å€åŸŸ */}
                    <select
                      className="w-full border p-2 rounded text-sm bg-yellow-50 focus:ring-2 focus:ring-yellow-200 outline-none cursor-pointer text-blue-700 font-bold"
                      value={part.selectedVariantLabel || (part.variants.find(v => v.price === part.price)?.label) || ""}
                      onChange={(e) => handleVariantChange(part.id, e.target.value)}
                    >
                      {part.variants.map((v, i) => (
                        <option key={i} value={v.label}>
                          {v.label} - ${v.price.toLocaleString()}
                        </option>
                      ))}
                    </select>
                  </div>
                ) : (
                  <input 
                    className="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none" 
                    placeholder="è¼¸å…¥è¦æ ¼..."
                    value={part.spec} 
                    onChange={(e) => handleChange(part.id, "spec", e.target.value)}
                  />
                )}
             </div>

             {/* 3. å–®ä½ */}
             <div className="col-span-1">
                <input 
                  className="w-full border p-2 rounded text-sm text-center focus:ring-2 focus:ring-blue-200 outline-none" 
                  value={part.unit} 
                  onChange={(e) => handleChange(part.id, "unit", e.target.value)}
                />
             </div>

             {/* 4. å–®åƒ¹ (å¦‚æœæ˜¯ä¸‹æ‹‰é¸å–®æ¨¡å¼ï¼Œå»ºè­°é–å®šå–®åƒ¹æˆ–è®Šè‰²æç¤º) */}
             <div className="col-span-2">
                <input 
                  type="number"
                  className={`w-full border p-2 rounded text-sm text-right focus:ring-2 focus:ring-blue-200 outline-none font-bold ${part.variants ? 'text-blue-600 bg-gray-50' : 'text-gray-700'}`}
                  value={part.price} 
                  onFocus={(e) => e.target.select()}
                  onChange={(e) => handleChange(part.id, "price", e.target.value)}
                />
             </div>

             {/* 5. åˆªé™¤æŒ‰éˆ• */}
             <div className="col-span-1 text-center">
                <button 
                  onClick={() => handleDelete(part.id)} 
                  className="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition-colors"
                  title="åˆªé™¤"
                >
                  âœ•
                </button>
             </div>
          </div>
        ))}

        {(parts || []).length === 0 && (
            <div className="text-gray-400 text-center py-6 border-2 border-dashed border-gray-200 rounded">
                ç›®å‰æ²’æœ‰é›¶ä»¶é …ç›®ï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ã€‚
            </div>
        )}
      </div>
    </div>
  );
}

/***********************************************************
  // P5 â€” App æ ¹å…ƒä»¶ (å®Œæ•´ä¿®å¾©ç‰ˆ)
 ***********************************************************/
function App() {
  const { 
    quotes, setQuotes, 
    activeQuoteId, setActiveQuoteId,
    company 
  } = React.useContext(AppContext);

  // (1) æ–°å»ºå ±åƒ¹å–®
  const createQuote = React.useCallback((modeId = null) => {
    const mode = MODE_CONFIG.find(m => m.id === modeId) || MODE_CONFIG[0];
    const newQuote = {
      id: uuid(),
      company: company, 
      quoteNo: generateQuoteNo(company),
      title: mode.defaultTitle,
      customerName: "",
      date: formatDate(),
      items: mode.defaultItems.map(item => ({ ...item, id: uuid() })), 
      leakageParts: [], 
      notes: mode.defaultNotes,
      payment: mode.defaultPayment,
      discountPercent: 0,
      negotiatedPrice: 0
    };
    setQuotes(prev => [newQuote, ...prev]);
    setActiveQuoteId(newQuote.id);
  }, [company, setQuotes, setActiveQuoteId]);

  // (2) åˆªé™¤å ±åƒ¹å–®
  const deleteQuote = React.useCallback((id) => {
    setQuotes(prev => prev.filter(q => q.id !== id));
    if (activeQuoteId === id) setActiveQuoteId(null);
  }, [activeQuoteId, setQuotes, setActiveQuoteId]);

  // (3) æ›´æ–°å ±åƒ¹å–®
  const updateQuote = React.useCallback((id, data) => {
    setQuotes(prev => prev.map(q => q.id === id ? { ...q, ...data } : q));
  }, [setQuotes]);

  // (4) è¤‡è£½å ±åƒ¹å–®
  const duplicateQuote = React.useCallback((id) => {
    const sourceQuote = quotes.find(q => q.id === id);
    if (!sourceQuote) return;

    const newQuote = {
      ...JSON.parse(JSON.stringify(sourceQuote)), 
      id: uuid(),                                
      quoteNo: generateQuoteNo(sourceQuote.company), 
      title: `${sourceQuote.title} (å‰¯æœ¬)`,       
      date: formatDate(),                        
      items: sourceQuote.items.map(item => ({ ...item, id: uuid() })),
      leakageParts: (sourceQuote.leakageParts || []).map(part => ({ ...part, id: uuid() }))
    };

    setQuotes(prev => [newQuote, ...prev]);
    setActiveQuoteId(newQuote.id);
  }, [quotes, setQuotes, setActiveQuoteId]);

  // (5) å¥—ç”¨æ¨¡å¼
  const applyMode = React.useCallback((modeId) => {
    if (!activeQuoteId) return;
    const mode = MODE_CONFIG.find(m => m.id === modeId);
    if (!mode) return;
    if (!window.confirm("ç¢ºå®šè¦è¦†è“‹ç•¶å‰å ±åƒ¹å–®å…§å®¹å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;
    const newItems = mode.defaultItems.map(item => ({ ...item, id: uuid() }));
    updateQuote(activeQuoteId, {
      items: newItems,
      leakageParts: [],
      notes: mode.defaultNotes,
      payment: mode.defaultPayment
    });
  }, [activeQuoteId, updateQuote]);

  // UI ä»‹é¢
  return (
    <div className="min-h-screen bg-gray-50 flex print:block print:bg-white">
        {/* å´é‚Šæ¬„ */}
        <div className="w-96 bg-white p-6 shadow-lg flex-shrink-0 text-lg sticky top-0 h-screen overflow-y-auto no-print">
            <h1 className="text-2xl font-extrabold mb-6 text-center text-blue-700">å·¥ç¨‹å ±åƒ¹ç³»çµ±</h1>
            <CompanySelector />
            <ModeSelector applyMode={applyMode} />
            <QuoteList 
                quotes={quotes} 
                activeId={activeQuoteId} 
                selectQuote={setActiveQuoteId} 
                deleteQuote={deleteQuote} 
                duplicateQuote={duplicateQuote} 
            />
        </div>
        {/* ä¸»ç·¨è¼¯å€ */}
        <div className="flex-grow p-8 text-base print:p-0">
            <QuoteEditor updateQuote={updateQuote} />
        </div>
    </div>
  );
}

/***********************************************************
 * P6 â€” React 18 å•Ÿå‹•
 ***********************************************************/
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(
  <AppProvider>
    <App />
  </AppProvider>
);
