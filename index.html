<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- V22 (æœ€çµ‚ç©©å®šç‰ˆ)</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- ReactDOMServerï¼ˆç›®å‰æ²’ç”¨åˆ°ï¼Œä½†ä¿ç•™ï¼Œä¸å½±éŸ¿ï¼‰ -->
    <script src="https://unpkg.com/react-dom@18/umd/react-dom-server.browser.development.js"></script>

    <!-- react-to-printï¼ˆç›®å‰æ²’ç”¨åˆ°ï¼Œä½†ä¿ç•™ï¼Œä¸å‘¼å«å®ƒï¼‰ -->
    <script src="https://unpkg.com/react-to-print/dist/index.umd.js"></script>    

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- XLSXï¼šåŒ¯å‡ºç”¨ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body {
    background: #f3f4f6;
    font-family: "Microsoft JhengHei", sans-serif;
  }

  /* ===== å¯¦æ™‚é è¦½å€ï¼ˆç°åº•ï¼‰ ===== */
  .live-preview-box {
    padding: 40px 0;
    background: #f3f4f6;
  }

  /* ===== A4 ç´™å¼µé è¦½ï¼ˆé‡é»ï¼‰ ===== */
  .print-page {
    width: 794px;              /* A4 å¯¬ */
    min-height: 1123px;        /* A4 é«˜ */
    margin: 0 auto;            /* ç½®ä¸­ */
    background: #ffffff;
    padding: 20px;
    box-shadow: 0 0 12px rgba(0,0,0,0.15);
    box-sizing: border-box;
  }

  /* =========================
     åˆ—å°æ¨£å¼ï¼ˆåœ–ç‰‡ä¸æ¶ˆå¤±ç‰ˆï¼‰
     ========================= */
  @media print {

    body {
      background: #ffffff;
    }

    .live-preview-box {
      padding: 0;
      background: #ffffff;
    }

    .print-page {
      width: auto;
      min-height: auto;
      box-shadow: none;
      padding: 0;
      margin: 0;
    }

    /* ä¸åˆ—å°ç·¨è¼¯ä»‹é¢ */
    .no-print {
      display: none !important;
    }

    /* è¡¨æ ¼è·¨é é‡è¤‡è¡¨é ­ */
    thead {
      display: table-header-group;
    }

    /* åœ–ç‰‡åˆ—å°ä¿è­‰é¡¯ç¤º */
    img {
      display: block !important;
      visibility: visible !important;
      max-width: 100% !important;
      height: auto !important;
      page-break-inside: avoid;
    }

    /* é é¦–ä¸è¢«åˆ‡ */
    .print-header {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    /* å–®ä¸€åˆ—ä¸è¢«åˆ‡ */
    tr {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    /* å°ç« å€ */
    .print-signature-area {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    @page {
      size: A4;
      margin: 15mm;
    }
  }
</style>

</head>

<body class="text-gray-900">
    <div id="root"></div>
    
    <div id="quotePreviewArea">
        <!-- ç›®å‰ä¸ä½¿ç”¨é€™å€‹å€å¡Šåˆ—å°ï¼Œåªä¿ç•™ï¼Œä¸å½±éŸ¿åŠŸèƒ½ -->
    </div>

<script type="text/babel">
/***********************************************************
 * P1 â€” å…¬å¸è³‡æ–™ / å‚™è¨» / ä»˜æ¬¾æ¢ä»¶ / æ¨¡å¼æ¨¡æ¿
 ***********************************************************/
const COMPANY_DATA = {
  herhsin: {
    name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
    taxId: "76380260",  
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
    stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
    prefix: "QH",
  },
  sinchang: {
    name: "è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸",
    taxId: "53896738",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
    stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
    prefix: "QS",
  },
};

const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;

/***********************************************************
 * å ±åƒ¹æ¨¡å¼æ¨¡æ¿ï¼ˆQUOTE_MODESï¼‰
 ***********************************************************/
const QUOTE_MODES = [
  {
    id: "mode_leak_repair",
    name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›å·¥ç¨‹",
    description: "æ‹Œåˆæ©Ÿæ¼æ¼¿ä¿®å¾©ï¼ŒåŒ…å·¥åŒ…æ–™é …ç›®å¦è¨ˆï¼Œé›¶ä»¶å¯¦æ”¯å¯¦ä»˜",

    /* ===============================
     * ä¸€ã€ä¸»è¦å ±åƒ¹é …ç›®ï¼ˆç®—ç¸½åƒ¹ï¼‰
     * =============================== */
    defaultItems: [
      {
        name: "æ›´æ› 3mÂ³ æ‹Œåˆæ©Ÿã€æ¸›é€Ÿæ©Ÿå´ã€‘æ¼æ¼¿ï¼ˆå«å·¥è³‡åŠææ–™ï¼‰",
        unit: "å¼",
        qty: 1,
        price: 0,
        specMain: "å«æ‹†è£ã€èª¿æ•´ã€æ¸¬è©¦",
        specMaterial: "",
        remarks: "",
        type: "main",
        subItems: []
      },
      {
        name: "æ›´æ› 3mÂ³ æ‹Œåˆæ©Ÿã€éæ¸›é€Ÿæ©Ÿå´ã€‘æ¼æ¼¿ï¼ˆå«å·¥è³‡åŠææ–™ï¼‰",
        unit: "å¼",
        qty: 1,
        price: 0,
        specMain: "å«æ‹†è£ã€èª¿æ•´ã€æ¸¬è©¦",
        specMaterial: "",
        remarks: "",
        type: "main",
        subItems: []
      }
    ],

    /* ===============================
     * äºŒã€å¯¦æ”¯å¯¦ä»˜é›¶ä»¶ï¼ˆä¸ç®—ç¸½åƒ¹ï¼‰
     * =============================== */
    referenceItems: [
      {
        name: "é›™é¦¬é”è¯è»¸å™¨å«æ©¡è† åœˆ",
        unit: "çµ„",
        qty: 1,
        type: "reference",
        variants: [
          { key: "de", label: "å¾·è£½", defaultPrice: 58000 },
          { key: "tw", label: "å°è£½", defaultPrice: 30000 }
        ],
        selected: "de",
        price: 58000,
        editablePrice: true,
        remarks: "ä¾å®¢æˆ¶æŒ‡å®šå“ç‰Œæ›´æ›ï¼Œå¯¦æ”¯å¯¦ä»˜"
      },
      {
        name: "è¯è»¸å™¨ç”¨æ©¡è† è£½å“",
        unit: "åª",
        qty: 1,
        type: "reference",
        variants: [
          { key: "de", label: "å¾·è£½", defaultPrice: 9480 },
          { key: "tw", label: "å°è£½", defaultPrice: 2000 }
        ],
        selected: "de",
        price: 9480,
        editablePrice: true,
        remarks: "ä¾å¯¦éš›æ›´æ›æ•¸é‡è¨ˆåƒ¹"
      },

      // ===== ä»¥ä¸‹é›¶ä»¶ç„¡å¾· / å°å·®ç•° =====
      {
        name: "æ¸›é€Ÿæ©Ÿé¬†ç·Šå™¨(çµæ¥èºæ “åŠæ’éŠ·)",
        unit: "å¼",
        qty: 1,
        type: "reference",
        price: 4100,
        editablePrice: true
      },
      {
        name: "æ¸›é€Ÿæ©Ÿæ”¯æ’èª¿æ•´å™¨(åŠæ¼”èºçµ²)",
        unit: "å¼",
        qty: 1,
        type: "reference",
        price: 2500,
        editablePrice: true
      },
      {
        name: "æ²¹å°TC140x180x14",
        unit: "å¼",
        qty: 1,
        type: "reference",
        price: 350,
        editablePrice: true
      },
      {
        name: "è»¸æ‰¿23124",
        unit: "åª",
        qty: 1,
        type: "reference",
        price: 6000,
        editablePrice: true
      },
      {
        name: "ä¸»è»¸å¥—ç­’120x140x120",
        unit: "åª",
        qty: 1,
        type: "reference",
        price: 2600,
        editablePrice: true
      }
    ],

    /* ===============================
     * ä¸‰ã€å›ºå®šå‚™è¨» / ä»˜æ¬¾æ¢ä»¶
     * =============================== */
    defaultNotes: `1. æœ¬å·¥ç¨‹åŒ…å·¥åŒ…æ–™é …ç›®åˆ—å…¥å ±åƒ¹ç¸½é‡‘é¡ã€‚
2. ä¸‹æ–¹åˆ—ç¤ºä¹‹é›¶ä»¶å±¬å¯¦æ”¯å¯¦ä»˜é …ç›®ï¼Œä¸åˆ—å…¥æœ¬æ¬¡å ±åƒ¹ç¸½åƒ¹ã€‚
3. å¯¦éš›æ›´æ›é›¶ä»¶èˆ‡æ•¸é‡ä¾ç¾å ´æ–½å·¥ç‹€æ³ç‚ºæº–ã€‚
4. è‹¥å®¢æˆ¶æŒ‡å®šå“ç‰Œæˆ–è¦æ ¼ï¼Œå°‡ä¾å¯¦éš›ä¾›è²¨å–®åƒ¹èª¿æ•´ã€‚
5. å ±åƒ¹æœ‰æ•ˆæœŸé™ï¼šå ±åƒ¹æ—¥èµ· 30 å¤©`,

    defaultPayment: DEFAULT_PAYMENT
  },

  {
    id: "modeB",
    name: "è¨­å‚™éŠ·å”®",
    description: "é©ç”¨å‚™å“ã€å–®æ©ŸéŠ·å”®èˆ‡å®‰è£ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },

  {
    id: "modeC",
    name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
    description: "é©ç”¨æ•´æ©Ÿæ›´æ–°ã€æ–™ä»¶æ›´æ›å·¥ç¨‹ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  }
];


/***********************************************************
  * P2 â€” å·¥å…·å‡½å¼
 ***********************************************************/
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatDate(dateStr = new Date()) {
    const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
}

function formatMoney(num) {
    if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "0"; 
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
    const qty = Number(item.qty || 0);
    const price = Number(item.price || 0);
    return qty * price;
}

function calcTotal(items) {
    return items.reduce((sum, it) => {
        if (it.type === "reference") return sum; // â­ æ’é™¤å¯¦æ”¯å¯¦ä»˜

        let mainAmt = calcAmount(it);
        let subs = 0;

        if (it.subItems && it.subItems.length > 0) {
            subs = it.subItems.reduce(
                (s, sub) => (sub.type === "item" ? s + calcAmount(sub) : s),
                0
            );
        }

        return sum + mainAmt + subs;
    }, 0);
}

function calcNegotiated(total, discountPercent, customPrice) {
    const cp = Number(customPrice || 0);
    const dp = Number(discountPercent || 0);
    
    if (cp > 0) return cp;
    
    if (dp > 0 && dp <= 100) {
        return Math.round(total * (1 - dp / 100));
    }
    
    return total;
}

function generateQuoteNo(companyKey = "sinchang") {
  const prefix = COMPANY_DATA[companyKey]?.prefix || "QS";

  const d = new Date();
  const yy = String(d.getFullYear()).slice(-2);
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");

  const dateKey = `${yy}${mm}${dd}`; // ä¾‹å¦‚ 251215
  const storageKey = `quote_seq_${companyKey}_${dateKey}`;

  let seq = Number(localStorage.getItem(storageKey) || "0") + 1;

  if (seq > 99) {
    alert("ä»Šæ—¥å ±åƒ¹å–®å·²è¶…é 99 å¼µï¼Œè«‹ç¢ºèª");
    seq = 99;
  }

  localStorage.setItem(storageKey, seq);

  const nn = String(seq).padStart(2, "0");

  // ç¯„ä¾‹ï¼šQS25121501
  return `${prefix}${dateKey}${nn}`;
}


async function loadCSV(url) {
    try {
        const res = await fetch(url);
        const text = await res.text();
        
        const rows = text.split("\n").map(r => r.trim()).filter(r => r.length > 0);
        if (rows.length < 2) return [];
        
        const header = rows[0].split(",").map(h => h.trim().replace(/"/g, ''));

        return rows.slice(1).map(row => {
            const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};

            header.forEach((h, i) => {
                let value = cols[i] ? cols[i].trim() : "";
                if (value.startsWith('"') && value.endsWith('"')) {
                    value = value.substring(1, value.length - 1);
                }
                if (h === "å‚™è¨»") return;
                obj[h] = value;
            });
            return obj;
        });
    } catch (error) {
        console.error("è¼‰å…¥æˆ–è§£æ Google Sheet CSV å¤±æ•—:", error);
        return [];
    }
}

/***********************************************************
  * P3 â€” AppContextï¼ˆè³‡æ–™ä¸­å¿ƒï¼‰
 ***********************************************************/
const AppContext = React.createContext();

function AppProvider({ children }) {
    const [company, setCompany] = React.useState("herhsin");
    const [quotes, setQuotes] = React.useState([]);
    const [activeQuoteId, setActiveQuoteId] = React.useState(null);
    const [specItems, setSpecItems] = React.useState([]);

    const SPEC_CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?output=csv"; 
        

    React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES");

        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                if (Array.isArray(parsed)) {
                    setQuotes(parsed);
                    if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
                }
            } catch (e) {
                console.error("è§£æ localStorage æ•¸æ“šå¤±æ•—:", e);
                setQuotes([]);
                setActiveQuoteId(null);
            }
        }
    }, []);

    React.useEffect(() => {
        try {
            localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
        } catch (e) {
            console.error("å¯«å…¥ localStorage å¤±æ•—:", e);
        }
    }, [quotes]);

    const loadSpecItems = React.useCallback(() => {
        loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
    }, [SPEC_CSV_URL]);

    React.useEffect(() => {
        loadSpecItems();
    }, [loadSpecItems]);

    const createQuote = React.useCallback((modeId = null) => {
    const mode = QUOTE_MODES.find(m => m.id === modeId);

    // âœ… ä¸€å®šè¦å…ˆåœ¨å¤–é¢çµ„ items
    const itemsFromMode = [];

    // ä¸»é …ï¼ˆç®—ç¸½åƒ¹ï¼‰
    if (mode && Array.isArray(mode.defaultItems)) {
        mode.defaultItems.forEach(item => {
            itemsFromMode.push({
                ...item,
                id: uuid(),
                type: "main",
                subItems: [],
                specMain: item.specMain || "",
                specMaterial: "",
                material1: "",
                material2: "",
                material3: "",
                remarks: ""
            });
        });
    }

    // å¯¦æ”¯å¯¦ä»˜ï¼ˆä¸ç®—ç¸½åƒ¹ï¼‰
    if (mode && Array.isArray(mode.referenceItems)) {
        mode.referenceItems.forEach(item => {
            itemsFromMode.push({
                ...item,
                id: uuid(),
                type: "reference",
                subItems: [],
                specMain: "",
                specMaterial: "",
                remarks: item.remarks || ""
            });
        });
    }

    const newQuote = {
        id: uuid(),
        company: company,
        quoteNo: generateQuoteNo(company),
        title: mode ? mode.name : "æœªå‘½åå·¥ç¨‹",
        customerName: "",
        contact: "",
        phone: "",
        location: "",
        date: formatDate(),
        items: itemsFromMode,              // âœ… åªæ”¾çµæœ
        notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
        payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
        discountPercent: 0,
        negotiatedPrice: 0
    };

    setQuotes(prev => {
        const newList = [newQuote, ...prev];
        setActiveQuoteId(newQuote.id);
        return newList;
    });
}, [company]);


    const deleteQuote = React.useCallback((id) => {
        setQuotes(prev => {
            const newList = prev.filter(q => q.id !== id);
            if (id === activeQuoteId) {
                setActiveQuoteId(newList.length > 0 ? newList[0].id : null);
            }
            return newList;
        });
    }, [activeQuoteId]);

    const updateQuote = React.useCallback((id, data) => {
        setQuotes(prev =>
            prev.map(q => (q.id === id ? { ...q, ...data } : q))
        );
    }, []);

    const applyMode = React.useCallback((modeId) => {
        const mode = QUOTE_MODES.find(m => m.id === modeId);
        if (!mode || !activeQuoteId) return;

       const itemsWithIds = [];

// ä¸»é …ï¼ˆç®—ç¸½åƒ¹ï¼‰
if (Array.isArray(mode.defaultItems)) {
    mode.defaultItems.forEach(item => {
        itemsWithIds.push({
            ...item,
            id: uuid(),
            type: "main",
            subItems: [],
            specMain: item.specMain || "",
            specMaterial: "",
            material1: "",
            material2: "",
            material3: "",
            remarks: ""
        });
    });
}

// å¯¦æ”¯å¯¦ä»˜ï¼ˆä¸ç®—ç¸½åƒ¹ï¼‰
if (Array.isArray(mode.referenceItems)) {
    mode.referenceItems.forEach(item => {
        itemsWithIds.push({
            ...item,
            id: uuid(),
            type: "reference",
            subItems: [],
            specMain: "",
            specMaterial: "",
            remarks: item.remarks || ""
        });
    });
}

        updateQuote(activeQuoteId, {
            title: mode.name,
            items: itemsWithIds, 
            notes: mode.defaultNotes,
            payment: mode.defaultPayment,
        });
    }, [activeQuoteId, updateQuote]);

    const activeQuote = quotes.find(q => q.id === activeQuoteId);

    const value = {
        company,
        setCompany,

        quotes,
        createQuote,
        deleteQuote,
        updateQuote,
        activeQuote, 
        activeQuoteId,
        setActiveQuoteId,

        specItems,
        loadSpecItems, 
        applyMode
    };

    window.__APP_CONTEXT__ = value;

    return (
        <AppContext.Provider value={value}>
            {children}
        </AppContext.Provider>
    );
}

/***********************************************************
 * P4-1 â€” å…¬å¸åˆ‡æ› / æ¨¡å¼é¸æ“‡ / å ±åƒ¹å–®åˆ—è¡¨ï¼ˆUI æœ€çµ‚ç‰ˆï¼‰
 ***********************************************************/
function CompanySelector() {
  const { company, setCompany, activeQuote, updateQuote } = React.useContext(AppContext);

  const handleSetCompany = (newCompany) => {
    setCompany(newCompany);
    if (activeQuote) {
      updateQuote(activeQuote.id, {
        company: newCompany,
        quoteNo: generateQuoteNo(newCompany)
      });
    }
  };

  return (
    <div className="mb-8 no-print">
      <div className="text-base font-semibold text-gray-700 mb-3">
        é¸æ“‡å…¬å¸
      </div>

      <div className="flex gap-3">
        <button
          className={`flex-1 px-4 py-2 text-base rounded-md transition ${
            company === "herhsin"
              ? "bg-blue-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => handleSetCompany("herhsin")}
        >
          ä½•é‘«å¯¦æ¥­
        </button>

        <button
          className={`flex-1 px-4 py-2 text-base rounded-md transition ${
            company === "sinchang"
              ? "bg-blue-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => handleSetCompany("sinchang")}
        >
          è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸
        </button>
      </div>
    </div>
  );
}

function ModeSelector() {
  const { createQuote, applyMode } = React.useContext(AppContext);

  const [selectedMode, setSelectedMode] = React.useState("");
  const [isNew, setIsNew] = React.useState(true);

  const handleApply = () => {
    if (!selectedMode) return;
    isNew ? createQuote(selectedMode) : applyMode(selectedMode);
    setSelectedMode("");
  };

  return (
    <div className="mb-8 pb-6 border-b border-gray-300 no-print">
      <div className="text-base font-semibold text-gray-700 mb-3">
        æ¨¡å¼å¥—ç”¨ï¼ˆ{isNew ? "æ–°å»º" : "è¦†è“‹"}ï¼‰
      </div>

      <div className="flex gap-3 mb-4">
        <button
          className={`flex-1 px-4 py-2 text-base rounded-md ${
            isNew
              ? "bg-green-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => setIsNew(true)}
        >
          æ–°å»ºå ±åƒ¹å–®
        </button>

        <button
          className={`flex-1 px-4 py-2 text-base rounded-md ${
            !isNew
              ? "bg-orange-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => setIsNew(false)}
        >
          å¥—ç”¨è‡³ç•¶å‰
        </button>
      </div>

      <select
        className="w-full border px-3 py-2 mb-4 rounded-md text-base"
        value={selectedMode}
        onChange={e => setSelectedMode(e.target.value)}
      >
        <option value="" disabled>è«‹é¸æ“‡å ±åƒ¹æ¨¡å¼</option>
        {QUOTE_MODES.map(mode => (
          <option key={mode.id} value={mode.id}>
            {mode.name} â€” {mode.description}
          </option>
        ))}
      </select>

      <button
        className="w-full bg-blue-600 text-white py-2.5 rounded-md text-base hover:bg-blue-700 disabled:opacity-50"
        onClick={handleApply}
        disabled={!selectedMode}
      >
        {isNew ? "æ–°å»ºå ±åƒ¹å–®ä¸¦å¥—ç”¨æ¨¡å¼" : "å¥—ç”¨æ¨¡å¼è‡³ç•¶å‰å ±åƒ¹å–®"}
      </button>
    </div>
  );
}

/* å ±åƒ¹å–®åˆ—è¡¨ï¼ˆå·¦å´ä¸»æˆ°å€ï¼‰ */
function QuoteList() {
  const { quotes, activeQuoteId, setActiveQuoteId, createQuote, deleteQuote } = React.useContext(AppContext);

  return (
    <div className="no-print">
      <div className="flex justify-between items-center mb-3">
        <div className="text-base font-semibold text-gray-700">
          å ±åƒ¹å–®åˆ—è¡¨
        </div>
        <button
          className="text-sm px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700"
          onClick={() => createQuote(null)}
        >
          + æ–°å»ºç©ºç™½
        </button>
      </div>

      <div className="space-y-3 max-h-[420px] overflow-y-auto">
        {quotes.length === 0 && (
          <div className="text-gray-400 text-sm">
            å°šç„¡å ±åƒ¹å–®ï¼Œè«‹å…ˆæ–°å»ºã€‚
          </div>
        )}

        {quotes.map(q => (
          <div
            key={q.id}
            className={`p-3 rounded-md border cursor-pointer flex justify-between items-start transition ${
              q.id === activeQuoteId
                ? "bg-blue-50 border-blue-400"
                : "bg-white hover:bg-gray-50"
            }`}
            onClick={() => setActiveQuoteId(q.id)}
          >
            <div className="text-sm">
              <div className="font-semibold mb-0.5">
                {q.title || "æœªå‘½åå·¥ç¨‹"}
              </div>
              <div className="text-gray-500">
                {q.quoteNo}
              </div>
              {q.customerName && (
                <div className="text-gray-500">
                  å®¢æˆ¶ï¼š{q.customerName}
                </div>
              )}
            </div>

            <button
              className="ml-2 text-sm text-red-600 hover:text-red-800"
              onClick={(e) => {
                e.stopPropagation();
                if (window.confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å ±åƒ¹å–®ï¼Ÿ")) {
                  deleteQuote(q.id);
                }
              }}
            >
              åˆªé™¤
            </button>
          </div>
        ))}
      </div>
    </div>
  );
}

/***********************************************************
 * P4-2 â€” å–®ä¸€å ±åƒ¹é …ç›®ç·¨è¼¯ï¼ˆæ”¾å¤§å­—ç´šç‰ˆï¼‰
 ***********************************************************/
function QuoteItem({ item, index, updateItem, deleteItem }) {
  const { specItems } = React.useContext(AppContext);
  const [showSub, setShowSub] = React.useState(true);

  const handleChange = (field, value) => {
    updateItem({ [field]: value });
  };

  /* ===== æ–°å¢å­é …ï¼šæ–‡å­— ===== */
  const handleAddSubText = () => {
    const newSub = {
      id: uuid(),
      type: "text",
      name: "",
      remarks: ""
    };
    updateItem({ subItems: [...(item.subItems || []), newSub] });
  };

  /* ===== æ–°å¢å­é …ï¼šåœ–ç‰‡ ===== */
  const handleAddSubImage = (file) => {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const newSub = {
        id: uuid(),
        type: "image",
        name: "",
        imageData: reader.result
      };
      updateItem({ subItems: [...(item.subItems || []), newSub] });
    };
    reader.readAsDataURL(file);
  };

  return (
    /* ğŸ”‘ é—œéµï¼šåœ¨æœ€å¤–å±¤è¨­å®šåŸºæº–å­—ç´š text-lg */
    <div className="mb-8 border rounded-xl bg-white shadow-md p-6 text-lg leading-relaxed">

      {/* ===== é …æ¬¡æ¨™é¡Œåˆ— ===== */}
      <div className="flex justify-between items-center mb-4">
        <div className="text-xl font-bold text-blue-700">
          é …æ¬¡ {index + 1}ï¼š{item.name || "æœªå‘½å"}
        </div>
        <div className="flex gap-2">
          <button
            className="px-3 py-1 border rounded text-base"
            onClick={() => setShowSub(!showSub)}
          >
            {showSub ? "æ”¶åˆ" : "å±•é–‹"}
          </button>
          <button
            className="px-3 py-1 bg-red-500 text-white rounded text-base"
            onClick={() => deleteItem(item.id)}
          >
            åˆªé™¤æ­¤é …
          </button>
        </div>
      </div>

      {/* ===== ä¸»æ¬„ä½ ===== */}
      <div className="grid grid-cols-4 gap-6">

  {/* å“å */}
  <div className="col-span-1">
    <label className="block text-base font-semibold text-gray-700 mb-1">
      å“å
    </label>
    <input
      type="text"
      list={`spec-list-${item.id}`}
      className="w-full border rounded-lg px-3 py-2"
      value={item.name || ""}
      onChange={(e) => {
        const value = e.target.value;
        handleChange("name", value);

        const matched = specItems.find(
          r => (r["å“å"] || "") === value
        );

        if (matched) {
          const materials = [
            matched["ç”¨æ–™1"],
            matched["ç”¨æ–™2"],
            matched["ç”¨æ–™3"]
          ]
            .filter(v => typeof v === "string" && v.trim() !== "")
            .join("ã€");

          updateItem({
            name: matched["å“å"] || "",
            unit: matched["å–®ä½"] || "",
            price: Number(matched["å–®åƒ¹"] || 0),
            specMain: matched["è¦æ ¼"] || "",
            specMaterial: materials
          });
        }
      }}
    />

    <datalist id={`spec-list-${item.id}`}>
      {specItems.map((r, i) => (
        <option key={i} value={r["å“å"] || ""}>
          {r["è¦æ ¼"] ? `(${r["è¦æ ¼"]})` : ""}
        </option>
      ))}
    </datalist>
  </div>

  {/* è¦æ ¼èªªæ˜ï¼ˆæ”¾å³é‚Šï¼‰ */}
  <div className="col-span-3">
    <label className="block text-base font-semibold text-gray-700 mb-1">
      è¦æ ¼èªªæ˜
    </label>
    <textarea
     className="w-full border rounded-lg px-3 py-2"
      rows="2"
      value={item.specMain || ""}
      onChange={(e) => handleChange("specMain", e.target.value)}
    />
  </div>

        <div>
          <label className="block text-base font-semibold text-gray-700 mb-1">å–®ä½</label>
          <input
            className="w-full border rounded-lg px-3 py-2"
            value={item.unit || ""}
            onChange={(e) => handleChange("unit", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-base font-semibold text-gray-700 mb-1">æ•¸é‡</label>
          <input
            type="number"
            className="w-full border rounded-lg px-3 py-2 text-right"
            value={item.qty}
            onChange={(e) => handleChange("qty", Number(e.target.value))}
          />
        </div>

        <div>
  {/* â­ å¾·è£½ / å°è£½ï¼ˆåªæœ‰æœ‰ variants æ‰é¡¯ç¤ºï¼‰ */}
  {Array.isArray(item.variants) && (
    <>
      <label className="block text-base font-semibold text-gray-700 mb-1">
        å“ç‰Œ / ç”¢åœ°
      </label>

      <select
        className="w-full border rounded-lg px-3 py-2 mb-2"
        value={item.selected}
        onChange={(e) => {
          const selectedKey = e.target.value;
          const variant = item.variants.find(v => v.key === selectedKey);

          updateItem({
            selected: selectedKey,
            price: variant ? variant.defaultPrice : item.price
          });
        }}
      >
        {item.variants.map(v => (
          <option key={v.key} value={v.key}>
            {v.label}
          </option>
        ))}
      </select>
    </>
  )}

  {/* åŸæœ¬çš„å–®åƒ¹ï¼ˆä¿ç•™ï¼Œå¯æ‰‹å‹•æ”¹ï¼‰ */}
  <label className="block text-base font-semibold text-gray-700 mb-1">
    å–®åƒ¹
  </label>
  <input
    type="number"
    className="w-full border rounded-lg px-3 py-2 text-right"
    value={item.price}
    onChange={(e) => handleChange("price", Number(e.target.value))}
  />
</div>>

        <div>
          <label className="block text-base font-semibold text-gray-700 mb-1">å°è¨ˆ</label>
          <div className="w-full border rounded-lg px-3 py-2 bg-gray-100 text-right font-semibold">
            {formatMoney(calcAmount(item))}
          </div>
        </div>


        <div className="col-span-4">
          <label className="block text-base font-semibold text-gray-700 mb-1">
            ç”¨æ–™æ˜ç´°ï¼ˆå¯ä¿®æ”¹ï¼‰
          </label>
          <textarea
            className="w-full border rounded-lg px-3 py-2"
            rows="2"
            value={item.specMaterial || ""}
            onChange={(e) => handleChange("specMaterial", e.target.value)}
          />
        </div>

        <div className="col-span-4">
          <label className="block text-base font-semibold text-gray-700 mb-1">å‚™è¨»</label>
          <textarea
            className="w-full border rounded-lg px-3 py-2"
            rows="2"
            value={item.remarks || ""}
            onChange={(e) => handleChange("remarks", e.target.value)}
          />
        </div>
      </div>

      {/* ===== å­é …ç›® ===== */}
      {showSub && (
        <div className="mt-4 border-t pt-4">
          <div className="flex gap-3">
            <button
              className="px-4 py-2 bg-gray-200 rounded-lg text-base"
              onClick={handleAddSubText}
            >
              ï¼‹ è£œå……æ–‡å­—
            </button>

            <label className="px-4 py-2 bg-gray-200 rounded-lg cursor-pointer text-base">
              ï¼‹ è£œå……åœ–ç‰‡
              <input
                type="file"
                accept="image/*"
                className="hidden"
                onChange={(e) => handleAddSubImage(e.target.files[0])}
              />
            </label>
          </div>
        </div>
      )}
    </div>
  );
}

/***********************************************************
  * P4-3 â€” QuoteEditor / ExportButton / PrintButton / PrintLayout
 ***********************************************************/
// å ±åƒ¹å–®ç·¨è¼¯ä¸»å…ƒä»¶
function QuoteEditor() {
    // âœ… æ‰€æœ‰ Hooks ä¸€å®šè¦åœ¨æœ€å‰é¢
    const { activeQuote, updateQuote } = React.useContext(AppContext);
    const componentRef = React.useRef(null);

    // âœ… Hook å®£å‘Šå®Œï¼Œæ‰èƒ½ return
    if (!activeQuote) {
        return (
            <div className="p-8 text-center text-gray-500 text-xl">
                è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹å ±åƒ¹å–®æˆ–æ–°å»ºä¸€å€‹å ±åƒ¹å–®ã€‚
            </div>
        );
    }
    
 
    
    const handleChange = (field, value) => {
        updateQuote(activeQuote.id, { [field]: value });
    };

    const handleUpdateItem = (itemId, data) => {
        const newItems = activeQuote.items.map(item => 
            item.id === itemId ? { ...item, ...data } : item
        );
        updateQuote(activeQuote.id, { items: newItems });
    };

    const handleDeleteItem = (itemId) => {
        const newItems = activeQuote.items.filter(item => item.id !== itemId);
        updateQuote(activeQuote.id, { items: newItems });
    };

    const handleAddItem = () => {
        const newItem = {
            id: uuid(),
            name: "", 
            specMain: "",
            unit: "å¼",
            qty: 1,
            price: 0,
            subItems: [],
            remarks: "",
            specMaterial: ""
        };
        updateQuote(activeQuote.id, { items: [...activeQuote.items, newItem] });
    };
    
    const totalAmount = calcTotal(activeQuote.items);
    
    const negotiatedAmount = calcNegotiated(
        totalAmount,
        activeQuote.discountPercent,
        activeQuote.negotiatedPrice
    );

   return (
  <div className="quote-editor-root-container text-lg">
    {/* ç·¨è¼¯å€ */}
    <div className="p-8 bg-gray-100 rounded-xl shadow-xl no-print">

      {/* ===== æ¨™é¡Œ ===== */}
      <h1 className="text-3xl font-bold mb-6 border-b pb-3">
        ç·¨è¼¯å ±åƒ¹å–®ï¼š{activeQuote.title || "æœªå‘½å"}
      </h1>

      {/* ===== å ±åƒ¹å–®åŸºæœ¬è³‡æ–™ï¼ˆè¡¨é ­å¡ï¼‰ ===== */}
      <div className="bg-slate-50 p-6 rounded-xl mb-8 grid grid-cols-2 gap-x-6 gap-y-4 shadow-inner text-lg">

        <div className="col-span-2 flex items-center">
          <label className="font-semibold w-1/4 text-gray-700">å ±åƒ¹å–®ç·¨è™Ÿ</label>
          <div className="text-xl font-mono text-blue-700">
            {activeQuote.quoteNo}
          </div>
        </div>

        <div className="col-span-2">
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            å·¥ç¨‹åç¨± / æ¨™é¡Œ
          </label>
          <input
            type="text"
            value={activeQuote.title}
            onChange={(e) => handleChange("title", e.target.value)}
            className="w-full border rounded-lg px-3 py-2 text-base"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            å®¢æˆ¶åç¨±
          </label>
          <input
            type="text"
            value={activeQuote.customerName}
            onChange={(e) => handleChange("customerName", e.target.value)}
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            è¯çµ¡äºº
          </label>
          <input
            type="text"
            value={activeQuote.contact}
            onChange={(e) => handleChange("contact", e.target.value)}
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            è¯çµ¡é›»è©±
          </label>
          <input
            type="text"
            value={activeQuote.phone}
            onChange={(e) => handleChange("phone", e.target.value)}
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            å ±åƒ¹æ—¥æœŸ
          </label>
          <input
            type="date"
            value={activeQuote.date}
            onChange={(e) => handleChange("date", e.target.value)}
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        <div className="col-span-2">
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            å·¥ç¨‹åœ°é»
          </label>
          <input
            type="text"
            value={activeQuote.location}
            onChange={(e) => handleChange("location", e.target.value)}
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        {/* ===== é‡‘é¡æ‘˜è¦ ===== */}
        <div className="col-span-2 mt-4 p-4 bg-blue-100 rounded-lg">
          <div className="text-2xl font-bold text-blue-900">
            ç¸½è¨ˆé‡‘é¡ï¼ˆæœªç¨…ï¼‰ï¼šNT$ {formatMoney(totalAmount)}
          </div>
        </div>

        <div className="col-span-2 grid grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-1">
              æŠ˜æ‰£ç™¾åˆ†æ¯”ï¼ˆ%ï¼‰
            </label>
            <input
              type="number"
              value={activeQuote.discountPercent}
              onChange={(e) =>
                handleChange("discountPercent", Number(e.target.value))
              }
              className="w-full border rounded-lg px-3 py-2"
            />
          </div>

          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-1">
              æœ€çµ‚å ±åƒ¹ï¼ˆè‡ªå®šç¾©ï¼‰
            </label>
            <input
              type="number"
              value={activeQuote.negotiatedPrice}
              onChange={(e) =>
                handleChange("negotiatedPrice", Number(e.target.value))
              }
              className="w-full border rounded-lg px-3 py-2"
            />
          </div>
        </div>

        <div className="col-span-2 mt-2 p-4 bg-red-100 rounded-lg border-l-4 border-red-500">
          <div className="text-2xl font-bold text-red-800">
            æœ€çµ‚å ±åƒ¹é‡‘é¡ï¼ˆæœªç¨…ï¼‰ï¼šNT$ {formatMoney(negotiatedAmount)}
          </div>
        </div>
      </div>

      {/* ===== å ±åƒ¹é …ç›®åˆ—è¡¨ ===== */}
      <h2 className="text-2xl font-bold mt-10 mb-4 border-b pb-2">
        å ±åƒ¹é …ç›®åˆ—è¡¨
      </h2>

      <button
        className="bg-green-600 text-white px-5 py-2 rounded-lg mb-6 hover:bg-green-700 text-base"
        onClick={handleAddItem}
      >
        ï¼‹ æ–°å¢å·¥ç¨‹å¤§é …
      </button>

      <div className="quote-items-container space-y-6">
        {activeQuote.items.map((item, index) => (
          <QuoteItem
            key={item.id}
            item={item}
            index={index}
            updateItem={(data) => handleUpdateItem(item.id, data)}
            deleteItem={handleDeleteItem}
          />
        ))}
      </div>

      {/* ===== å‚™è¨» / ä»˜æ¬¾æ¢ä»¶ ===== */}
      <div className="mt-10 grid grid-cols-2 gap-8">
        <div>
          <h3 className="font-bold text-lg mb-2">å‚™è¨»ï¼ˆä¸å«ç¨…ï¼‰</h3>
          <textarea
            value={activeQuote.notes}
            onChange={(e) => handleChange("notes", e.target.value)}
            rows="8"
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        <div>
          <h3 className="font-bold text-lg mb-2">ä»˜æ¬¾æ¢ä»¶</h3>
          <textarea
            value={activeQuote.payment}
            onChange={(e) => handleChange("payment", e.target.value)}
            rows="8"
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>
      </div>

      {/* ===== åŒ¯å‡º / åˆ—å° ===== */}
      <div className="mt-10 pt-6 border-t flex gap-4 justify-end">
  <ExportButton />
  <ExportWordButton componentRef={componentRef} />
  <PrintButton componentRef={componentRef} />
     </div>

      {/* ===== å³æ™‚é è¦½ ===== */}
      <div className="live-preview-box mt-12">
        <h3 className="text-center font-bold text-2xl text-blue-700 mb-6">
          å¯¦æ™‚é è¦½å€ï¼ˆéåˆ—å°å°ºå¯¸ï¼‰
        </h3>
        <div className="print-page">
          <PrintLayout
            quote={activeQuote}
            totalAmount={totalAmount}
            negotiatedAmount={negotiatedAmount}
            isPreview={true}
          />
        </div>
      </div>
    </div>

    {/* åˆ—å°å°ˆç”¨éš±è—å€ */}
    <div
      ref={componentRef}
      className="print-only-layout"
      style={{ position: "absolute", top: -9999, left: -9999 }}
    >
      <PrintLayout
        quote={activeQuote}
        totalAmount={totalAmount}
        negotiatedAmount={negotiatedAmount}
        isPreview={false}
      />
    </div>
  </div>
);
} 

// ===============================
// Excel åŒ¯å‡ºï¼ˆæ–¹æ¡ˆ Aï¼šå ±åƒ¹å–®ç‰ˆå‹ï¼‰
// ===============================
function ExportButton() {
  const { activeQuote } = React.useContext(AppContext);

  const handleExport = () => {
    if (!activeQuote || !activeQuote.items?.length) {
      alert("è«‹å…ˆæ–°å¢å ±åƒ¹é …ç›®");
      return;
    }

    const companyKey = activeQuote.company || "herhsin";
    const company = COMPANY_DATA[companyKey];

    const total = calcTotal(activeQuote.items);
    const negotiated = calcNegotiated(
      total,
      activeQuote.discountPercent,
      activeQuote.negotiatedPrice
    );

    const rows = [];
    let r = 0;

    // ===== æ¨™é¡Œ =====
    rows[r++] = [company.name];
    rows[r++] = ["å·¥ç¨‹å ±åƒ¹å–®"];
    rows[r++] = [];

    // ===== åŸºæœ¬è³‡æ–™ =====
    rows[r++] = ["å ±åƒ¹å–®è™Ÿ", activeQuote.quoteNo, "", "", "å ±åƒ¹æ—¥æœŸ", activeQuote.date];
    rows[r++] = ["å·¥ç¨‹åç¨±", activeQuote.title];
    rows[r++] = ["å®¢æˆ¶åç¨±", activeQuote.customerName, "", "è¯çµ¡äºº", activeQuote.contact];
    rows[r++] = ["å·¥ç¨‹åœ°é»", activeQuote.location];
    rows[r++] = [];

    // ===== è¡¨é ­ =====
    rows[r++] = [
      "é …æ¬¡",
      "å“å",
      "è¦æ ¼ / è£œå……å…§å®¹",
      "å–®ä½",
      "æ•¸é‡",
      "å–®åƒ¹",
      "é‡‘é¡(å°è¨ˆ)",
      "å‚™è¨»",
      "ç”¨æ–™æ˜ç´°"
    ];

    // ===== æ˜ç´° =====
    let index = 1;
    activeQuote.items.forEach(item => {
      rows[r++] = [
        index++,
        item.name || "",
        item.specMain || "",
        item.unit || "",
        item.qty || "",
        item.price || "",
        calcAmount(item),
        item.remarks || "",
        item.specMaterial || ""
      ];

      (item.subItems || []).forEach(sub => {
        if (sub.type === "text") {
          rows[r++] = [
            "",
            `è£œå……ï¼š${sub.name || ""}`,
            sub.remarks || "",
            "",
            "",
            "",
            "",
            "",
            ""
          ];
        }
        if (sub.type === "image") {
          rows[r++] = [
            "",
            "è£œå……åœ–ç‰‡",
            "ï¼ˆåœ–ç‰‡è«‹åƒè€ƒåˆ—å°ç‰ˆï¼‰",
            "",
            "",
            "",
            "",
            "",
            ""
          ];
        }
      });
    });

    rows[r++] = [];
    rows[r++] = ["", "", "", "", "", "ç¸½è¨ˆ", total];
    rows[r++] = ["", "", "", "", "", "æŠ˜æ‰£(%)", activeQuote.discountPercent || 0];
    rows[r++] = ["", "", "", "", "", "æœ€çµ‚å ±åƒ¹", negotiated];
    rows[r++] = [];
    rows[r++] = ["å‚™è¨»"];
    rows[r++] = [activeQuote.notes || ""];
    rows[r++] = [];
    rows[r++] = ["ä»˜æ¬¾æ¢ä»¶"];
    rows[r++] = [activeQuote.payment || ""];

    // ===== ç”¢ç”Ÿ Sheet =====
    const ws = XLSX.utils.aoa_to_sheet(rows);

    // ===== åˆä½µå„²å­˜æ ¼ =====
    ws["!merges"] = [
      { s: { r: 0, c: 0 }, e: { r: 0, c: 8 } }, // å…¬å¸
      { s: { r: 1, c: 0 }, e: { r: 1, c: 8 } }, // å·¥ç¨‹å ±åƒ¹å–®
      { s: { r: 4, c: 1 }, e: { r: 4, c: 8 } },
      { s: { r: 5, c: 1 }, e: { r: 5, c: 8 } },
      { s: { r: rows.length - 6, c: 0 }, e: { r: rows.length - 6, c: 8 } },
      { s: { r: rows.length - 4, c: 0 }, e: { r: rows.length - 4, c: 8 } }
    ];

    // ===== æ¬„å¯¬ =====
    ws["!cols"] = [
  { wch: 12 },  // Aï¼šé …æ¬¡ / æ¨™é¡Œ
  { wch: 26 },  // å“å
  { wch: 42 },  // è¦æ ¼ / è£œå……
  { wch: 8 },   // å–®ä½
  { wch: 8 },   // æ•¸é‡
  { wch: 16 },  // å–®åƒ¹
  { wch: 18 },  // å°è¨ˆ
  { wch: 22 },  // å‚™è¨»
  { wch: 32 }   // ç”¨æ–™
];

    // ===== æ•¸å­—æ ¼å¼ =====
    Object.keys(ws).forEach(key => {
      if (ws[key]?.v && typeof ws[key].v === "number") {
        ws[key].z = "#,##0";
      }
    });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®");

    const filename = `${activeQuote.quoteNo}_${
  activeQuote.customerName || "æœªå¡«å®¢æˆ¶"
}-${activeQuote.title || "æœªå‘½åå·¥ç¨‹"} å ±åƒ¹å–®.xlsx`.replace(
      /[\\/:*?"<>|]/g,
      ""
    );
    XLSX.writeFile(wb, filename);
  };

  return (
    <button
      onClick={handleExport}
      className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
    >
      åŒ¯å‡º Excelï¼ˆå ±åƒ¹å–®ç‰ˆå‹ï¼‰
    </button>
  );
}
// ===============================
// Word åŒ¯å‡ºï¼ˆæ­£å¼å ±åƒ¹å–®ï½œèˆ‡é è¦½ä¸€è‡´ï¼‰
// ===============================
function ExportWordButton({ componentRef }) {
  const { activeQuote, company } = React.useContext(AppContext);

  const handleExportWord = () => {
    if (!componentRef?.current || !activeQuote) {
      alert("æ‰¾ä¸åˆ°å ±åƒ¹å–®å…§å®¹ï¼Œè«‹ç¢ºèªé è¦½å·²è¼‰å…¥");
      return;
    }

    // åªå–é è¦½å…§å®¹ï¼ˆä¸å«å¤–å±¤ UIï¼‰
    const htmlContent = componentRef.current.innerHTML;

    // Word å°ˆç”¨ HTMLï¼ˆå®Œæ•´è‡ªåŒ…ç‰ˆå‹ï¼‰
    const wordHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å·¥ç¨‹å ±åƒ¹å–®</title>

  <style>
    @page {
      size: A4;
      margin: 15mm;
    }

    body {
      margin: 0;
      padding: 0;
    }

    /* === Word å°ˆç”¨ A4 å®¹å™¨ï¼ˆç­‰åŒé è¦½çš„ print-pageï¼‰ === */
    .word-page {
      width: 794px;            /* A4 è¦–è¦ºå¯¬ */
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
      font-family: "Microsoft JhengHei", sans-serif;
      font-size: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid #000;
      padding: 6px;
      font-size: 15px;
      vertical-align: top;
    }

    img {
      display: block;
      margin: 10px auto;
      height: 70px;     /* â­ é–æ­»å°ç« é«˜åº¦ï¼Œé¿å… Word æ”¾å¤§ */
      width: auto;
    }
  </style>
</head>

<body>
  <div class="word-page">
    ${htmlContent}
  </div>
</body>
</html>
    `;

    // æª”åè¦å‰‡ï¼ˆèˆ‡ Excel ä¸€è‡´ï¼‰
    const filename = `${activeQuote.quoteNo}_${
      activeQuote.customerName || "æœªå¡«å®¢æˆ¶"
    }-${activeQuote.title || "æœªå‘½åå·¥ç¨‹"} å ±åƒ¹å–®.doc`
      .replace(/[\\/:*?"<>|]/g, "");

    const blob = new Blob(
      ["\ufeff", wordHTML],
      { type: "application/msword;charset=utf-8" }
    );

    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <button
      onClick={handleExportWord}
      className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"
    >
      åŒ¯å‡º Wordï¼ˆå ±åƒ¹å–®ç‰ˆå‹ï¼‰
    </button>
  );
}


/***********************************************************
  * åˆ—å°æ’ç‰ˆçµ„ä»¶ï¼ˆPrintLayoutï¼‰â€” å®Œæ•´ç©©å®šç‰ˆ
  *âœ” å«ï¼šç”¨æ–™æ˜ç´°ç¨ç«‹è¡Œ / å‚™è¨» / ä»˜æ¬¾æ¢ä»¶ / ç°½åå°ç« 
 ***********************************************************/
function PrintLayout({ quote, totalAmount, negotiatedAmount, isPreview }) {
  if (!quote || !quote.company || !COMPANY_DATA[quote.company]) {
    return (
      <div style={{ textAlign: "center", padding: 20, color: "#888" }}>
        è«‹é¸æ“‡æˆ–æ–°å¢å ±åƒ¹å–®ä»¥é¡¯ç¤ºé è¦½
      </div>
    );
  }

  const companyInfo = COMPANY_DATA[quote.company];

  /* ========= å…±ç”¨æ¨£å¼ ========= */
  const TH_TD_STYLE = {
    border: "1px solid #000",
    padding: "6px",
    verticalAlign: "top",
    fontSize: "13px"
  };

  const TH_STYLE = {
    ...TH_TD_STYLE,
    background: "#f0f0f0",
    fontWeight: "bold",
    textAlign: "center"
  };

  const TD_RIGHT = {
    ...TH_TD_STYLE,
    textAlign: "right"
  };

  /* ========= é‡‘é¡æ‘˜è¦ ========= */
  const TotalSummary = () => {
    const hasDiscount =
      Number(quote.discountPercent) > 0 ||
      Number(quote.negotiatedPrice) > 0;

    return (
      <table style={{ width: "100%", borderCollapse: "collapse", marginTop: 10 }}>
        <tbody>
          <tr>
            <td colSpan={6} style={{ ...TD_RIGHT, fontWeight: "bold" }}>
              ç¸½è¨ˆé‡‘é¡ï¼ˆæœªç¨…ï¼‰
            </td>
            <td style={{ ...TD_RIGHT, fontWeight: "bold", color: "blue" }}>
              {formatMoney(totalAmount)}
            </td>
          </tr>

          {hasDiscount && (
            <tr>
              <td colSpan={6} style={{ ...TD_RIGHT, fontWeight: "bold" }}>
                æœ€çµ‚å ±åƒ¹é‡‘é¡ï¼ˆæœªç¨…ï¼‰
              </td>
              <td
                style={{
                  ...TD_RIGHT,
                  fontWeight: "bold",
                  color: "red",
                  fontSize: "16px"
                }}
              >
                {formatMoney(negotiatedAmount)}
              </td>
              <td style={TH_TD_STYLE}></td>
            </tr>
          )}
        </tbody>
      </table>
    );
  };

  /* ========= å“é …åˆ—ï¼ˆå”¯ä¸€ç‰ˆæœ¬ï¼‰ ========= */
  const renderPrintItem = (item, index) => {
    const rows = [];

    /* ===== ä¸»åˆ—ï¼šåªé¡¯ç¤ºè¦æ ¼ ===== */
    rows.push(
      <tr key={item.id}>
        <td style={{ ...TH_TD_STYLE, textAlign: "center" }}>{index}</td>
        <td style={TH_TD_STYLE}>{item.name || ""}</td>
        <td style={TH_TD_STYLE}>{item.specMain || ""}</td>
        <td style={{ ...TH_TD_STYLE, textAlign: "center" }}>{item.unit}</td>
        <td style={{ ...TH_TD_STYLE, textAlign: "center" }}>{item.qty}</td>
        <td style={TD_RIGHT}>{formatMoney(item.price)}</td>
        <td style={{ ...TD_RIGHT, fontWeight: "bold" }}>
          {formatMoney(calcAmount(item))}
        </td>
        <td style={TH_TD_STYLE}>{item.remarks || ""}</td>
      </tr>
    );

/* ===== ç”¨æ–™æ˜ç´°ï¼ˆæ•´åˆ specMaterial / material1~3ï¼‰ ===== */
const materialText = [
  item.specMaterial,
  item.material1,
  item.material2,
  item.material3
]
  .filter(v => typeof v === "string" && v.trim() !== "")
  .join("ã€");

if (materialText.length > 0) {
  rows.push(
    <tr key={item.id + "-material"}>
      {/* é …æ¬¡ï¼š1-1 */}
      <td style={{ ...TH_TD_STYLE, textAlign: "center" }}>
        {index}-1
      </td>

      {/* å“å */}
      <td style={TH_TD_STYLE}>
        ç”¨æ–™æ˜ç´°
      </td>

      {/* å…§å®¹ï¼ˆåˆä½µè¦æ ¼~å‚™è¨»æ¬„ï¼‰ */}
      <td
        colSpan={6}
        style={{
          ...TH_TD_STYLE,
          background: "#fafafa",
          fontSize: "12px"
        }}
      >
        <span style={{ whiteSpace: "pre-wrap" }}>
          {materialText}
        </span>
      </td>
    </tr>
  );
}

    /* ===== è£œå……é …ç›® ===== */
    (item.subItems || []).forEach(sub => {
      if (sub.type === "text" && sub.remarks) {
        rows.push(
          <tr key={sub.id}>
            <td colSpan={8} style={TH_TD_STYLE}>
              <strong>è£œå……èªªæ˜ï¼š</strong>
              <div style={{ whiteSpace: "pre-wrap" }}>{sub.remarks}</div>
            </td>
          </tr>
        );
      }

      if (sub.type === "image" && sub.imageData) {
        rows.push(
          <tr key={sub.id}>
            <td colSpan={8} style={{ ...TH_TD_STYLE, textAlign: "center" }}>
              <img
                src={sub.imageData}
                alt="è£œå……åœ–ç‰‡"
                style={{
                  display: "block",
                  margin: "0 auto",
                  maxWidth: "90%",
                  maxHeight: 250,
                  border: "1px solid #000"
                }}
              />
            </td>
          </tr>
        );
      }
    });

    return rows;
  };

  return (
    <div className="print-page">
      {/* ===== é é¦– ===== */}
      <div style={{ textAlign: "center", marginBottom: 16 }}>

  {/* å…¬å¸åç¨±ï¼ˆæ”¾å¤§ï¼‰ */}
  <h2 style={{ margin: 0, fontSize: 24, fontWeight: "bold" }}>
    {companyInfo.name}
  </h2>

  {/* å…¬å¸è³‡æ–™ï¼ˆç¨å¾®æ”¾å¤§ï¼‰ */}
  <div style={{ fontSize: 14, marginTop: 4 }}>
    çµ±ç·¨ {companyInfo.taxId} ï½œ é›»è©± {companyInfo.tel} ï½œ å‚³çœŸ {companyInfo.fax}
  </div>

  <div style={{ fontSize: 14 }}>
    {companyInfo.address}
  </div>

  {/* å ±åƒ¹å–®æ¨™é¡Œï¼ˆå†æ”¾å¤§ä¸€é»ï¼‰ */}
  <h3 style={{ marginTop: 10, fontSize: 22, letterSpacing: 2 }}>
    å·¥ç¨‹å ±åƒ¹å–®
  </h3>
</div>
   {/* ===== å ±åƒ¹å–®åŸºæœ¬è³‡è¨Šï¼ˆç„¡æ¡†ç·šï¼‰ ===== */}
<div style={{ marginBottom: 12, fontSize: 13, lineHeight: 1.6 }}>
  <div style={{ display: "flex", justifyContent: "space-between" }}>
    <div>å ±åƒ¹å–®è™Ÿï¼š{quote.quoteNo}</div>
    <div>å ±åƒ¹æ—¥æœŸï¼š{quote.date}</div>
  </div>

  <div>å·¥ç¨‹åç¨±ï¼š{quote.title}</div>

  <div style={{ display: "flex", justifyContent: "space-between" }}>
    <div>å®¢æˆ¶åç¨±ï¼š{quote.customerName}</div>
    <div>è¯çµ¡äººï¼š{quote.contact}</div>
  </div>

  <div style={{ display: "flex", justifyContent: "space-between" }}>
    <div>è¯çµ¡é›»è©±ï¼š{quote.phone}</div>
    <div>å·¥ç¨‹åœ°é»ï¼š{quote.location}</div>
  </div>
</div>
     

      {/* ===== å“é …è¡¨ ===== */}
      <table style={{ width: "100%", borderCollapse: "collapse" }}>
        <thead>
          <tr>
            <th style={TH_STYLE}>é …æ¬¡</th>
            <th style={TH_STYLE}>å“å</th>
            <th style={TH_STYLE}>è¦æ ¼</th>
            <th style={TH_STYLE}>å–®ä½</th>
            <th style={TH_STYLE}>æ•¸é‡</th>
            <th style={TH_STYLE}>å–®åƒ¹</th>
            <th style={TH_STYLE}>å°è¨ˆ</th>
            <th style={TH_STYLE}>å‚™è¨»</th>
          </tr>
        </thead>
        <tbody>
          {quote.items.map((item, i) => renderPrintItem(item, i + 1))}
        </tbody>
      </table>

      <TotalSummary />

      {/* ===== å‚™è¨» / ä»˜æ¬¾æ¢ä»¶ ===== */}
      <table style={{ width: "100%", borderCollapse: "collapse", marginTop: 15 }}>
        <tbody>
          <tr>
            <td style={{ ...TH_TD_STYLE, width: "50%" }}>
              <strong>å‚™è¨»ï¼ˆä¸å«ç¨…ï¼‰</strong>
              <div style={{ whiteSpace: "pre-wrap", marginTop: 6 }}>
                {quote.notes}
              </div>
            </td>
            <td style={{ ...TH_TD_STYLE, width: "50%" }}>
              <strong>ä»˜æ¬¾æ¢ä»¶</strong>
              <div style={{ whiteSpace: "pre-wrap", marginTop: 6 }}>
                {quote.payment}
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      {/* ===== ç°½ç« å€ ===== */}
      <table style={{ width: "100%", borderCollapse: "collapse", marginTop: 30 }}>
        <tbody>
          <tr>
            <td style={{ ...TH_TD_STYLE, width: "50%", height: 120 }}>
              <strong>å…¬å¸å ±åƒ¹ç« </strong>
              {companyInfo.stamp && (
                <img
                  src={companyInfo.stamp}
                  alt="å…¬å¸å°ç« "
                  style={{ display: "block", margin: "10px auto", maxHeight: 70 }}
                />
              )}
              <div style={{ borderTop: "1px solid #000", marginTop: 10 }}>
                ä»£è¡¨äººï¼š
              </div>
            </td>
            <td style={{ ...TH_TD_STYLE, width: "50%", height: 120 }}>
              <strong>å®¢æˆ¶å›ç°½</strong>
              <div style={{ borderTop: "1px solid #000", marginTop: 70 }}>
                ä»£è¡¨äººï¼š
              </div>
            </td>
          </tr>
          <tr>
            <td style={TH_TD_STYLE}>æ—¥æœŸï¼š</td>
            <td style={TH_TD_STYLE}>æ—¥æœŸï¼š</td>
          </tr>
        </tbody>
      </table>
    </div>
  );
}


/***********************************************************
  // P5 â€” App æ ¹å…ƒä»¶
 ***********************************************************/
function App() {
    return (
        <div className="min-h-screen bg-gray-50 flex">
            <div className="w-96 bg-white p-6 shadow-lg flex-shrink-0 text-lg sticky top-0 h-screen overflow-y-auto">
                <h1 className="text-2xl font-extrabold mb-6 text-center text-blue-700">å·¥ç¨‹å ±åƒ¹ç³»çµ±</h1>
                <CompanySelector />
                <ModeSelector />
                <QuoteList />
            </div>
            
            <div className="flex-grow p-8 text-base">
                <QuoteEditor />
            </div>
        </div>
    );
}

/***********************************************************
 * P6 â€” React 18 å•Ÿå‹•
 ***********************************************************/
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(
  <AppProvider>
    <App />
  </AppProvider>
);
</script>
</body>
</html>
