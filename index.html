<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆé›²ç«¯åŒæ­¥ç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { background: #f3f4f6; font-family: "Microsoft JhengHei", sans-serif; }
    .print-only-layout { display: none; }
    @media print {
      body, #root, .quote-editor-root-container, div { display: block !important; width: 100% !important; margin: 0 !important; padding: 0 !important; position: static !important; background: white; }
      .no-print, .live-preview-box, aside, nav { display: none !important; }
      .print-only-layout { display: block !important; width: 100% !important; margin: 0 !important; padding: 0 !important; box-sizing: border-box; }
      table { width: 100% !important; border-collapse: collapse; table-layout: fixed; }
      td, th { white-space: normal; word-wrap: break-word; vertical-align: middle; }
      @page { size: A4; margin: 10mm; }
    }
  </style>
</head>
<body class="text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    // â­ é›²ç«¯è¨­å®šå€ï¼šå°‡ä¾†æ‚¨çš„ Google Apps Script ç¶²å€å¡«åœ¨é€™è£¡ â­
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx4GXTBxB4TLvTgezA34ZidB0ZiEo_czt4T_t7XL79z3NmSNATXncmyg7oY9tGtZfuMZA/exec"; 

    const COMPANY_DATA = {
      herhsin: { name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸", taxId: "76380260", tel: "07-6521927", fax: "07-6517994", address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ", stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG", prefix: "QH" },
      sinchang: { name: "è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸", taxId: "53896738", tel: "07-6521927", fax: "07-6517994", address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ", stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG", prefix: "QS" }
    };

    const QUOTE_MODES = [
      { id: "mode_leak_repair", name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›å·¥ç¨‹", defaultItems: [{ name: "æ›´æ› 3mÂ³ æ‹Œåˆæ©Ÿã€æ¸›é€Ÿæ©Ÿå´ã€‘æ¼æ¼¿ï¼ˆå«å·¥è³‡åŠææ–™ï¼‰", unit: "å¼", qty: 1, price: 0, specMain: "å«æ‹†è£ã€èª¿æ•´ã€æ¸¬è©¦", specMaterial: "1.Aã€Båº§å„2åª 2.å¹³é¢æµ®å‹•æ²¹å°x2åª 3.é‹¼ç’°è“‹ã€é‹¼ç’°ç‰‡å„4ç‰‡ 4.æ”ªæ‹Œè‡‚èºçµ²x8çµ„", remarks: "", type: "main", subItems: [] }], defaultLeakageParts: [{ name: "è¯è»¸å™¨", spec: "å°ç£è£½é€ ", unit: "çµ„", price: 30000, variants: [{ label: "å°è£½ (å°ç£è£½é€ )", spec: "å°ç£è£½é€ ", price: 30000 }, { label: "å¾·è£½ (å¾·åœ‹åŸè£)", spec: "å¾·åœ‹åŸè£", price: 58000 }] }], defaultNotes: "1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚\n7. æœ¬å ±åƒ¹ç‚ºå¹³æ—¥æ–½å·¥è²»ç”¨ï¼Œå¦‚éœ€å‡æ—¥æ–½å·¥å‰‡éœ€å¦å¤–åŠ åƒ¹", defaultPayment: "å®Œå·¥å¾Œæ”¯ä»˜ 100%" },
      { id: "modeC", name: "è¨­å‚™æ›´æ›å·¥ç¨‹", defaultItems: [], defaultNotes: "1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚", defaultPayment: "è¨‚é‡‘ï¼š40%" }
    ];

    /***** å·¥å…·å‡½å¼ *****/
    function uuid() { return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => { const r = (Math.random() * 16) | 0; return (c === "x" ? r : (r & 0x3) | 0x8).toString(16); }); }
    function formatDate() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
    function formatMoney(n) { return Number(n || 0).toLocaleString("zh-TW", { maximumFractionDigits: 0 }); }
    function calcAmount(it) { return Number(it.qty || 0) * Number(it.price || 0); }
    function calcTotal(items) { return items.reduce((s, it) => s + calcAmount(it) + (it.subItems || []).reduce((ss, sub) => ss + (sub.type === "item" ? calcAmount(sub) : 0), 0), 0); }
    function calcNegotiated(tot, disc, cust) { return cust > 0 ? cust : (disc > 0 ? Math.round(tot * (1 - disc / 100)) : tot); }
    function generateQuoteNo(co) { const d = new Date(); const key = `${String(d.getFullYear()).slice(-2)}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`; return `${COMPANY_DATA[co].prefix}${key}${Math.floor(Math.random()*90+10)}`; }

    const AppContext = React.createContext();

    function AppProvider({ children }) {
      const [quotes, setQuotes] = React.useState([]);
      const [activeQuoteId, setActiveQuoteId] = React.useState(null);
      const [company, setCompany] = React.useState("herhsin");
      const [customers, setCustomers] = React.useState([]);

      // è¼‰å…¥è³‡æ–™é‚è¼¯
      React.useEffect(() => {
        const saved = localStorage.getItem("HERHSIN_QUOTES");
        if (saved) setQuotes(JSON.parse(saved));
      }, []);

      React.useEffect(() => {
        localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
        // âš ï¸ å¦‚æœæœ‰ GAS_URLï¼Œé€™è£¡å¯ä»¥è‡ªå‹•è§¸ç™¼é›²ç«¯å„²å­˜
      }, [quotes]);

      const activeQuote = quotes.find(q => q.id === activeQuoteId);
      const value = { quotes, setQuotes, activeQuote, activeQuoteId, setActiveQuoteId, company, setCompany, customers };

      return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
    }

    /***** å ±åƒ¹å–®ç·¨è¼¯å€ *****/
    function QuoteEditor() {
      const { activeQuote, setQuotes, activeQuoteId } = React.useContext(AppContext);
      if (!activeQuote) return <div className="p-8 text-center text-gray-500">è«‹é¸å–å ±åƒ¹å–®</div>;

      const updateQuote = (data) => setQuotes(prev => prev.map(q => q.id === activeQuoteId ? { ...q, ...data } : q));
      const total = calcTotal(activeQuote.items);
      const final = calcNegotiated(total, activeQuote.discountPercent, activeQuote.negotiatedPrice);

      return (
        <div className="quote-editor-root-container">
          <div className="p-8 bg-gray-100 rounded-xl shadow-xl no-print">
            <h1 className="text-2xl font-bold mb-4 border-b pb-2">ç·¨è¼¯å ±åƒ¹å–®ï¼š{activeQuote.quoteNo}</h1>
            
            {/* ç·¨è¼¯ä»‹é¢... (ç•¥ï¼Œä¿æŒæ‚¨åŸæœ‰çš„å“é …è¼¸å…¥é‚è¼¯) */}
            <div className="bg-white p-6 rounded-lg mb-6 shadow-sm">
                <div className="grid grid-cols-2 gap-4 mb-4">
                    <input className="border p-2 rounded" placeholder="å·¥ç¨‹åç¨±" value={activeQuote.title} onChange={e => updateQuote({title: e.target.value})} />
                    <input className="border p-2 rounded" placeholder="å®¢æˆ¶åç¨±" value={activeQuote.customerName} onChange={e => updateQuote({customerName: e.target.value})} />
                </div>
                <div className="flex gap-4 justify-end border-t pt-4">
                  <ExportButton />
                  <ExportWordButton />
                  <PrintButton />
                </div>
            </div>

            <div className="live-preview-box mt-10">
               <div style={{ backgroundColor: "#525659", padding: "20px", overflowX: "auto" }}>
                 <div style={{ backgroundColor: "white", width: "210mm", margin: "0 auto", padding: "15mm", boxShadow: "0 0 20px rgba(0,0,0,0.5)" }}>
                    <PrintLayout quote={activeQuote} totalAmount={total} negotiatedAmount={final} isPreview={true} />
                 </div>
               </div>
            </div>
          </div>

          <div className="print-only-layout">
            <PrintLayout quote={activeQuote} totalAmount={total} negotiatedAmount={final} isPreview={false} />
          </div>
        </div>
      );
    }

    /***** åˆ—å°é‚è¼¯ - å®Œç¾è§£æ±ºç©ºç™½èˆ‡è·‘ç‰ˆ *****/
    function PrintButton() {
      const { activeQuote } = React.useContext(AppContext);
      const handlePrint = () => {
        const editor = document.querySelector('.p-8.bg-gray-100');
        const printArea = document.querySelector('.print-only-layout');
        if (!editor || !printArea) return;

        const originalTitle = document.title;
        document.title = `${activeQuote.quoteNo}_${activeQuote.customerName}_å ±åƒ¹å–®`;

        editor.style.display = 'none';
        printArea.style.display = 'block';

        window.print();

        setTimeout(() => {
          editor.style.display = 'block';
          printArea.style.display = 'none';
          document.title = originalTitle;
        }, 500);
      };
      return <button onClick={handlePrint} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-bold">ğŸ–¨ï¸ åˆ—å° / ğŸ“„ è½‰ PDF</button>;
    }

    /***** åˆ—å°ä½ˆå±€ - ä¿®æ­£ colgroup è­¦å‘Š *****/
    function PrintLayout({ quote, totalAmount, negotiatedAmount }) {
      const co = COMPANY_DATA[quote.company];
      const TH = { border: "1px solid #000", background: "#f0f0f0", padding: "4px", fontWeight: "bold", textAlign: "center", fontSize: "12px" };
      const TD = { border: "1px solid #000", padding: "4px", fontSize: "12px" };

      return (
        <div className="print-page">
          <div className="text-center mb-4">
             <h2 className="text-2xl font-bold">{co.name}</h2>
             <p className="text-xs">çµ±ç·¨ï¼š{co.taxId} | åœ°å€ï¼š{co.address}</p>
             <h3 className="text-xl font-bold mt-2 border-b-2 border-black inline-block">å·¥ç¨‹å ±åƒ¹å–®</h3>
          </div>
          
          <table className="mb-4">
            <colgroup><col style={{width:"8%"}}/><col style={{width:"22%"}}/><col style={{width:"22%"}}/><col style={{width:"6%"}}/><col style={{width:"6%"}}/><col style={{width:"9%"}}/><col style={{width:"13%"}}/><col style={{width:"14%"}}/></colgroup>
            <thead>
              <tr><th style={TH}>é …æ¬¡</th><th style={TH}>å“å</th><th style={TH}>è¦æ ¼</th><th style={TH}>å–®ä½</th><th style={TH}>æ•¸é‡</th><th style={TH}>å–®åƒ¹</th><th style={TH}>å°è¨ˆ</th><th style={TH}>å‚™è¨»</th></tr>
            </thead>
            <tbody>
              {quote.items.map((it, idx) => (
                <tr key={idx}>
                  <td style={{...TD, textAlign:"center"}}>{idx+1}</td>
                  <td style={TD}>{it.name}</td>
                  <td style={TD}>{it.specMain}</td>
                  <td style={{...TD, textAlign:"center"}}>{it.unit}</td>
                  <td style={{...TD, textAlign:"center"}}>{it.qty}</td>
                  <td style={{...TD, textAlign:"right"}}>{formatMoney(it.price)}</td>
                  <td style={{...TD, textAlign:"right", fontWeight:"bold"}}>{formatMoney(calcAmount(it))}</td>
                  <td style={TD}>{it.remarks}</td>
                </tr>
              ))}
            </tbody>
          </table>

          <div className="flex justify-end mb-4">
             <div className="text-right font-bold">
                <div>ç¸½è¨ˆé‡‘é¡ï¼š{formatMoney(totalAmount)}</div>
                {negotiatedAmount !== totalAmount && <div className="text-red-600">æœ€çµ‚å ±åƒ¹ï¼š{formatMoney(negotiatedAmount)}</div>}
             </div>
          </div>

          <table className="w-full mt-4">
            <tr>
              <td style={{...TD, height: "100px", verticalAlign:"top"}}>
                <strong>å…¬å¸å ±åƒ¹ç« </strong>
                <img src={co.stamp} style={{maxHeight:"75px", margin:"5px auto", display:"block"}} />
              </td>
              <td style={{...TD, height: "100px", verticalAlign:"top"}}><strong>å®¢æˆ¶å›ç°½</strong></td>
            </tr>
          </table>
        </div>
      );
    }

    // å…¶é¤˜æŒ‰éˆ•çµ„ä»¶ (ExportButton, ExportWordButton) ä¿æŒæ‚¨åŸæœ‰çš„é‚è¼¯...

    function App() {
      const { quotes, setQuotes, setActiveQuoteId, activeQuoteId, company } = React.useContext(AppContext);
      
      const createQuote = (modeId) => {
        const mode = QUOTE_MODES.find(m => m.id === modeId) || QUOTE_MODES[0];
        const newQ = { id: uuid(), company, quoteNo: generateQuoteNo(company), title: "", customerName: "", date: formatDate(), items: mode.defaultItems.map(i => ({...i, id:uuid()})), notes: mode.defaultNotes, payment: mode.defaultPayment, discountPercent: 0, negotiatedPrice: 0 };
        setQuotes([newQ, ...quotes]);
        setActiveQuoteId(newQ.id);
      };

      return (
        <div className="flex min-h-screen">
          <aside className="w-80 bg-white shadow-lg p-6 no-print">
            <h1 className="text-xl font-bold mb-4 text-blue-700">å·¥ç¨‹å ±åƒ¹ç³»çµ±</h1>
            <button onClick={() => createQuote("mode_leak_repair")} className="w-full bg-green-600 text-white p-2 rounded mb-4">æ–°å»ºæ¼æ¼¿å·¥ç¨‹å–®</button>
            <div className="space-y-2">
              {quotes.map(q => (
                <div key={q.id} onClick={() => setActiveQuoteId(q.id)} className={`p-3 border rounded cursor-pointer ${activeQuoteId === q.id ? 'bg-blue-100 border-blue-500' : 'hover:bg-gray-50'}`}>
                  <div className="font-bold">{q.quoteNo}</div>
                  <div className="text-xs text-gray-500">{q.customerName || "æœªå¡«å®¢æˆ¶"}</div>
                </div>
              ))}
            </div>
          </aside>
          <main className="flex-grow p-8">
            <QuoteEditor />
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<AppProvider><App /></AppProvider>);
  </script>
</body>
</html>
