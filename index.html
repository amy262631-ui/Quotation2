<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ç¨‹å ±åƒ¹ç³»çµ±ï¼ˆHerhsin & SinChangï¼‰- V29 ä¿®æ­£ç‰ˆ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      background: #f3f4f6;
      font-family: "Microsoft JhengHei", sans-serif;
    }

    /* 1. ä¿®æ­£ï¼šé è¨­éš±è—åˆ—å°å°ˆç”¨å€å¡Šï¼Œ
      è§£æ±ºã€Œç•«é¢è·‘å‡ºå…©å€‹é è¦½ã€çš„å•é¡Œ 
    */
    .print-only-layout {
      display: none;
    }

   /* =================================================
       âœ… ä¿®æ­£å¾Œçš„åˆ—å°å°ˆç”¨ CSS
    ================================================= */
    @media print {
      /* 1. å¼·åˆ¶é‡ç½®æ‰€æœ‰å®¹å™¨ï¼Œå–æ¶ˆ Flex æ’ç‰ˆ */
      body, 
      #root, 
      .quote-editor-root-container, 
      div {
        display: block !important; /* é—œéµï¼šå–æ¶ˆ flexï¼Œæ”¹ç‚ºå€å¡Š */
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        position: static !important;
        background: white;
      }

      /* 2. éš±è—ä¸éœ€è¦åˆ—å°çš„å…ƒç´  */
      .no-print,
      .live-preview-box,
      aside, /* å¦‚æœå´é‚Šæ¬„æ˜¯ç”¨ aside */
      nav {
        display: none !important;
      }

      /* 3. è¨­å®šåˆ—å°å€åŸŸæ»¿ç‰ˆ */
      .print-only-layout {
        display: block !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’å¤§å¯¬åº¦ */
      }

      /* 4. è¡¨æ ¼è¨­å®š */
      table {
        width: 100% !important;
        border-collapse: collapse;
        table-layout: fixed; /* è®“æ¬„ä½å¯¬åº¦ä¾ç…§è¨­å®šçš„ % è·‘ï¼Œä¸è¦è¢«å…§å®¹æ’é–‹æˆ–å£“ç¸® */
      }

      thead {
        display: table-header-group;
      }

      tr {
        page-break-inside: avoid;
      }

      /* 5. ç¢ºä¿æ–‡å­—ä¸æœƒå› ç‚ºå¤ªæ“ è€Œè®Šç›´å‘ */
      td, th {
        white-space: normal; /* å…è¨±æ›è¡Œ */
        word-wrap: break-word; /*é•·å–®å­—æ›è¡Œ*/
        vertical-align: middle; /* å‚ç›´ç½®ä¸­ */
      }

      .print-footer-block,
      .print-signature-area {
        page-break-inside: avoid;
      }

      @page {
        size: A4;
        margin: 10mm; /* é‚Šè·è¨­ç‚º 10mmï¼Œè®“ç©ºé–“æ›´å¤§ */
      }
    }
  </style>
</head>

<body class="text-gray-900">
  <div id="root"></div>

  <script type="text/babel">

/***********************************************************
 * P1 â€” å…¬å¸è³‡æ–™ / å‚™è¨» / ä»˜æ¬¾æ¢ä»¶ / æ¨¡å¼æ¨¡æ¿
 ***********************************************************/
const COMPANY_DATA = {
  herhsin: {
    name: "ä½•é‘«å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸",
    taxId: "76380260",  
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
    stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
    prefix: "QH",
  },
  sinchang: {
    name: "è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸",
    taxId: "53896738",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831é«˜é›„å¸‚å¤§å¯®å€é³³å±äºŒè·¯383-8è™Ÿ",
    stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
    prefix: "QS",
  },
};

const DEFAULT_NOTES = `1. æœ¬å ±åƒ¹æœªå«åŠ å€¼ç¨…ã€‚
2. å®‰è£æ–½ä½œæ™‚éœ€æ³¨æ„ç¾å ´ä½œæ¥­ç’°å¢ƒã€‚
3. å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚º 15 å¤©ã€‚
4. è‹¥é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆå»¶èª¤ï¼Œå·¥æœŸé †å»¶ã€‚
5. æ–™ä»¶é ˆç”±æœ¬å…¬å¸æä¾›èˆ‡å®‰è£ï¼Œå¦å‰‡ä¸åœ¨ä¿å›ºç¯„åœå…§ã€‚
6. ä»˜æ¬¾æ¢ä»¶ä¾é›™æ–¹åˆç´„å…§å®¹ç‚ºæº–ã€‚`;

const DEFAULT_PAYMENT = `è¨‚é‡‘ï¼š40%
è£½ä½œå®Œæˆï¼š30%
å®‰è£å®Œæˆï¼š20%
å®Œå·¥é©—æ”¶ï¼š10%`;
 
/***********************************************************
 * å ±åƒ¹æ¨¡å¼æ¨¡æ¿ï¼ˆQUOTE_MODESï¼‰â€” å·²æ–°å¢å¯¦æ”¯å¯¦ä»˜é›¶ä»¶é è¨­å€¼
 ***********************************************************/
const QUOTE_MODES = [
  {
    id: "mode_leak_repair",
    name: "æ‹Œåˆæ©Ÿæ¼æ¼¿æ›´æ›å·¥ç¨‹",
    description: "æ‹Œåˆæ©Ÿæ¼æ¼¿ä¿®å¾©ï¼ŒåŒ…å·¥åŒ…æ–™é …ç›®å¦è¨ˆï¼Œé›¶ä»¶å¯¦æ”¯å¯¦ä»˜",
    
    // 1. ä¸»è¦å·¥ç¨‹é …ç›® (ç¶­æŒåŸæœ¬è¨­å®š)
    defaultItems: [
      {
        name: "æ›´æ› 3mÂ³ æ‹Œåˆæ©Ÿã€æ¸›é€Ÿæ©Ÿå´ã€‘æ¼æ¼¿ï¼ˆå«å·¥è³‡åŠææ–™ï¼‰",
        unit: "å¼",
        qty: 1,
        price: 0,
        specMain: "å«æ‹†è£ã€èª¿æ•´ã€æ¸¬è©¦",
        specMaterial: "",
        remarks: "",
        type: "main",
        subItems: []
      },
      {
        name: "æ›´æ› 3mÂ³ æ‹Œåˆæ©Ÿã€éæ¸›é€Ÿæ©Ÿå´ã€‘æ¼æ¼¿ï¼ˆå«å·¥è³‡åŠææ–™ï¼‰",
        unit: "å¼",
        qty: 1,
        price: 0,
        specMain: "å«æ‹†è£ã€èª¿æ•´ã€æ¸¬è©¦",
        specMaterial: "",
        remarks: "",
        type: "main",
        subItems: []
      }
    ],

  // ... åœ¨ QUOTE_MODES è£¡é¢ ...

    // â–¼â–¼â–¼ 2. ä¿®æ”¹å¾Œçš„ï¼šå¯¦æ”¯å¯¦ä»˜é›¶ä»¶é è¨­æ¸…å–® (å·²åˆä½µå°è£½/å¾·è£½) â–¼â–¼â–¼
    defaultLeakageParts: [
      { 
        name: "è¯è»¸å™¨", 
        spec: "å°ç£è£½é€ ", 
        unit: "çµ„", 
        price: 30000,
        // â­ æ–°å¢ï¼šé¸é …è¨­å®š
        variants: [
          { label: "å°è£½ (å°ç£è£½é€ )", spec: "å°ç£è£½é€ ", price: 30000 },
          { label: "å¾·è£½ (å¾·åœ‹åŸè£)", spec: "å¾·åœ‹åŸè£", price: 58000 }
        ]
      },
      { 
        name: "è¯è»¸å™¨æ©¡è† å¢Šåœˆ", 
        spec: "å°ç£è£½é€ ", 
        unit: "åª", 
        price: 2000,
        // â­ æ–°å¢ï¼šé¸é …è¨­å®š
        variants: [
          { label: "å°è£½ (å°ç£è£½é€ )", spec: "å°ç£è£½é€ ", price: 2000 },
          { label: "å¾·è£½ (å¾·åœ‹åŸè£)", spec: "å¾·åœ‹åŸè£", price: 9500 }
        ]
      },
      { name: "æ¸›é€Ÿæ©Ÿé¬†ç·Šå™¨", spec: "çµæ¥èºæ “åŠæ’éŠ·", unit: "å¼", price: 5000 },
      { name: "æ¸›é€Ÿæ©Ÿæ”¯æ’èª¿æ•´å™¨", spec: "åŠçœ¼èºçµ²", unit: "å¼", price: 3150 },
      { name: "æ²¹å°", spec: "TC 140x180x14", unit: "åª", price: 350 },
      { name: "è»¸æ‰¿", spec: "å‹è™Ÿï¼š23124", unit: "åª", price: 8000 },
      { name: "ä¸»è»¸å¥—ç­’", spec: "120x140x120", unit: "å¼", price: 2600 },
      { name: "éµæ§½çµ„", spec: "å¹³éµ 32x18x315L åŠæ–œéµ 10x7x50", unit: "å¼", price: 1800 },
      { name: "Oå‹ç’°", spec: "3x120x126", unit: "åª", price: 200 },
      { name: "å‡æ—¥æ–½å·¥åŠ åƒ¹", spec: "éå·¥ä½œæ—¥å‡ºå‹¤è²»ç”¨", unit: "å¼", price: 15000 },
    ],
    // â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²

    referenceItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeB",
    name: "è¨­å‚™éŠ·å”®",
    description: "é©ç”¨å‚™å“ã€å–®æ©ŸéŠ·å”®èˆ‡å®‰è£ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeC",
    name: "è¨­å‚™æ›´æ›å·¥ç¨‹",
    description: "é©ç”¨æ•´æ©Ÿæ›´æ–°ã€æ–™ä»¶æ›´æ›å·¥ç¨‹ã€‚",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  }
];

/***********************************************************
  * P2 â€” å·¥å…·å‡½å¼
 ***********************************************************/
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatDate(dateStr = new Date()) {
    const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
}

function formatMoney(num) {
    if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "0"; 
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
    const qty = Number(item.qty || 0);
    const price = Number(item.price || 0);
    return qty * price;
}

function calcTotal(items) {
    return items.reduce((sum, it) => {
        if (it.type === "reference") return sum;

        let mainAmt = calcAmount(it);
        let subs = 0;

        if (it.subItems && it.subItems.length > 0) {
            subs = it.subItems.reduce(
                (s, sub) => (sub.type === "item" ? s + calcAmount(sub) : s),
                0
            );
        }

        return sum + mainAmt + subs;
    }, 0);
}

function calcNegotiated(total, discountPercent, customPrice) {
    const cp = Number(customPrice || 0);
    const dp = Number(discountPercent || 0);
    
    if (cp > 0) return cp;
    
    if (dp > 0 && dp <= 100) {
        return Math.round(total * (1 - dp / 100));
    }
    
    return total;
}

function generateQuoteNo(companyKey = "sinchang") {
  const prefix = COMPANY_DATA[companyKey]?.prefix || "QS";

  const d = new Date();
  const yy = String(d.getFullYear()).slice(-2);
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");

  const dateKey = `${yy}${mm}${dd}`;
  const storageKey = `quote_seq_${companyKey}_${dateKey}`;

  let seq = Number(localStorage.getItem(storageKey) || "0") + 1;

  if (seq > 99) {
    alert("ä»Šæ—¥å ±åƒ¹å–®å·²è¶…é 99 å¼µï¼Œè«‹ç¢ºèª");
    seq = 99;
  }

  localStorage.setItem(storageKey, seq);

  const nn = String(seq).padStart(2, "0");
  return `${prefix}${dateKey}${nn}`;
}


async function loadCSV(url) {
    try {
        const res = await fetch(url);
        const text = await res.text();
        
        const rows = text.split("\n").map(r => r.trim()).filter(r => r.length > 0);
        if (rows.length < 2) return [];
        
        const header = rows[0].split(",").map(h => h.trim().replace(/"/g, ''));

        return rows.slice(1).map(row => {
            const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};

            header.forEach((h, i) => {
                let value = cols[i] ? cols[i].trim() : "";
                if (value.startsWith('"') && value.endsWith('"')) {
                    value = value.substring(1, value.length - 1);
                }
                obj[h] = value;
            });
            return obj;
        });
    } catch (error) {
        console.error("è¼‰å…¥æˆ–è§£æ Google Sheet CSV å¤±æ•—:", error);
        return [];
    }
}

/***********************************************************
 * P3 â€” AppContextï¼ˆè³‡æ–™ä¸­å¿ƒï¼‰
 ***********************************************************/
const AppContext = React.createContext();

function AppProvider({ children }) {
  const [company, setCompany] = React.useState("herhsin");
  const [quotes, setQuotes] = React.useState([]);
  const [activeQuoteId, setActiveQuoteId] = React.useState(null);
  const [specItems, setSpecItems] = React.useState([]);

  const SPEC_CSV_URL =
    "https://docs.google.com/spreadsheets/d/1wjoNesgvgmkVoG4bI9ppl_1EktH88WZ6bxT9IeyX4YM/export?format=csv";

  const loadSpecItems = React.useCallback(() => {
    loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
  }, []);

  React.useEffect(() => {
    loadSpecItems();
  }, [loadSpecItems]);

  React.useEffect(() => {
    const saved = localStorage.getItem("HERHSIN_QUOTES");
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (Array.isArray(parsed)) {
          setQuotes(parsed);
          if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
        }
      } catch (e) {
        setQuotes([]);
        setActiveQuoteId(null);
      }
    }
  }, []);

  React.useEffect(() => {
    localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
  }, [quotes]);

  /* ========================================================
     1. å»ºç«‹æ–°å ±åƒ¹å–® (createQuote)
     æ›´æ–°é‡é»ï¼šæ–°å¢è®€å– leakageParts (å¯¦æ”¯å¯¦ä»˜é›¶ä»¶) çš„é‚è¼¯
     ======================================================== */
  const createQuote = React.useCallback((modeId) => {
    const mode = QUOTE_MODES.find(m => m.id === modeId);
    
    // 1. è™•ç†ä¸»é …ç›® (çµ¦äºˆå…¨æ–° ID)
    const defaultItems = mode 
      ? JSON.parse(JSON.stringify(mode.defaultItems)).map(item => ({
          ...item,
          id: uuid() 
        }))
      : [];

    // â–¼â–¼â–¼ 2. æ–°å¢ï¼šè™•ç†å¯¦æ”¯å¯¦ä»˜é›¶ä»¶ (å¦‚æœæœ‰è¨­å®šçš„è©±) â–¼â–¼â–¼
    const defaultLeakageParts = (mode && mode.defaultLeakageParts)
      ? JSON.parse(JSON.stringify(mode.defaultLeakageParts)).map(part => ({
          ...part,
          id: uuid() // ä¸€æ¨£çµ¦äºˆå…¨æ–° IDï¼Œè®“æ‚¨å¯ä»¥è‡ªç”±åˆªæ¸›
        }))
      : [];

    const newQuote = {
        id: uuid(),
        company: company,
        quoteNo: generateQuoteNo(company),
        title: "",
        customerName: "",
        contact: "",
        phone: "",
        location: "",
        date: formatDate(),
        items: defaultItems,
        leakageParts: defaultLeakageParts, // â­ æŠŠé›¶ä»¶å­˜é€²å ±åƒ¹å–®è£¡
        notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
        payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
        discountPercent: 0,
        negotiatedPrice: 0
    };

    setQuotes(prev => [newQuote, ...prev]);
    setActiveQuoteId(newQuote.id);
  }, [company]);

  /* ========================================================
     2. åˆªé™¤å ±åƒ¹å–® (deleteQuote) - ç¶­æŒä¸è®Š
     ======================================================== */
  const deleteQuote = React.useCallback((id) => {
    setQuotes(prev => prev.filter(q => q.id !== id));
    if (activeQuoteId === id) setActiveQuoteId(null);
  }, [activeQuoteId]);
/* ========================================================
     æ–°å¢åŠŸèƒ½ï¼šè¤‡è£½å ±åƒ¹å–® (duplicateQuote)
     ======================================================== */
  const duplicateQuote = React.useCallback((id) => {
    // 1. æ‰¾åˆ°åŸæœ¬é‚£å¼µå–®
    const sourceQuote = quotes.find(q => q.id === id);
    if (!sourceQuote) return;

    // 2. æ·±å±¤è¤‡è£½ (Deep Copy) ä¸¦è³¦äºˆæ–°èº«åˆ†
    // æˆ‘å€‘ç”¨ JSON.parse(JSON.stringify(...)) ä¾†åˆ‡æ–·èˆ‡èˆŠè³‡æ–™çš„é€£çµ
    const newQuote = {
      ...JSON.parse(JSON.stringify(sourceQuote)), 
      id: uuid(),                                // çµ¦å…¨æ–°çš„ ID
      quoteNo: generateQuoteNo(sourceQuote.company), // çµ¦å…¨æ–°çš„å ±åƒ¹å–®è™Ÿ
      title: `${sourceQuote.title} (å‰¯æœ¬)`,       // æ¨™é¡ŒåŠ ä¸Š (å‰¯æœ¬) æ–¹ä¾¿è¾¨è­˜
      date: formatDate(),                        // æ›´æ–°æˆä»Šå¤©çš„æ—¥æœŸ
      
      // ç¢ºä¿è£¡é¢çš„é …ç›®ä¹Ÿæœ‰æ–° ID (é¿å… React å ±éŒ¯ key é‡è¤‡)
      items: sourceQuote.items.map(item => ({
         ...item,
         id: uuid()
      })),
      leakageParts: (sourceQuote.leakageParts || []).map(part => ({
         ...part,
         id: uuid()
      }))
    };

    // 3. å­˜å…¥åˆ—è¡¨ä¸¦é¸å–å®ƒ
    setQuotes(prev => [newQuote, ...prev]);
    setActiveQuoteId(newQuote.id);
  }, [quotes]);
  /* ========================================================
     3. æ›´æ–°å ±åƒ¹å–® (updateQuote) - ç¶­æŒä¸è®Š
     ======================================================== */
  const updateQuote = React.useCallback((id, data) => {
    setQuotes(prev => prev.map(q => q.id === id ? { ...q, ...data } : q));
  }, []);

  /* ========================================================
     4. å¥—ç”¨æ¨¡å¼ (applyMode)
     æ›´æ–°é‡é»ï¼šå¥—ç”¨æ™‚ä¹Ÿè¦æŠŠ leakageParts æŠ“é€²ä¾†
     ======================================================== */
  const applyMode = React.useCallback((modeId) => {
    if (!activeQuoteId) return;
    const mode = QUOTE_MODES.find(m => m.id === modeId);
    if (!mode) return;

    if (!window.confirm("ç¢ºå®šè¦è¦†è“‹ç•¶å‰å ±åƒ¹å–®å…§å®¹å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;

    // ä¸»é …ç›®
    const newItems = JSON.parse(JSON.stringify(mode.defaultItems)).map(item => ({
        ...item,
        id: uuid() 
    }));
    
    // â–¼â–¼â–¼ æ–°å¢ï¼šå¥—ç”¨é›¶ä»¶ â–¼â–¼â–¼
    const newLeakageParts = (mode.defaultLeakageParts)
      ? JSON.parse(JSON.stringify(mode.defaultLeakageParts)).map(part => ({
          ...part,
          id: uuid()
        }))
      : [];

    updateQuote(activeQuoteId, {
        items: newItems,
        leakageParts: newLeakageParts, // â­ æ›´æ–°é›¶ä»¶åˆ—è¡¨
        notes: mode.defaultNotes,
        payment: mode.defaultPayment
    });
  }, [activeQuoteId, updateQuote]);

  const activeQuote = quotes.find(q => q.id === activeQuoteId);

  const value = {
    company,
    setCompany,
    quotes,
    setQuotes,
    activeQuote,
    activeQuoteId,
    setActiveQuoteId,
    specItems,
    loadSpecItems,
    createQuote,
    deleteQuote,
    updateQuote,
    applyMode
  };

  window.__APP_CONTEXT__ = value;

  return (
    <AppContext.Provider value={value}>
      {children}
    </AppContext.Provider>
  );
}


/***********************************************************
 * P4-1 â€” å…¬å¸åˆ‡æ› / æ¨¡å¼é¸æ“‡ / å ±åƒ¹å–®åˆ—è¡¨
 ***********************************************************/
function CompanySelector() {
  const { company, setCompany, activeQuote, updateQuote } = React.useContext(AppContext);

  const handleSetCompany = (newCompany) => {
    setCompany(newCompany);
    if (activeQuote) {
      updateQuote(activeQuote.id, {
        company: newCompany,
        quoteNo: generateQuoteNo(newCompany)
      });
    }
  };

  return (
    <div className="mb-8 no-print">
      <div className="text-base font-semibold text-gray-700 mb-3">
        é¸æ“‡å…¬å¸
      </div>

      <div className="flex gap-3">
        <button
          className={`flex-1 px-4 py-2 text-base rounded-md transition ${
            company === "herhsin"
              ? "bg-blue-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => handleSetCompany("herhsin")}
        >
          ä½•é‘«å¯¦æ¥­
        </button>

        <button
          className={`flex-1 px-4 py-2 text-base rounded-md transition ${
            company === "sinchang"
              ? "bg-blue-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => handleSetCompany("sinchang")}
        >
          è–ªæ˜Œè‚¡ä»½æœ‰é™å…¬å¸
        </button>
      </div>
    </div>
  );
}

function ModeSelector() {
  const { createQuote, applyMode } = React.useContext(AppContext);

  const [selectedMode, setSelectedMode] = React.useState("");
  const [isNew, setIsNew] = React.useState(true);

  const handleApply = () => {
    if (!selectedMode) return;
    isNew ? createQuote(selectedMode) : applyMode(selectedMode);
    setSelectedMode("");
  };

  return (
    <div className="mb-8 pb-6 border-b border-gray-300 no-print">
      <div className="text-base font-semibold text-gray-700 mb-3">
        æ¨¡å¼å¥—ç”¨ï¼ˆ{isNew ? "æ–°å»º" : "è¦†è“‹"}ï¼‰
      </div>

      <div className="flex gap-3 mb-4">
        <button
          className={`flex-1 px-4 py-2 text-base rounded-md ${
            isNew
              ? "bg-green-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => setIsNew(true)}
        >
          æ–°å»ºå ±åƒ¹å–®
        </button>

        <button
          className={`flex-1 px-4 py-2 text-base rounded-md ${
            !isNew
              ? "bg-orange-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => setIsNew(false)}
        >
          å¥—ç”¨è‡³ç•¶å‰
        </button>
      </div>

      <select
        className="w-full border px-3 py-2 mb-4 rounded-md text-base"
        value={selectedMode}
        onChange={e => setSelectedMode(e.target.value)}
      >
        <option value="" disabled>è«‹é¸æ“‡å ±åƒ¹æ¨¡å¼</option>
        {QUOTE_MODES.map(mode => (
          <option key={mode.id} value={mode.id}>
            {mode.name} â€” {mode.description}
          </option>
        ))}
      </select>

      <button
        className="w-full bg-blue-600 text-white py-2.5 rounded-md text-base hover:bg-blue-700 disabled:opacity-50"
        onClick={handleApply}
        disabled={!selectedMode}
      >
        {isNew ? "æ–°å»ºå ±åƒ¹å–®ä¸¦å¥—ç”¨æ¨¡å¼" : "å¥—ç”¨æ¨¡å¼è‡³ç•¶å‰å ±åƒ¹å–®"}
      </button>
    </div>
  );
}

/* ========================================================
   çµ„ä»¶ï¼šå ±åƒ¹å–®åˆ—è¡¨ (QuoteList) â€” å‡ç´šç‰ˆ
   åŠŸèƒ½ï¼šé¡¯ç¤ºåˆ—è¡¨ã€æ”¯æ´åˆ‡æ›ã€åˆªé™¤ã€è¤‡è£½
   ======================================================== */
function QuoteList({ quotes, activeId, selectQuote, deleteQuote, duplicateQuote }) {
  // 1. å¦‚æœæ²’æœ‰å–®æ“šï¼Œé¡¯ç¤ºæç¤º
  if (!quotes || quotes.length === 0) {
    return (
        <div className="text-gray-400 text-sm text-center mt-10 p-4 border-2 border-dashed border-gray-200 rounded-lg">
            å°šç„¡å ±åƒ¹å–®<br/>è«‹ç”±ä¸Šæ–¹é¸æ“‡æ¨¡å¼æ–°å¢
        </div>
    );
  }

  return (
    <div className="space-y-3 pb-20"> {/* pb-20 æ˜¯ç‚ºäº†é¿å…è¢«åº•éƒ¨æ“‹ä½ */}
      {quotes.map((quote) => (
        <div
          key={quote.id}
          onClick={() => selectQuote(quote.id)}
          className={`p-4 rounded-lg cursor-pointer border transition-all relative group ${
            quote.id === activeId
              ? "bg-blue-50 border-blue-500 shadow-md ring-1 ring-blue-500"
              : "bg-white border-gray-200 hover:border-blue-300 hover:shadow-sm"
          }`}
        >
          {/* ä¸Šæ’ï¼šå…¬å¸æ¨™ç±¤ + å–®è™Ÿ */}
          <div className="flex justify-between items-center mb-2">
            <div className="flex items-center gap-2">
               {/* å…¬å¸æ¨™ç±¤ï¼šæ ¹æ“šå…¬å¸ä»£è™Ÿè®Šè‰² */}
               <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded text-white ${
                   quote.company === 'herhsin' ? 'bg-blue-600' : 'bg-green-600'
               }`}>
                 {quote.company === 'herhsin' ? 'ä½•é‘«' : 'è–ªæ˜Œ'}
               </span>
               <span className="text-xs text-gray-400 font-mono">
                 {quote.quoteNo}
               </span>
            </div>
          </div>

          {/* ä¸­æ’ï¼šæ¨™é¡Œ */}
          <div className="font-bold text-gray-800 mb-1 text-sm truncate pr-4">
            {quote.title || "ï¼ˆæœªå‘½åå·¥ç¨‹ï¼‰"}
          </div>

          {/* ä¸‹æ’ï¼šå®¢æˆ¶ + æ—¥æœŸ */}
          <div className="text-xs text-gray-500 flex justify-between items-center mt-2 border-t pt-2 border-gray-100">
             <span className="truncate max-w-[60%]">{quote.customerName || "æœªçŸ¥å®¢æˆ¶"}</span>
             <span>{quote.date}</span>
          </div>

          {/* â–¼â–¼â–¼ æ‡¸æµ®æŒ‰éˆ•å€ (æ»‘é¼ ç§»éå»æ‰æœƒå‡ºç¾) â–¼â–¼â–¼ */}
          <div className="absolute top-2 right-2 hidden group-hover:flex gap-1">
             {/* ğŸ“‹ è¤‡è£½æŒ‰éˆ• */}
             <button
                onClick={(e) => {
                  e.stopPropagation(); // é˜»æ­¢é»æ“Šè§¸ç™¼ã€Œé¸å–å ±åƒ¹å–®ã€
                  duplicateQuote(quote.id);
                }}
                className="p-1.5 bg-white text-gray-500 border border-gray-200 rounded hover:bg-blue-50 hover:text-blue-600 hover:border-blue-400 shadow-sm transition-colors"
                title="è¤‡è£½æ­¤å ±åƒ¹å–® (å»ºç«‹å‰¯æœ¬)"
             >
                ğŸ“‹
             </button>

             {/* âœ• åˆªé™¤æŒ‰éˆ• */}
             <button
                onClick={(e) => {
                  e.stopPropagation();
                  if(window.confirm(`ç¢ºå®šè¦åˆªé™¤å–®è™Ÿ ${quote.quoteNo} å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) {
                      deleteQuote(quote.id);
                  }
                }}
                className="p-1.5 bg-white text-gray-400 border border-gray-200 rounded hover:bg-red-50 hover:text-red-600 hover:border-red-400 shadow-sm transition-colors"
                title="åˆªé™¤"
             >
                âœ•
             </button>
          </div>

        </div>
      ))}
    </div>
  );
}

/***********************************************************
 * P4-2 â€” å–®ä¸€å ±åƒ¹é …ç›®ç·¨è¼¯ï¼ˆç·Šæ¹Šå„ªåŒ–ç‰ˆï¼‰
 ***********************************************************/
function QuoteItem({ item, index, updateItem, deleteItem }) {
  const { specItems } = React.useContext(AppContext);

  /* --- é‚è¼¯ä¿æŒä¸è®Š --- */
  const handleChange = (field, value) => {
    updateItem({ [field]: value });
  };

  const handleAddSubText = () => {
    const newSub = {
      id: uuid(),
      type: "text",
      name: "",
      remarks: ""
    };
    updateItem({ subItems: [...(item.subItems || []), newSub] });
  };

  const handleAddSubImage = (file) => {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const newSub = {
        id: uuid(),
        type: "image",
        name: "",
        imageData: reader.result
      };
      updateItem({ subItems: [...(item.subItems || []), newSub] });
    };
    reader.readAsDataURL(file);
  };

  const handleDeleteSub = (subId) => {
    const newSubItems = item.subItems.filter(s => s.id !== subId);
    updateItem({ subItems: newSubItems });
  };

  const handleUpdateSub = (subId, field, value) => {
    const newSubItems = item.subItems.map(s => 
      s.id === subId ? { ...s, [field]: value } : s
    );
    updateItem({ subItems: newSubItems });
  };

  return (
    <div className="mb-3 border rounded-lg bg-white shadow-sm overflow-hidden text-sm">
      
      {/* ===== ç¬¬ä¸€å€ï¼šæ ¸å¿ƒè¼¸å…¥ (é è¨­é¡¯ç¤º) ===== */}
      <div className="p-3 grid grid-cols-12 gap-3 items-start">
        
        {/* 1. é …æ¬¡èˆ‡åˆªé™¤ */}
        <div className="col-span-12 flex justify-between items-center border-b pb-2 mb-1">
          <div className="font-bold text-blue-700 text-base">
            é …æ¬¡ {index + 1}
          </div>
          <button
            onClick={() => deleteItem(item.id)}
            className="text-red-500 hover:text-red-700 px-2 py-1 text-xs border border-red-200 rounded hover:bg-red-50 transition"
          >
            ğŸ—‘ åˆªé™¤æ­¤é …
          </button>
        </div>

        {/* 2. å“å */}
        <div className="col-span-12 md:col-span-4">
          <label className="block text-xs text-gray-500 mb-1">å“å</label>
          <input
            type="text"
            list={`spec-list-${item.id}`}
            className="w-full border rounded px-2 py-1.5 focus:ring-2 focus:ring-blue-300 outline-none"
            placeholder="è¼¸å…¥æˆ–é¸æ“‡å“å..."
            value={item.name || ""}
            onChange={(e) => handleChange("name", e.target.value)}
            onBlur={(e) => {
              const value = e.target.value;
              const matched = specItems.find(r => (r["å“å"] || "") === value);
              if (!matched) return;

              const materials = [matched["ç”¨æ–™1"], matched["ç”¨æ–™2"], matched["ç”¨æ–™3"]]
                .filter(v => typeof v === "string" && v.trim() !== "")
                .join("ã€");

              updateItem({
                name: matched["å“å"] || "",
                unit: matched["å–®ä½"] || "",
                price: matched["å–®åƒ¹"] || 0, // é€™è£¡ä¿æŒæ•¸å€¼æˆ–æ˜¯å­—ä¸²éƒ½è¡Œ
                specMain: matched["è¦æ ¼"] || "",  
                specMaterial: materials             
              });
            }}
          />
          <datalist id={`spec-list-${item.id}`}>
            {specItems.map((r, i) => (
              <option key={i} value={r["å“å"] || ""}>
                {r["è¦æ ¼"] ? `(${r["è¦æ ¼"]})` : ""}
              </option>
            ))}
          </datalist>
        </div>

        {/* 3. è¦æ ¼èªªæ˜ */}
        <div className="col-span-12 md:col-span-8">
          <label className="block text-xs text-gray-500 mb-1">è¦æ ¼èªªæ˜</label>
          <input
            type="text"
            className="w-full border rounded px-2 py-1.5 focus:ring-2 focus:ring-blue-300 outline-none"
            value={item.specMain || ""}
            onChange={(e) => handleChange("specMain", e.target.value)}
          />
        </div>

        {/* 4. å–®ä½ */}
        <div className="col-span-3 md:col-span-1">
          <label className="block text-xs text-gray-500 mb-1">å–®ä½</label>
          <input
            type="text"
            className="w-full border rounded px-2 py-1.5 text-center outline-none"
            value={item.unit || ""}
            onChange={(e) => handleChange("unit", e.target.value)}
          />
        </div>

        {/* 5. æ•¸é‡ (ä¿®æ­£ï¼šç§»é™¤ Number() å¼·åˆ¶è½‰å‹) */}
        <div className="col-span-3 md:col-span-1">
          <label className="block text-xs text-gray-500 mb-1">æ•¸é‡</label>
          <input
            type="number"
            className="w-full border rounded px-2 py-1.5 text-center outline-none"
            value={item.qty}
            // â¬‡ï¸ ä¿®æ­£é»ï¼šç›´æ¥å‚³å…¥ e.target.valueï¼Œè®“ä½¿ç”¨è€…å¯ä»¥åˆªé™¤æˆç©ºç™½é‡æ–°è¼¸å…¥
            onChange={(e) => handleChange("qty", e.target.value)}
          />
        </div>

        {/* 6. å–®åƒ¹ (ä¿®æ­£ï¼šç§»é™¤ Number() å¼·åˆ¶è½‰å‹) */}
        <div className="col-span-6 md:col-span-2">
          <label className="block text-xs text-gray-500 mb-1">å–®åƒ¹</label>
          <input
            type="number"
            className="w-full border rounded px-2 py-1.5 text-right outline-none"
            value={item.price}
            // â¬‡ï¸ ä¿®æ­£é»ï¼šç›´æ¥å‚³å…¥ e.target.value
            onChange={(e) => handleChange("price", e.target.value)}
          />
        </div>

        {/* 7. å°è¨ˆ (ç´”é¡¯ç¤º) */}
        <div className="col-span-6 md:col-span-2">
          <label className="block text-xs text-gray-500 mb-1">å°è¨ˆ</label>
          <div className="w-full bg-gray-100 rounded px-2 py-1.5 text-right text-gray-700 font-medium">
             {/* é€™è£¡åŠ å› Number() ç¢ºä¿é‹ç®—æ­£ç¢º */}
             {(Number(item.qty || 0) * Number(item.price || 0)).toLocaleString()}
          </div>
        </div>

        {/* 8. å“ç‰Œ/ç”¢åœ° (Variants) */}
        {Array.isArray(item.variants) && item.variants.length > 0 && (
           <div className="col-span-12 md:col-span-6">
             <label className="block text-xs text-gray-500 mb-1">å“ç‰Œé¸é …</label>
             <select
               className="w-full border rounded px-2 py-1.5"
               value={item.selected}
               onChange={(e) => {
                 const selectedKey = e.target.value;
                 const variant = item.variants.find(v => v.key === selectedKey);
                 updateItem({
                   selected: selectedKey,
                   price: variant ? variant.defaultPrice : item.price
                 });
               }}
             >
               {item.variants.map(v => (
                 <option key={v.key} value={v.key}>{v.label}</option>
               ))}
             </select>
           </div>
        )}

      </div>

      {/* ===== ç¬¬äºŒå€ï¼šé€²éšè¼¸å…¥ (æ‘ºç–Šå€) ===== */}
      <details className="group border-t border-gray-100 bg-gray-50">
        <summary className="cursor-pointer list-none p-2 text-center text-xs text-blue-600 hover:bg-blue-50 font-medium select-none flex items-center justify-center gap-2 transition-colors">
          <span>ğŸ“ ç·¨è¼¯ç”¨æ–™æ˜ç´° / å‚™è¨» / è£œå……åœ–ç‰‡èˆ‡æ–‡å­— ({item.subItems?.length || 0})</span>
          <span className="group-open:rotate-180 transition-transform duration-200">â–¼</span>
        </summary>
        
        <div className="p-4 grid grid-cols-1 gap-4 animate-fade-in">
          
          {/* ç”¨æ–™æ˜ç´° & å‚™è¨» */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-xs text-gray-500 mb-1">ç”¨æ–™æ˜ç´° (åˆ—å°æ™‚é¡¯ç¤º)</label>
              <textarea
                className="w-full border rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-300 outline-none"
                rows="3"
                value={item.specMaterial || ""}
                onChange={(e) => handleChange("specMaterial", e.target.value)}
                placeholder="è¼¸å…¥è©³ç´°ç”¨æ–™..."
              />
            </div>
            <div>
              <label className="block text-xs text-gray-500 mb-1">å‚™è¨»</label>
              <textarea
                className="w-full border rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-300 outline-none"
                rows="3"
                value={item.remarks || ""}
                onChange={(e) => handleChange("remarks", e.target.value)}
                placeholder="è¼¸å…¥å…§éƒ¨å‚™è¨»..."
              />
            </div>
          </div>

          {/* å­é …ç›®åˆ—è¡¨ */}
          {(item.subItems || []).length > 0 && (
            <div className="space-y-2 mt-2">
              <div className="text-xs font-bold text-gray-400">è£œå……é …ç›®åˆ—è¡¨ï¼š</div>
              {(item.subItems || []).map((sub, idx) => (
                <div key={sub.id} className="border p-2 rounded bg-white flex gap-3 items-start shadow-sm">
                  <div className="text-xs text-gray-400 mt-1">{idx + 1}.</div>
                  
                  {sub.type === "image" && (
                    <div className="flex-1">
                      <div className="text-xs text-blue-600 font-bold mb-1">åœ–ç‰‡</div>
                      <img src={sub.imageData} alt="upload" className="h-20 w-auto rounded border object-contain" />
                    </div>
                  )}

                  {sub.type === "text" && (
                    <div className="flex-1 space-y-1">
                      <div className="text-xs text-blue-600 font-bold">æ–‡å­—èªªæ˜</div>
                      <input 
                        type="text" 
                        placeholder="æ¨™é¡Œ..."
                        className="w-full border p-1 text-sm rounded"
                        value={sub.name}
                        onChange={e => handleUpdateSub(sub.id, "name", e.target.value)}
                      />
                      <textarea 
                        placeholder="å…§å®¹..."
                        className="w-full border p-1 text-sm rounded"
                        rows="1"
                        value={sub.remarks}
                        onChange={e => handleUpdateSub(sub.id, "remarks", e.target.value)}
                      />
                    </div>
                  )}

                  <button 
                    className="text-red-400 hover:text-red-600 text-sm px-2"
                    onClick={() => handleDeleteSub(sub.id)}
                  >
                    Ã—
                  </button>
                </div>
              ))}
            </div>
          )}

          {/* æŒ‰éˆ•å€ */}
          <div className="flex gap-3 pt-2">
            <button
              className="flex-1 py-2 bg-white border border-gray-300 rounded text-sm hover:bg-gray-50 transition shadow-sm text-gray-700"
              onClick={handleAddSubText}
            >
              ï¼‹ è£œå……æ–‡å­—
            </button>

            <label className="flex-1 py-2 bg-white border border-gray-300 rounded text-sm hover:bg-gray-50 transition shadow-sm text-gray-700 cursor-pointer text-center">
              ï¼‹ è£œå……åœ–ç‰‡
              <input
                type="file"
                accept="image/*"
                className="hidden"
                onChange={(e) => {
                  handleAddSubImage(e.target.files[0]);
                  e.target.value = '';
                }}
              />
            </label>
          </div>

        </div>
      </details>
    </div>
  );
}

/***********************************************************
  * P4-3 â€” QuoteEditor / ExportButton / PrintButton / PrintLayout
 ***********************************************************/
// å ±åƒ¹å–®ç·¨è¼¯ä¸»å…ƒä»¶
function QuoteEditor() {
    const { activeQuote, updateQuote } = React.useContext(AppContext);
    const componentRef = React.useRef(null);

    if (!activeQuote) {
        return (
            <div className="p-8 text-center text-gray-500 text-xl">
                è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹å ±åƒ¹å–®æˆ–æ–°å»ºä¸€å€‹å ±åƒ¹å–®ã€‚
            </div>
        );
    }
    
    const handleChange = (field, value) => {
        updateQuote(activeQuote.id, { [field]: value });
    };

    const handleUpdateItem = (itemId, data) => {
        const newItems = activeQuote.items.map(item => 
            item.id === itemId ? { ...item, ...data } : item
        );
        updateQuote(activeQuote.id, { items: newItems });
    };

    const handleDeleteItem = (itemId) => {
        const newItems = activeQuote.items.filter(item => item.id !== itemId);
        updateQuote(activeQuote.id, { items: newItems });
    };

    const handleAddItem = () => {
        const newItem = {
            id: uuid(),
            name: "", 
            specMain: "",
            unit: "å¼",
            qty: 1,
            price: 0,
            subItems: [],
            remarks: "",
            specMaterial: ""
        };
        updateQuote(activeQuote.id, { items: [...activeQuote.items, newItem] });
    };
    
    const totalAmount = calcTotal(activeQuote.items);
    
    const negotiatedAmount = calcNegotiated(
        totalAmount,
        activeQuote.discountPercent,
        activeQuote.negotiatedPrice
    );

    // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºæœ€çµ‚å ±åƒ¹ï¼ˆåªè¦æœ‰æŠ˜æ‰£ OR æœ‰è‡ªå®šç¾©åƒ¹æ ¼ï¼Œå°±é¡¯ç¤ºï¼‰
    const showFinalPrice = (activeQuote.discountPercent > 0) || (activeQuote.negotiatedPrice > 0);

   return (
  <div className="quote-editor-root-container text-lg">
    {/* ç·¨è¼¯å€ (æœ‰ .no-print) */}
    <div className="p-8 bg-gray-100 rounded-xl shadow-xl no-print">

      {/* ===== æ¨™é¡Œ ===== */}
      <h1 className="text-3xl font-bold mb-6 border-b pb-3">
        ç·¨è¼¯å ±åƒ¹å–®ï¼š{activeQuote.title || "æœªå‘½å"}
      </h1>

     {/* ===== å ±åƒ¹å–®åŸºæœ¬è³‡æ–™ï¼ˆè¡¨é ­å¡ - ç·Šæ¹Šç‰ˆï¼‰ ===== */}
      <div className="bg-white p-4 rounded-lg mb-6 border border-gray-300 shadow-sm text-sm">
        
        {/* ä½¿ç”¨ grid-cols-4 è®“ç©ºé–“åˆ©ç”¨æ›´æœ‰æ•ˆç‡ï¼Œgap ç¸®å°ç‚º 3 */}
        <div className="grid grid-cols-4 gap-3">

          {/* ç¬¬ä¸€åˆ—ï¼šå–®è™Ÿ (ä½”1) + æ—¥æœŸ (ä½”1) + æ¨™é¡Œ (ä½”2) */}
          <div className="col-span-1">
            <label className="block text-xs font-bold text-gray-500 mb-1">å ±åƒ¹å–®ç·¨è™Ÿ</label>
            <div className="font-mono font-bold text-blue-700 text-base leading-tight mt-1">
              {activeQuote.quoteNo}
            </div>
          </div>

          <div className="col-span-1">
             <label className="block text-xs font-bold text-gray-500 mb-1">å ±åƒ¹æ—¥æœŸ</label>
             <input
              type="date"
              value={activeQuote.date}
              onChange={(e) => handleChange("date", e.target.value)}
              className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
            />
          </div>

          <div className="col-span-2">
            <label className="block text-xs font-bold text-gray-500 mb-1">å·¥ç¨‹åç¨± / æ¨™é¡Œ</label>
            <input
              type="text"
              value={activeQuote.title}
              onChange={(e) => handleChange("title", e.target.value)}
              className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
              placeholder="è«‹è¼¸å…¥å·¥ç¨‹åç¨±"
            />
          </div>

          {/* ç¬¬äºŒåˆ—ï¼šå®¢æˆ¶ (ä½”1) + è¯çµ¡äºº (ä½”1) + é›»è©± (ä½”1) + åœ°é» (ä½”1) */}
          <div className="col-span-1">
            <label className="block text-xs font-bold text-gray-500 mb-1">å®¢æˆ¶åç¨±</label>
            <input
              type="text"
              value={activeQuote.customerName}
              onChange={(e) => handleChange("customerName", e.target.value)}
              className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
            />
          </div>

          <div className="col-span-1">
            <label className="block text-xs font-bold text-gray-500 mb-1">è¯çµ¡äºº</label>
            <input
              type="text"
              value={activeQuote.contact}
              onChange={(e) => handleChange("contact", e.target.value)}
              className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
            />
          </div>

          <div className="col-span-1">
            <label className="block text-xs font-bold text-gray-500 mb-1">è¯çµ¡é›»è©±</label>
            <input
              type="text"
              value={activeQuote.phone}
              onChange={(e) => handleChange("phone", e.target.value)}
              className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
            />
          </div>

          <div className="col-span-1">
            <label className="block text-xs font-bold text-gray-500 mb-1">å·¥ç¨‹åœ°é»</label>
            <input
              type="text"
              value={activeQuote.location}
              onChange={(e) => handleChange("location", e.target.value)}
              className="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
            />
          </div>

        </div>

        {/* ===== é‡‘é¡æ‘˜è¦å€ (æ©«å‘æ’åˆ—ï¼Œç¯€çœå‚ç›´ç©ºé–“) ===== */}
        <div className="mt-4 pt-3 border-t border-gray-200 flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
            {/* å·¦é‚Šï¼šç¸½é‡‘é¡ */}
            <div className="flex items-center gap-2">
                <span className="text-gray-600 font-bold">ç¸½è¨ˆé‡‘é¡(æœªç¨…)ï¼š</span>
                <span className="text-xl font-bold text-blue-700">
                    NT$ {formatMoney(totalAmount)}
                </span>
            </div>

            {/* å³é‚Šï¼šæŠ˜æ‰£èˆ‡æœ€çµ‚å ±åƒ¹ (ä¸¦æ’é¡¯ç¤º) */}
            <div className="flex items-center gap-4">
                <div className="flex items-center gap-2">
                    <span className="text-xs font-bold text-gray-500">æŠ˜æ‰£(%)</span>
                    <input
                        type="number"
                        value={activeQuote.discountPercent}
                        onChange={(e) => handleChange("discountPercent", Number(e.target.value))}
                        className="w-16 border border-gray-300 rounded px-2 py-1 text-sm text-right focus:ring-1 focus:ring-blue-500 outline-none"
                    />
                </div>
                
                <div className="flex items-center gap-2">
                    <span className="text-xs font-bold text-gray-500">è‡ªå®šç¾©æœ€çµ‚åƒ¹</span>
                    <input
                        type="number"
                        value={activeQuote.negotiatedPrice}
                        onChange={(e) => handleChange("negotiatedPrice", Number(e.target.value))}
                        className="w-24 border border-gray-300 rounded px-2 py-1 text-sm text-right focus:ring-1 focus:ring-blue-500 outline-none"
                    />
                </div>

                {/* å¦‚æœæœ‰æœ€çµ‚å ±åƒ¹ï¼Œé¡¯ç¤ºç´…è‰²é‡‘é¡ */}
                {showFinalPrice && (
                    <div className="pl-4 border-l border-gray-300">
                        <span className="text-red-600 font-bold text-lg">
                           ${formatMoney(negotiatedAmount)}
                        </span>
                    </div>
                )}
            </div>
        </div>
      </div>

      {/* ===== å ±åƒ¹é …ç›®åˆ—è¡¨ ===== */}
      <h2 className="text-2xl font-bold mt-10 mb-4 border-b pb-2">
        å ±åƒ¹é …ç›®åˆ—è¡¨
      </h2>

      <button
        className="bg-green-600 text-white px-5 py-2 rounded-lg mb-6 hover:bg-green-700 text-base"
        onClick={handleAddItem}
      >
        ï¼‹ æ–°å¢å·¥ç¨‹å¤§é …
      </button>

      <div className="quote-items-container space-y-6">
        {activeQuote.items.map((item, index) => (
          <QuoteItem
            key={item.id}
            item={item}
            index={index}
            updateItem={(data) => handleUpdateItem(item.id, data)}
            deleteItem={handleDeleteItem}
          />
        ))}
      </div>

      {/* â–¼â–¼â–¼ æ’å…¥é€™è£¡ï¼šå¦‚æœæœ‰é›¶ä»¶è³‡æ–™ï¼Œå°±é¡¯ç¤ºç·¨è¼¯å™¨ â–¼â–¼â–¼ */}
            {activeQuote.leakageParts && (
              <LeakagePartsEditor 
                parts={activeQuote.leakageParts} 
                updateQuote={(data) => updateQuote(activeQuote.id, data)} 
              />
            )}
      {/* ===== å‚™è¨» / ä»˜æ¬¾æ¢ä»¶ ===== */}
      <div className="mt-10 grid grid-cols-2 gap-8">
        <div>
          <h3 className="font-bold text-lg mb-2">å‚™è¨»ï¼ˆä¸å«ç¨…ï¼‰</h3>
          <textarea
            value={activeQuote.notes}
            onChange={(e) => handleChange("notes", e.target.value)}
            rows="8"
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        <div>
          <h3 className="font-bold text-lg mb-2">ä»˜æ¬¾æ¢ä»¶</h3>
          <textarea
            value={activeQuote.payment}
            onChange={(e) => handleChange("payment", e.target.value)}
            rows="8"
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>
      </div>

        {/* ===== åŒ¯å‡º / åˆ—å° ===== */}
      <div className="mt-10 pt-6 border-t flex gap-4 justify-end no-print">
        <ExportButton />
        <ExportWordButton componentRef={componentRef} />
        <PrintButton componentRef={componentRef} />
      </div>

      {/* ===== å³æ™‚é è¦½ï¼ˆç•«é¢ç”¨ï¼‰ ===== */}
      <div className="live-preview-box mt-12 no-print">
        <h3 className="text-center font-bold text-2xl text-blue-700 mb-6">
          å¯¦æ™‚é è¦½å€ï¼ˆéåˆ—å°å°ºå¯¸ï¼‰
        </h3>

        {/* â–¼â–¼â–¼ ä¿®æ”¹é–‹å§‹ï¼šé€™è£¡å¢åŠ äº†ç°è‰²èƒŒæ™¯èˆ‡ç™½ç´™æ¨£å¼ â–¼â–¼â–¼ */}
        <div 
          style={{ 
            backgroundColor: "#525659", // æ·±ç°è‰²èƒŒæ™¯ï¼Œæ¨¡ä»¿ PDF é è¦½è»Ÿé«”
            padding: "40px 0",          // ä¸Šä¸‹ç•™å‡ºç©ºé–“
            overflowX: "auto",          // è¢å¹•å¤ªå°æ™‚å¯å·¦å³æ»‘å‹•
            border: "1px solid #ccc"
          }}
        >
          <div 
            className="print-page"
            style={{
              backgroundColor: "white",        // ç™½ç´™åº•è‰²
              width: "210mm",                  // A4 å¯¬åº¦
              minHeight: "297mm",              // A4 é«˜åº¦
              margin: "0 auto",                // å·¦å³ç½®ä¸­
              padding: "20mm",                 // æ¨¡æ“¬åˆ—å°é‚Šç•Œ (å¦‚æœ PrintLayout å…§å·²æœ‰é‚Šè·ï¼Œé€™è£¡å¯æ”¹ 0)
              boxShadow: "0 0 20px rgba(0,0,0,0.5)", // å¢åŠ é™°å½±ï¼Œè®“ç´™å¼µæµ®èµ·ä¾†
              boxSizing: "border-box"
            }}
          >
            <PrintLayout
              quote={activeQuote}
              totalAmount={totalAmount}
              negotiatedAmount={negotiatedAmount}
              isPreview={true}
            />
          </div>
        </div>
        {/* â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–² */}

      </div>
    </div> 
    {/* â¬†ï¸ é€™è£¡çµæŸ .no-print å®¹å™¨ */}

    {/* âš ï¸ é‡è¦ä¿®æ­£ï¼š
       å°‡åˆ—å°å°ˆç”¨çš„ div ç§»åˆ° .no-print å®¹å™¨çš„å¤–é¢ã€‚
       é€™æ¨£ç•¶ .no-print è¢«éš±è—æ™‚ï¼Œé€™å€‹ div æ‰èƒ½è¢«é¡¯ç¤ºå‡ºä¾†ã€‚
    */}
    <div
      ref={componentRef}
      className="print-only-layout"
    >
      <PrintLayout
        quote={activeQuote}
        totalAmount={totalAmount}
        negotiatedAmount={negotiatedAmount}
        isPreview={false}
      />
    </div>

  </div>
  );
}

// ===============================
// Excel åŒ¯å‡º
// ===============================
function ExportButton() {
  const { activeQuote } = React.useContext(AppContext);

  const handleExport = () => {
    if (!activeQuote || !activeQuote.items?.length) {
      alert("è«‹å…ˆæ–°å¢å ±åƒ¹é …ç›®");
      return;
    }

    const companyKey = activeQuote.company || "herhsin";
    const company = COMPANY_DATA[companyKey];
    const total = calcTotal(activeQuote.items);
    const negotiated = calcNegotiated(total, activeQuote.discountPercent, activeQuote.negotiatedPrice);
    
    // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºæœ€çµ‚å ±åƒ¹
    const showFinalPrice = (activeQuote.discountPercent > 0) || (activeQuote.negotiatedPrice > 0);

    const rows = [];
    let r = 0;

    rows[r++] = [company.name];
    rows[r++] = ["å·¥ç¨‹å ±åƒ¹å–®"];
    rows[r++] = [];

    rows[r++] = ["å ±åƒ¹å–®è™Ÿ", activeQuote.quoteNo, "", "", "å ±åƒ¹æ—¥æœŸ", activeQuote.date];
    rows[r++] = ["å·¥ç¨‹åç¨±", activeQuote.title];
    rows[r++] = ["å®¢æˆ¶åç¨±", activeQuote.customerName, "", "è¯çµ¡äºº", activeQuote.contact];
    rows[r++] = ["å·¥ç¨‹åœ°é»", activeQuote.location];
    rows[r++] = [];

    rows[r++] = ["é …æ¬¡","å“å","è¦æ ¼ / è£œå……å…§å®¹","å–®ä½","æ•¸é‡","å–®åƒ¹","é‡‘é¡(å°è¨ˆ)","å‚™è¨»","ç”¨æ–™æ˜ç´°"];

    let index = 1;
    activeQuote.items.forEach(item => {
      rows[r++] = [
        index++,
        item.name || "",
        item.specMain || "",
        item.unit || "",
        item.qty || "",
        item.price || "",
        calcAmount(item),
        item.remarks || "",
        item.specMaterial || ""
      ];

      if (item.specMaterial) {
         rows[r++] = ["", `ç”¨æ–™æ˜ç´°ï¼š${item.specMaterial}`, "", "", "", "", "", "", ""];
      }

      (item.subItems || []).forEach(sub => {
        if (sub.type === "text") {
          rows[r++] = ["", `è£œå……ï¼š${sub.name || ""}`, sub.remarks || "", "", "", "", "", "", ""];
        }
        if (sub.type === "image") {
          rows[r++] = ["", "è£œå……åœ–ç‰‡", "ï¼ˆåœ–ç‰‡è«‹åƒè€ƒåˆ—å°ç‰ˆï¼‰", "", "", "", "", "", ""];
        }
      });
    });

    rows[r++] = [];
    rows[r++] = ["", "", "", "", "", "ç¸½è¨ˆ", total];
    
    // â­ å¦‚æœæ²’æœ‰æŠ˜æ‰£/è‡ªå®šç¾©åƒ¹æ ¼ï¼Œå°±ä¸è¼¸å‡ºé€™å…©è¡Œ
    if (showFinalPrice) {
        rows[r++] = ["", "", "", "", "", "æŠ˜æ‰£(%)", activeQuote.discountPercent || 0];
        rows[r++] = ["", "", "", "", "", "æœ€çµ‚å ±åƒ¹", negotiated];
    }
    
    rows[r++] = [];
    rows[r++] = ["å‚™è¨»"];
    rows[r++] = [activeQuote.notes || ""];
    rows[r++] = [];
    rows[r++] = ["ä»˜æ¬¾æ¢ä»¶"];
    rows[r++] = [activeQuote.payment || ""];

    const ws = XLSX.utils.aoa_to_sheet(rows);

    ws["!merges"] = [
      { s: { r: 0, c: 0 }, e: { r: 0, c: 8 } },
      { s: { r: 1, c: 0 }, e: { r: 1, c: 8 } },
      { s: { r: 4, c: 1 }, e: { r: 4, c: 8 } },
      { s: { r: 5, c: 1 }, e: { r: 5, c: 8 } },
    ];
    
    ws["!cols"] = [{ wch: 12 }, { wch: 26 }, { wch: 42 }, { wch: 8 }, { wch: 8 }, { wch: 16 }, { wch: 18 }, { wch: 22 }, { wch: 32 }];

    Object.keys(ws).forEach(key => {
      if (ws[key]?.v && typeof ws[key].v === "number") ws[key].z = "#,##0";
    });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®");

    const filename = `${activeQuote.quoteNo}_${activeQuote.customerName || "æœªå¡«å®¢æˆ¶"}-${activeQuote.title || "æœªå‘½åå·¥ç¨‹"} å ±åƒ¹å–®.xlsx`.replace(/[\\/:*?"<>|]/g,"");
    XLSX.writeFile(wb, filename);
  };

  return (
    <button
      onClick={handleExport}
      className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
    >
      åŒ¯å‡º Excelï¼ˆå ±åƒ¹å–®ç‰ˆå‹ï¼‰
    </button>
  );
}

// ===============================
// Word åŒ¯å‡º
// ===============================
function ExportWordButton({ componentRef }) {
  const { activeQuote } = React.useContext(AppContext);

  const handleExportWord = () => {
    if (!componentRef?.current || !activeQuote) {
      alert("æ‰¾ä¸åˆ°å ±åƒ¹å–®å…§å®¹ï¼Œè«‹ç¢ºèªé è¦½å·²è¼‰å…¥");
      return;
    }

    const htmlContent = componentRef.current.innerHTML;

    const wordHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å·¥ç¨‹å ±åƒ¹å–®</title>
  <style>
    @page { size: A4; margin: 15mm; margin-top: 80mm; }
    body { margin: 0; padding: 0; }
    .word-page { width: 794px; margin: 0 auto; padding: 20px; box-sizing: border-box; font-family: "Microsoft JhengHei", sans-serif; font-size: 15px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #000; padding: 6px; font-size: 15px; vertical-align: top; }
    img { display: block; margin: 10px auto; max-width: 80%; height: auto; }
  </style>
</head>
<body>
  <div class="word-page">${htmlContent}</div>
</body>
</html>`;

    const filename = `${activeQuote.quoteNo}_${activeQuote.customerName || "æœªå¡«å®¢æˆ¶"}-${activeQuote.title || "æœªå‘½åå·¥ç¨‹"} å ±åƒ¹å–®.doc`.replace(/[\\/:*?"<>|]/g, "");
    const blob = new Blob(["\ufeff", wordHTML], { type: "application/msword;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <button onClick={handleExportWord} className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
      åŒ¯å‡º Wordï¼ˆå ±åƒ¹å–®ç‰ˆå‹ï¼‰
    </button>
  );
}
function PrintButton() {
  return (
    <button
      onClick={() => window.print()}
      className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
    >
      åˆ—å°å ±åƒ¹å–®
    </button>
  );
}

/***********************************************************
 * åˆ—å°æ’ç‰ˆçµ„ä»¶ï¼ˆPrintLayoutï¼‰â€” å®‰å…¨ç‰ˆ (æ¨™é¡Œä¸è£åˆ‡)
 ***********************************************************/
function PrintLayout({ quote, totalAmount, negotiatedAmount, isPreview }) {
  // 1. é˜²å‘†æª¢æŸ¥
  if (!quote || !COMPANY_DATA[quote.company]) {
    return (
      <div style={{ textAlign: "center", padding: 20, color: "#888" }}>
        è«‹é¸æ“‡æˆ–æ–°å¢å ±åƒ¹å–®ä»¥é¡¯ç¤ºé è¦½
      </div>
    );
  }

  // 2. è®Šæ•¸å®šç¾©
  const companyInfo = COMPANY_DATA[quote.company];
  const isLeakageMode = quote.items.some(i => i.name?.includes("æ¼æ¼¿")) || quote.title?.includes("æ¼æ¼¿");
  const itemsToPrint = isLeakageMode ? quote.items.filter(item => item.qty > 0) : quote.items;
  const showFinalPrice = (quote.discountPercent > 0) || (quote.negotiatedPrice > 0);
  const calcAmount = (item) => item.price * item.qty;

  // 3. æ¨£å¼å®šç¾©
  const TH_TD = { border: "1px solid #000", padding: "3px 4px", fontSize: "12px", verticalAlign: "middle", lineHeight: "1.2" };
  const TH = { ...TH_TD, background: "#f0f0f0", fontWeight: "bold", textAlign: "center", padding: "4px" };
  const TD_RIGHT = { ...TH_TD, textAlign: "right" };
  const TD_CENTER = { ...TH_TD, textAlign: "center" };

  return (
    <div className="print-page">
      {/* ä¿®æ­£ï¼šå°‡ä¸Šæ–¹é‚Šç•Œæ”¹å› 10mm ä»¥å…è£åˆ‡ */}
      <style>{`
        @media print {
          @page { margin: 10mm 10mm 10mm 10mm; size: auto; }
          body { margin: 0; }
        }
      `}</style>

      <div className="print-content">
        
        {/* ==========================================
            Part 1: è¡¨é ­è³‡æ–™å€
            ========================================== */}
        <table style={{ width: "100%", borderCollapse: "collapse", marginBottom: 5 }}>
          <tbody>
            <tr>
              <td colSpan="2" style={{ textAlign: "center", paddingBottom: 5 }}>
                <h2 style={{ margin: 0, fontSize: "24px", lineHeight: "1.2" }}>{companyInfo.name}</h2>
                <div style={{ fontSize: 11, marginTop: 4 }}>
                  çµ±ç·¨ï¼š{companyInfo.taxId} ï½œ é›»è©±ï¼š{companyInfo.tel} ï½œ å‚³çœŸï¼š{companyInfo.fax}
                </div>
                <div style={{ fontSize: 11 }}>{companyInfo.address}</div>
                <h3 style={{ marginTop: 8, fontSize: "20px", borderBottom: "2px solid #333", display: "inline-block", paddingBottom: 2 }}>å·¥ç¨‹å ±åƒ¹å–®</h3>
              </td>
            </tr>
            <tr>
              <td style={{ verticalAlign: "bottom", width: "60%", fontSize: 12, lineHeight: "1.4em" }}>
                 <div><strong>å®¢æˆ¶åç¨±ï¼š</strong>{quote.customerName}</div>
                 <div><strong>å·¥ç¨‹åç¨±ï¼š</strong>{quote.title}</div>
                 <div><strong>å·¥ç¨‹åœ°é»ï¼š</strong>{quote.location}</div>
                 <div><strong>è¯çµ¡é›»è©±ï¼š</strong>{quote.phone}</div>
              </td>
              <td style={{ verticalAlign: "bottom", width: "40%", textAlign: "right", fontSize: 12, lineHeight: "1.4em" }}>
                 <div><strong>å ±åƒ¹å–®è™Ÿï¼š</strong>{quote.quoteNo}</div>
                 <div><strong>å ±åƒ¹æ—¥æœŸï¼š</strong>{quote.date}</div>
                 <div><strong>è¯çµ¡äººï¼š</strong>{quote.contact}</div>
              </td>
            </tr>
          </tbody>
        </table> 


        {/* ==========================================
            Part 2: ä¸»é …ç›®åˆ—è¡¨
            ========================================== */}
        <table style={{ width: "100%", borderCollapse: "collapse", border: "2px solid black" }}>
          <colgroup>
            <col style={{ width: "5%" }} />
            <col style={{ width: "28%" }} />
            <col style={{ width: "28%" }} />
            <col style={{ width: "5%" }} />
            <col style={{ width: "6%" }} />
            <col style={{ width: "10%" }} />
            <col style={{ width: "10%" }} />
            <col style={{ width: "8%" }} />
          </colgroup>
          <thead>
            <tr>
              <th style={TH}>é …<br />æ¬¡</th>
              <th style={TH}>å“å</th>
              <th style={TH}>è¦æ ¼</th>
              <th style={TH}>å–®ä½</th>
              <th style={TH}>æ•¸é‡</th>
              <th style={TH}>å–®åƒ¹</th>
              <th style={TH}>å°è¨ˆ</th>
              <th style={TH}>å‚™è¨»</th>
            </tr>
          </thead>
          <tbody>
            {itemsToPrint.map((item, index) => (
              <React.Fragment key={item.id || index}>
                <tr>
                    <td style={TD_CENTER}>{index + 1}</td>
                    <td style={TH_TD}>{item.name}</td>
                    <td style={{ ...TH_TD, color: "#444" }}>{item.specMain}</td>
                    <td style={TD_CENTER}>{item.unit}</td>
                    <td style={TD_CENTER}>{item.qty}</td>
                    <td style={TD_RIGHT}>
                        {item.price > 0 ? formatMoney(item.price) : "-"}
                    </td>
                    <td style={{ ...TD_RIGHT, fontWeight: "bold" }}>
                        {calcAmount(item) > 0 ? formatMoney(calcAmount(item)) : "-"}
                    </td>
                    <td style={TH_TD}>{item.remarks}</td>
                </tr>
                {item.specMaterial && (
                  <tr>
                    <td style={{ ...TH_TD, borderTop: "none" }}></td>
                    <td colSpan="7" style={{ ...TH_TD, color: "#444", fontSize: "11px", borderTop: "1px dashed #ccc" }}>
                      <span style={{ fontWeight: "bold" }}>ç”¨æ–™ï¼š</span>{item.specMaterial}
                    </td>
                  </tr>
                )}
                {item.subItems && item.subItems.map(sub => (
                    <tr key={sub.id}>
                         <td style={{ ...TH_TD, borderTop: "none" }}></td>
                         <td colSpan="7" style={{ ...TH_TD, color: "#666", fontSize: "11px", textAlign: sub.type === "image" ? "center" : "left" }}>
                           {sub.type === "image" ? (
                             <img src={sub.imageData} alt="åœ–ç‰‡" style={{ maxWidth: "50%", maxHeight: "150px", display: "block", margin: "0 auto" }} />
                           ) : (
                             <span><span style={{fontWeight: "bold"}}>{sub.name}</span>ï¼š{sub.remarks}</span>
                           )}
                         </td>
                    </tr>
                ))}
              </React.Fragment>
            ))}

            {itemsToPrint.length === 0 && (
                <tr><td colSpan={8} style={{...TD_CENTER, padding: 10, color: "#999"}}>ç„¡é …ç›®</td></tr>
            )}
          </tbody>
        </table>


        {/* ==========================================
            Part 3: é‡‘é¡ç¸½çµ (å¼·åˆ¶ä¸æ›è¡Œ)
            ========================================== */}
        <table style={{ width: "100%", borderCollapse: "collapse", marginTop: 5 }}>
          <colgroup>
            <col style={{ width: "75%" }} />
            <col style={{ width: "20%" }} />
            <col style={{ width: "5%" }} />
          </colgroup>
          <tbody>
            <tr>
              <td style={{ ...TD_RIGHT, fontWeight: "bold", border: "none" }}>
                ç¸½è¨ˆé‡‘é¡ï¼ˆæœªç¨…ï¼‰
              </td>
              <td style={{ ...TD_RIGHT, fontWeight: "bold", whiteSpace: "nowrap", borderBottom: "1px solid #000" }}>
                {formatMoney(totalAmount)}
              </td>
              <td style={{ ...TH_TD, border: "none" }}></td>
            </tr>
            {showFinalPrice && (
                <tr>
                  <td style={{ ...TD_RIGHT, fontWeight: "bold", border: "none" }}>
                    æœ€çµ‚å ±åƒ¹é‡‘é¡ï¼ˆæœªç¨…ï¼‰
                  </td>
                  <td style={{ ...TD_RIGHT, fontWeight: "bold", color: "red", whiteSpace: "nowrap", borderBottom: "1px solid #000" }}>
                    {formatMoney(negotiatedAmount)}
                  </td>
                  <td style={{ ...TH_TD, border: "none" }}></td>
                </tr>
            )}
          </tbody>
        </table>


        {/* ==========================================
            Part 4: å¯¦æ”¯å¯¦ä»˜é›¶ä»¶è¡¨
            ========================================== */}
        {quote.leakageParts && quote.leakageParts.length > 0 && (
        <div className="mt-2 mb-2 page-break-inside-avoid">
            <div className="font-bold text-gray-800 mb-1 pl-2 border-l-2 border-blue-600 text-xs">
            â€» å¯¦æ”¯å¯¦ä»˜ç¶­ä¿®é›¶ä»¶åƒ¹ç›®è¡¨
            <span className="text-[10px] font-normal text-gray-500 ml-2">
                (ä¸è¨ˆå…¥ç¸½é¡ï¼Œä¾å¯¦ä½œæ•¸é‡è¨ˆåƒ¹)
            </span>
            </div>
            
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: "11px", border: "1px solid #ccc" }}>
            <thead>
                <tr style={{ backgroundColor: "#f4f4f4", borderBottom: "1px solid #ccc" }}>
                    <th style={{ padding: "2px 4px", textAlign: "left", width: "35%" }}>å“å</th>
                    <th style={{ padding: "2px 4px", textAlign: "left", width: "35%" }}>è¦æ ¼</th>
                    <th style={{ padding: "2px 4px", textAlign: "center", width: "10%" }}>å–®ä½</th>
                    <th style={{ padding: "2px 4px", textAlign: "right", width: "20%" }}>å–®åƒ¹</th>
                </tr>
            </thead>
            <tbody>
                {quote.leakageParts.map((part, idx) => (
                    <tr key={idx} style={{ borderBottom: "1px solid #eee" }}>
                        <td style={{ padding: "1px 4px" }}>{part.name}</td>
                        <td style={{ padding: "1px 4px", color: "#555" }}>{part.spec}</td>
                        <td style={{ padding: "1px 4px", textAlign: "center" }}>{part.unit}</td>
                        <td style={{ padding: "1px 4px", textAlign: "right", fontWeight: "bold" }}>
                            ${Number(part.price).toLocaleString()}
                        </td>
                    </tr>
                ))}
            </tbody>
            </table>
        </div>
        )}


       {/* ==========================================
            Part 5: é å°¾ & ç°½å (æš´åŠ›ä¿®å¾©ç‰ˆï¼šå¯¬åº¦ 98% + ç½®ä¸­)
            ========================================== */}
        <div className="print-footer-block">
            <table style={{ width: "100%", borderCollapse: "collapse", marginTop: 5 }}>
                <tbody>
                <tr>
                    <td style={{ ...TH_TD, width: "50%", verticalAlign: "top", fontSize: "11px" }}>
                        <strong>å‚™è¨»ï¼š</strong>
                        <div style={{ whiteSpace: "pre-wrap", marginTop: 2 }}>{quote.notes}</div>
                    </td>
                    <td style={{ ...TH_TD, width: "50%", verticalAlign: "top", fontSize: "11px" }}>
                        <strong>ä»˜æ¬¾æ¢ä»¶ï¼š</strong>
                        <div style={{ whiteSpace: "pre-wrap", marginTop: 2 }}>{quote.payment}</div>
                    </td>
                </tr>
                </tbody>
            </table>
            
            {/* â–¼â–¼â–¼ ä¿®æ”¹é‡é»ï¼šå¯¬åº¦æ”¹ 98%ï¼ŒåŠ å…¥ margin: "10px auto" è®“å®ƒç½®ä¸­ â–¼â–¼â–¼ */}
            <table className="print-signature-area" style={{ width: "98%", margin: "10px auto", borderCollapse: "collapse", borderRight: "1px solid #000" }}>
                <tbody>
                <tr>
                    {/* é€™è£¡åŠ å…¥ borderRight ç¢ºä¿ä¸­é–“é‚£æ¢ç·šä¹Ÿåœ¨ */}
                    <td style={{ ...TH_TD, width: "50%", height: 80, verticalAlign: "top", padding: "5px", borderRight: "1px solid #000" }}>
                        <strong>å…¬å¸å ±åƒ¹ç« </strong>
                        {companyInfo.stamp && (
                            <img src={companyInfo.stamp} alt="å…¬å¸å°ç« " style={{ display: "block", margin: "2px auto", maxHeight: 60 }} />
                        )}
                    </td>
                    {/* å¼·åˆ¶åŠ ä¸Šå³é‚Šæ¡† */}
                    <td style={{ ...TH_TD, width: "50%", height: 80, verticalAlign: "top", padding: "5px", borderRight: "1px solid #000" }}>
                        <strong>å®¢æˆ¶å›ç°½</strong>
                    </td>
                </tr>
                <tr>
                    <td style={{...TH_TD, borderTop: "none", fontSize: "11px", borderRight: "1px solid #000"}}>æ—¥æœŸï¼š</td>
                    <td style={{...TH_TD, borderTop: "none", fontSize: "11px", borderRight: "1px solid #000"}}>æ—¥æœŸï¼š</td>
                </tr>
                </tbody>
            </table>
        </div>

      </div>
    </div>
  );
}

/* ========================================================
   â˜… æ–°å¢çµ„ä»¶ï¼šå¯¦æ”¯å¯¦ä»˜é›¶ä»¶ç·¨è¼¯å™¨ (LeakagePartsEditor)
   ======================================================== */
function LeakagePartsEditor({ parts, updateQuote }) {
  const handleChange = (id, field, value) => {
    const newParts = parts.map(p => p.id === id ? { ...p, [field]: value } : p);
    updateQuote({ leakageParts: newParts });
  };

  // â­ æ–°å¢ï¼šè™•ç†è¦æ ¼åˆ‡æ›çš„å‡½å¼
  const handleVariantChange = (id, variantLabel) => {
    const targetPart = parts.find(p => p.id === id);
    if (!targetPart || !targetPart.variants) return;

    // æ‰¾åˆ°å°æ‡‰çš„é¸é …è³‡æ–™
    const selectedVariant = targetPart.variants.find(v => v.label === variantLabel);
    if (selectedVariant) {
      // åŒæ™‚æ›´æ–°ï¼šè¦æ ¼ã€å–®åƒ¹ (ä¹Ÿå¯ä»¥é¸æ“‡æ˜¯å¦æ›´æ–°å“åï¼Œé€™è£¡ä¿ç•™åŸå“å)
      const newParts = parts.map(p => p.id === id ? { 
        ...p, 
        spec: selectedVariant.spec, 
        price: selectedVariant.price,
        selectedVariantLabel: variantLabel // ç´€éŒ„ç•¶å‰é¸åˆ°çš„ï¼Œæ–¹ä¾¿ UI é¡¯ç¤º
      } : p);
      updateQuote({ leakageParts: newParts });
    }
  };

  const handleDelete = (id) => {
    if(!window.confirm("ç¢ºå®šåˆªé™¤æ­¤é›¶ä»¶å—ï¼Ÿ")) return;
    const newParts = parts.filter(p => p.id !== id);
    updateQuote({ leakageParts: newParts });
  };

  const handleAdd = () => {
    const newPart = { id: uuid(), name: "", spec: "", unit: "å¼", price: 0 };
    updateQuote({ leakageParts: [...(parts || []), newPart] });
  };

  return (
    <div className="mt-8 mb-6 border-t pt-6 page-break-inside-avoid">
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-bold text-gray-700 border-l-4 border-blue-500 pl-2">
          â€» å¯¦æ”¯å¯¦ä»˜ç¶­ä¿®é›¶ä»¶æ¸…å–®
          <span className="text-sm font-normal text-gray-500 ml-2">(æ­¤å€ä¸è¨ˆå…¥ç¸½å ±åƒ¹)</span>
        </h3>
        <button 
          onClick={handleAdd} 
          className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 shadow flex items-center gap-1"
        >
          <span>ï¼‹</span> æ–°å¢é›¶ä»¶
        </button>
      </div>

      <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
        <div className="grid grid-cols-12 gap-2 text-sm text-gray-500 mb-2 px-2">
           <div className="col-span-4">å“å</div>
           <div className="col-span-4">è¦æ ¼èªªæ˜ (å¯åˆ‡æ›ç‰ˆæœ¬)</div>
           <div className="col-span-1 text-center">å–®ä½</div>
           <div className="col-span-2 text-right">å–®åƒ¹</div>
           <div className="col-span-1"></div>
        </div>

        {(parts || []).map((part, index) => (
          <div key={part.id} className="grid grid-cols-12 gap-2 mb-2 items-center">
             
             {/* 1. å“å */}
             <div className="col-span-4">
                <input 
                  className="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none" 
                  placeholder="è¼¸å…¥é›¶ä»¶åç¨±..."
                  value={part.name} 
                  onChange={(e) => handleChange(part.id, "name", e.target.value)}
                />
             </div>

             {/* 2. è¦æ ¼èªªæ˜ (å¦‚æœæœ‰é¸é …ï¼Œé¡¯ç¤ºä¸‹æ‹‰é¸å–®ï¼›å¦å‰‡é¡¯ç¤ºè¼¸å…¥æ¡†) */}
             <div className="col-span-4">
                {part.variants && part.variants.length > 0 ? (
                  <div className="flex gap-1">
                    {/* ä¸‹æ‹‰é¸å–®å€åŸŸ */}
                    <select
                      className="w-full border p-2 rounded text-sm bg-yellow-50 focus:ring-2 focus:ring-yellow-200 outline-none cursor-pointer text-blue-700 font-bold"
                      value={part.selectedVariantLabel || (part.variants.find(v => v.price === part.price)?.label) || ""}
                      onChange={(e) => handleVariantChange(part.id, e.target.value)}
                    >
                      {part.variants.map((v, i) => (
                        <option key={i} value={v.label}>
                          {v.label} - ${v.price.toLocaleString()}
                        </option>
                      ))}
                    </select>
                  </div>
                ) : (
                  <input 
                    className="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none" 
                    placeholder="è¼¸å…¥è¦æ ¼..."
                    value={part.spec} 
                    onChange={(e) => handleChange(part.id, "spec", e.target.value)}
                  />
                )}
             </div>

             {/* 3. å–®ä½ */}
             <div className="col-span-1">
                <input 
                  className="w-full border p-2 rounded text-sm text-center focus:ring-2 focus:ring-blue-200 outline-none" 
                  value={part.unit} 
                  onChange={(e) => handleChange(part.id, "unit", e.target.value)}
                />
             </div>

             {/* 4. å–®åƒ¹ (å¦‚æœæ˜¯ä¸‹æ‹‰é¸å–®æ¨¡å¼ï¼Œå»ºè­°é–å®šå–®åƒ¹æˆ–è®Šè‰²æç¤º) */}
             <div className="col-span-2">
                <input 
                  type="number"
                  className={`w-full border p-2 rounded text-sm text-right focus:ring-2 focus:ring-blue-200 outline-none font-bold ${part.variants ? 'text-blue-600 bg-gray-50' : 'text-gray-700'}`}
                  value={part.price} 
                  onFocus={(e) => e.target.select()}
                  onChange={(e) => handleChange(part.id, "price", e.target.value)}
                />
             </div>

             {/* 5. åˆªé™¤æŒ‰éˆ• */}
             <div className="col-span-1 text-center">
                <button 
                  onClick={() => handleDelete(part.id)} 
                  className="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition-colors"
                  title="åˆªé™¤"
                >
                  âœ•
                </button>
             </div>
          </div>
        ))}

        {(parts || []).length === 0 && (
            <div className="text-gray-400 text-center py-6 border-2 border-dashed border-gray-200 rounded">
                ç›®å‰æ²’æœ‰é›¶ä»¶é …ç›®ï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ã€‚
            </div>
        )}
      </div>
    </div>
  );
}

/***********************************************************
  // P5 â€” App æ ¹å…ƒä»¶ (å®Œæ•´ä¿®å¾©ç‰ˆ)
 ***********************************************************/
function App() {
  const { 
    quotes, setQuotes, 
    activeQuoteId, setActiveQuoteId,
    company 
  } = React.useContext(AppContext);

  // (1) æ–°å»ºå ±åƒ¹å–®
  const createQuote = React.useCallback((modeId = null) => {
    const mode = MODE_CONFIG.find(m => m.id === modeId) || MODE_CONFIG[0];
    const newQuote = {
      id: uuid(),
      company: company, 
      quoteNo: generateQuoteNo(company),
      title: mode.defaultTitle,
      customerName: "",
      date: formatDate(),
      items: mode.defaultItems.map(item => ({ ...item, id: uuid() })), 
      leakageParts: [], 
      notes: mode.defaultNotes,
      payment: mode.defaultPayment,
      discountPercent: 0,
      negotiatedPrice: 0
    };
    setQuotes(prev => [newQuote, ...prev]);
    setActiveQuoteId(newQuote.id);
  }, [company, setQuotes, setActiveQuoteId]);

  // (2) åˆªé™¤å ±åƒ¹å–®
  const deleteQuote = React.useCallback((id) => {
    setQuotes(prev => prev.filter(q => q.id !== id));
    if (activeQuoteId === id) setActiveQuoteId(null);
  }, [activeQuoteId, setQuotes, setActiveQuoteId]);

  // (3) æ›´æ–°å ±åƒ¹å–®
  const updateQuote = React.useCallback((id, data) => {
    setQuotes(prev => prev.map(q => q.id === id ? { ...q, ...data } : q));
  }, [setQuotes]);

  // (4) è¤‡è£½å ±åƒ¹å–®
  const duplicateQuote = React.useCallback((id) => {
    const sourceQuote = quotes.find(q => q.id === id);
    if (!sourceQuote) return;

    const newQuote = {
      ...JSON.parse(JSON.stringify(sourceQuote)), 
      id: uuid(),                                
      quoteNo: generateQuoteNo(sourceQuote.company), 
      title: `${sourceQuote.title} (å‰¯æœ¬)`,       
      date: formatDate(),                        
      items: sourceQuote.items.map(item => ({ ...item, id: uuid() })),
      leakageParts: (sourceQuote.leakageParts || []).map(part => ({ ...part, id: uuid() }))
    };

    setQuotes(prev => [newQuote, ...prev]);
    setActiveQuoteId(newQuote.id);
  }, [quotes, setQuotes, setActiveQuoteId]);

  // (5) å¥—ç”¨æ¨¡å¼
  const applyMode = React.useCallback((modeId) => {
    if (!activeQuoteId) return;
    const mode = MODE_CONFIG.find(m => m.id === modeId);
    if (!mode) return;
    if (!window.confirm("ç¢ºå®šè¦è¦†è“‹ç•¶å‰å ±åƒ¹å–®å…§å®¹å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;
    const newItems = mode.defaultItems.map(item => ({ ...item, id: uuid() }));
    updateQuote(activeQuoteId, {
      items: newItems,
      leakageParts: [],
      notes: mode.defaultNotes,
      payment: mode.defaultPayment
    });
  }, [activeQuoteId, updateQuote]);

  // UI ä»‹é¢
  return (
    <div className="min-h-screen bg-gray-50 flex print:block print:bg-white">
        {/* å´é‚Šæ¬„ */}
        <div className="w-96 bg-white p-6 shadow-lg flex-shrink-0 text-lg sticky top-0 h-screen overflow-y-auto no-print">
            <h1 className="text-2xl font-extrabold mb-6 text-center text-blue-700">å·¥ç¨‹å ±åƒ¹ç³»çµ±</h1>
            <CompanySelector />
            <ModeSelector applyMode={applyMode} />
            <QuoteList 
                quotes={quotes} 
                activeId={activeQuoteId} 
                selectQuote={setActiveQuoteId} 
                deleteQuote={deleteQuote} 
                duplicateQuote={duplicateQuote} 
            />
        </div>
        {/* ä¸»ç·¨è¼¯å€ */}
        <div className="flex-grow p-8 text-base print:p-0">
            <QuoteEditor updateQuote={updateQuote} />
        </div>
    </div>
  );
}

/***********************************************************
 * P6 â€” React 18 å•Ÿå‹•
 ***********************************************************/
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(
  <AppProvider>
    <App />
  </AppProvider>
);
