<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>工程報價系統（Herhsin & SinChang）- V28 簽名欄保護與定位修正版</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      background: #f3f4f6;
      font-family: "Microsoft JhengHei", sans-serif;
    }

    /* =========================================
       1. 螢幕預覽區樣式 (Live Preview Box)
       這裡的設定只會影響您在網頁上看到的那個框框
       ========================================= */
    .live-preview-box {
      padding: 40px 0;
      background: #f3f4f6;
    }

    .print-page {
      margin: 0 auto;
      background: #ffffff;
      padding: 20px;
      box-shadow: 0 0 12px rgba(0,0,0,0.15);
      box-sizing: border-box;
      position: relative;
      overflow: hidden; /* 防止內容溢出 */
    }

    
 
 /* =================================================
   ✅ 最終穩定版｜工程報價單列印專用 CSS
================================================= */
@media print {
  /* 先隱藏所有 print-page */
  .print-page {
    display: none !important;
  }

  /* 只顯示 print-only-layout 裡面的 print-page */
  .print-only-layout .print-page {
    display: block !important;
  }
}
  body,
  #root {
    margin: 0;
    padding: 0;
    display: block !important;
    width: 100% !important;
  }

  .no-print,
  .live-preview-box {
    display: none !important;
  }

  /* 解除左右分欄（超關鍵） */
  .flex,
  .min-h-screen {
    display: block !important;
    width: 100% !important;
  }

  .print-only-layout {
  position: static !important;
  display: block !important;
  width: 100% !important;
  height: auto !important;
  opacity: 1 !important;
}

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead {
    display: table-header-group;
  }

  tr, th, td {
    page-break-inside: avoid;
  }

  .print-footer-block,
  .print-signature-area {
    page-break-inside: avoid;
  }
}


  
  </style>
</head>

<body class="text-gray-900">
  <div id="root"></div>

  <script type="text/babel">

/***********************************************************
 * P1 — 公司資料 / 備註 / 付款條件 / 模式模板
 ***********************************************************/
const COMPANY_DATA = {
  herhsin: {
    name: "何鑫實業股份有限公司",
    taxId: "76380260",  
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831高雄市大寮區鳳屏二路383-8號",
    stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
    prefix: "QH",
  },
  sinchang: {
    name: "薪昌股份有限公司",
    taxId: "53896738",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831高雄市大寮區鳳屏二路383-8號",
    stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
    prefix: "QS",
  },
};

const DEFAULT_NOTES = `1. 本報價未含加值稅。
2. 安裝施作時需注意現場作業環境。
3. 報價單有效期限為 15 天。
4. 若遇不可抗力因素造成延誤，工期順延。
5. 料件須由本公司提供與安裝，否則不在保固範圍內。
6. 付款條件依雙方合約內容為準。`;

const DEFAULT_PAYMENT = `訂金：40%
製作完成：30%
安裝完成：20%
完工驗收：10%`;

/***********************************************************
 * 報價模式模板（QUOTE_MODES）
 ***********************************************************/
const QUOTE_MODES = [
  {
    id: "mode_leak_repair",
    name: "拌合機漏漿更換工程",
    description: "拌合機漏漿修復，包工包料項目另計，零件實支實付",
    defaultItems: [
      {
        name: "更換 3m³ 拌合機【減速機側】漏漿（含工資及材料）",
        unit: "式",
        qty: 1,
        price: 0,
        specMain: "含拆裝、調整、測試",
        specMaterial: "",
        remarks: "",
        type: "main",
        subItems: []
      },
      {
        name: "更換 3m³ 拌合機【非減速機側】漏漿（含工資及材料）",
        unit: "式",
        qty: 1,
        price: 0,
        specMain: "含拆裝、調整、測試",
        specMaterial: "",
        remarks: "",
        type: "main",
        subItems: []
      }
    ],
    referenceItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeB",
    name: "設備銷售",
    description: "適用備品、單機銷售與安裝。",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  },
  {
    id: "modeC",
    name: "設備更換工程",
    description: "適用整機更新、料件更換工程。",
    defaultItems: [],
    defaultNotes: DEFAULT_NOTES,
    defaultPayment: DEFAULT_PAYMENT
  }
];

/***********************************************************
  * P2 — 工具函式
 ***********************************************************/
function uuid() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}

function formatDate(dateStr = new Date()) {
    const d = dateStr instanceof Date ? dateStr : new Date(dateStr);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
}

function formatMoney(num) {
    if (num === "" || num === null || num === undefined || isNaN(Number(num))) return "0"; 
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 0 });
}

function calcAmount(item) {
    const qty = Number(item.qty || 0);
    const price = Number(item.price || 0);
    return qty * price;
}

function calcTotal(items) {
    return items.reduce((sum, it) => {
        if (it.type === "reference") return sum;

        let mainAmt = calcAmount(it);
        let subs = 0;

        if (it.subItems && it.subItems.length > 0) {
            subs = it.subItems.reduce(
                (s, sub) => (sub.type === "item" ? s + calcAmount(sub) : s),
                0
            );
        }

        return sum + mainAmt + subs;
    }, 0);
}

function calcNegotiated(total, discountPercent, customPrice) {
    const cp = Number(customPrice || 0);
    const dp = Number(discountPercent || 0);
    
    if (cp > 0) return cp;
    
    if (dp > 0 && dp <= 100) {
        return Math.round(total * (1 - dp / 100));
    }
    
    return total;
}

function generateQuoteNo(companyKey = "sinchang") {
  const prefix = COMPANY_DATA[companyKey]?.prefix || "QS";

  const d = new Date();
  const yy = String(d.getFullYear()).slice(-2);
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");

  const dateKey = `${yy}${mm}${dd}`;
  const storageKey = `quote_seq_${companyKey}_${dateKey}`;

  let seq = Number(localStorage.getItem(storageKey) || "0") + 1;

  if (seq > 99) {
    alert("今日報價單已超過 99 張，請確認");
    seq = 99;
  }

  localStorage.setItem(storageKey, seq);

  const nn = String(seq).padStart(2, "0");
  return `${prefix}${dateKey}${nn}`;
}


async function loadCSV(url) {
    try {
        const res = await fetch(url);
        const text = await res.text();
        
        const rows = text.split("\n").map(r => r.trim()).filter(r => r.length > 0);
        if (rows.length < 2) return [];
        
        const header = rows[0].split(",").map(h => h.trim().replace(/"/g, ''));

        return rows.slice(1).map(row => {
            const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};

            header.forEach((h, i) => {
                let value = cols[i] ? cols[i].trim() : "";
                if (value.startsWith('"') && value.endsWith('"')) {
                    value = value.substring(1, value.length - 1);
                }
                obj[h] = value;
            });
            return obj;
        });
    } catch (error) {
        console.error("載入或解析 Google Sheet CSV 失敗:", error);
        return [];
    }
}

/***********************************************************
 * P3 — AppContext（資料中心）
 ***********************************************************/
const AppContext = React.createContext();

function AppProvider({ children }) {
  const [company, setCompany] = React.useState("herhsin");
  const [quotes, setQuotes] = React.useState([]);
  const [activeQuoteId, setActiveQuoteId] = React.useState(null);
  const [specItems, setSpecItems] = React.useState([]);

  const SPEC_CSV_URL =
    "https://docs.google.com/spreadsheets/d/1wjoNesgvgmkVoG4bI9ppl_1EktH88WZ6bxT9IeyX4YM/export?format=csv";

  const loadSpecItems = React.useCallback(() => {
    loadCSV(SPEC_CSV_URL).then(data => setSpecItems(data));
  }, []);

  React.useEffect(() => {
    loadSpecItems();
  }, [loadSpecItems]);

  React.useEffect(() => {
    const saved = localStorage.getItem("HERHSIN_QUOTES");
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (Array.isArray(parsed)) {
          setQuotes(parsed);
          if (parsed.length > 0) setActiveQuoteId(parsed[0].id);
        }
      } catch (e) {
        setQuotes([]);
        setActiveQuoteId(null);
      }
    }
  }, []);

  React.useEffect(() => {
    localStorage.setItem("HERHSIN_QUOTES", JSON.stringify(quotes));
  }, [quotes]);

  const createQuote = React.useCallback((modeId) => {
    const mode = QUOTE_MODES.find(m => m.id === modeId);
    
    const newQuote = {
        id: uuid(),
        company: company,
        quoteNo: generateQuoteNo(company),
        title: "",
        customerName: "",
        contact: "",
        phone: "",
        location: "",
        date: formatDate(),
        items: mode ? JSON.parse(JSON.stringify(mode.defaultItems)) : [],
        notes: mode ? mode.defaultNotes : DEFAULT_NOTES,
        payment: mode ? mode.defaultPayment : DEFAULT_PAYMENT,
        discountPercent: 0,
        negotiatedPrice: 0
    };

    setQuotes(prev => [newQuote, ...prev]);
    setActiveQuoteId(newQuote.id);
  }, [company]);

  const deleteQuote = React.useCallback((id) => {
    setQuotes(prev => prev.filter(q => q.id !== id));
    if (activeQuoteId === id) setActiveQuoteId(null);
  }, [activeQuoteId]);

  const updateQuote = React.useCallback((id, data) => {
    setQuotes(prev => prev.map(q => q.id === id ? { ...q, ...data } : q));
  }, []);

  const applyMode = React.useCallback((modeId) => {
    if (!activeQuoteId) return;
    const mode = QUOTE_MODES.find(m => m.id === modeId);
    if (!mode) return;

    if (!window.confirm("確定要覆蓋當前報價單內容嗎？此動作無法復原。")) return;

    updateQuote(activeQuoteId, {
        items: JSON.parse(JSON.stringify(mode.defaultItems)),
        notes: mode.defaultNotes,
        payment: mode.defaultPayment
    });
  }, [activeQuoteId, updateQuote]);

  const activeQuote = quotes.find(q => q.id === activeQuoteId);

  const value = {
    company,
    setCompany,
    quotes,
    setQuotes,
    activeQuote,
    activeQuoteId,
    setActiveQuoteId,
    specItems,
    loadSpecItems,
    createQuote,
    deleteQuote,
    updateQuote,
    applyMode
  };

  window.__APP_CONTEXT__ = value;

  return (
    <AppContext.Provider value={value}>
      {children}
    </AppContext.Provider>
  );
}


/***********************************************************
 * P4-1 — 公司切換 / 模式選擇 / 報價單列表
 ***********************************************************/
function CompanySelector() {
  const { company, setCompany, activeQuote, updateQuote } = React.useContext(AppContext);

  const handleSetCompany = (newCompany) => {
    setCompany(newCompany);
    if (activeQuote) {
      updateQuote(activeQuote.id, {
        company: newCompany,
        quoteNo: generateQuoteNo(newCompany)
      });
    }
  };

  return (
    <div className="mb-8 no-print">
      <div className="text-base font-semibold text-gray-700 mb-3">
        選擇公司
      </div>

      <div className="flex gap-3">
        <button
          className={`flex-1 px-4 py-2 text-base rounded-md transition ${
            company === "herhsin"
              ? "bg-blue-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => handleSetCompany("herhsin")}
        >
          何鑫實業
        </button>

        <button
          className={`flex-1 px-4 py-2 text-base rounded-md transition ${
            company === "sinchang"
              ? "bg-blue-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => handleSetCompany("sinchang")}
        >
          薪昌股份有限公司
        </button>
      </div>
    </div>
  );
}

function ModeSelector() {
  const { createQuote, applyMode } = React.useContext(AppContext);

  const [selectedMode, setSelectedMode] = React.useState("");
  const [isNew, setIsNew] = React.useState(true);

  const handleApply = () => {
    if (!selectedMode) return;
    isNew ? createQuote(selectedMode) : applyMode(selectedMode);
    setSelectedMode("");
  };

  return (
    <div className="mb-8 pb-6 border-b border-gray-300 no-print">
      <div className="text-base font-semibold text-gray-700 mb-3">
        模式套用（{isNew ? "新建" : "覆蓋"}）
      </div>

      <div className="flex gap-3 mb-4">
        <button
          className={`flex-1 px-4 py-2 text-base rounded-md ${
            isNew
              ? "bg-green-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => setIsNew(true)}
        >
          新建報價單
        </button>

        <button
          className={`flex-1 px-4 py-2 text-base rounded-md ${
            !isNew
              ? "bg-orange-600 text-white"
              : "bg-gray-200 hover:bg-gray-300"
          }`}
          onClick={() => setIsNew(false)}
        >
          套用至當前
        </button>
      </div>

      <select
        className="w-full border px-3 py-2 mb-4 rounded-md text-base"
        value={selectedMode}
        onChange={e => setSelectedMode(e.target.value)}
      >
        <option value="" disabled>請選擇報價模式</option>
        {QUOTE_MODES.map(mode => (
          <option key={mode.id} value={mode.id}>
            {mode.name} — {mode.description}
          </option>
        ))}
      </select>

      <button
        className="w-full bg-blue-600 text-white py-2.5 rounded-md text-base hover:bg-blue-700 disabled:opacity-50"
        onClick={handleApply}
        disabled={!selectedMode}
      >
        {isNew ? "新建報價單並套用模式" : "套用模式至當前報價單"}
      </button>
    </div>
  );
}

function QuoteList() {
  const { quotes, activeQuoteId, setActiveQuoteId, createQuote, deleteQuote } = React.useContext(AppContext);

  return (
    <div className="no-print">
      <div className="flex justify-between items-center mb-3">
        <div className="text-base font-semibold text-gray-700">
          報價單列表
        </div>
        <button
          className="text-sm px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700"
          onClick={() => createQuote(null)}
        >
          + 新建空白
        </button>
      </div>

      <div className="space-y-3 max-h-[420px] overflow-y-auto">
        {quotes.length === 0 && (
          <div className="text-gray-400 text-sm">
            尚無報價單，請先新建。
          </div>
        )}

        {quotes.map(q => (
          <div
            key={q.id}
            className={`p-3 rounded-md border cursor-pointer flex justify-between items-start transition ${
              q.id === activeQuoteId
                ? "bg-blue-50 border-blue-400"
                : "bg-white hover:bg-gray-50"
            }`}
            onClick={() => setActiveQuoteId(q.id)}
          >
            <div className="text-sm">
              <div className="font-semibold mb-0.5">
                {q.title || "未命名工程"}
              </div>
              <div className="text-gray-500">
                {q.quoteNo}
              </div>
              {q.customerName && (
                <div className="text-gray-500">
                  客戶：{q.customerName}
                </div>
              )}
            </div>

            <button
              className="ml-2 text-sm text-red-600 hover:text-red-800"
              onClick={(e) => {
                e.stopPropagation();
                if (window.confirm("確定要刪除此報價單？")) {
                  deleteQuote(q.id);
                }
              }}
            >
              刪除
            </button>
          </div>
        ))}
      </div>
    </div>
  );
}

/***********************************************************
 * P4-2 — 單一報價項目編輯（放大字級版）
 ***********************************************************/
function QuoteItem({ item, index, updateItem, deleteItem }) {
  const { specItems } = React.useContext(AppContext);
  const [showSub, setShowSub] = React.useState(true);

  const handleChange = (field, value) => {
    updateItem({ [field]: value });
  };

  const handleAddSubText = () => {
    const newSub = {
      id: uuid(),
      type: "text",
      name: "",
      remarks: ""
    };
    updateItem({ subItems: [...(item.subItems || []), newSub] });
  };

  const handleAddSubImage = (file) => {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const newSub = {
        id: uuid(),
        type: "image",
        name: "",
        imageData: reader.result
      };
      updateItem({ subItems: [...(item.subItems || []), newSub] });
    };
    reader.readAsDataURL(file);
  };

  /* 刪除子項 */
  const handleDeleteSub = (subId) => {
    const newSubItems = item.subItems.filter(s => s.id !== subId);
    updateItem({ subItems: newSubItems });
  };

  /* 更新子項 */
  const handleUpdateSub = (subId, field, value) => {
    const newSubItems = item.subItems.map(s => 
      s.id === subId ? { ...s, [field]: value } : s
    );
    updateItem({ subItems: newSubItems });
  };

  return (
    <div className="mb-8 border rounded-xl bg-white shadow-md p-6 text-lg leading-relaxed">

      {/* ===== 項次標題列 ===== */}
      <div className="flex justify-between items-center mb-4">
        <div className="text-xl font-bold text-blue-700">
          項次 {index + 1}：{item.name || "未命名"}
        </div>
        <div className="flex gap-2">
          <button
            className="px-3 py-1 border rounded text-base"
            onClick={() => setShowSub(!showSub)}
          >
            {showSub ? "收合" : "展開"}
          </button>
          <button
            className="px-3 py-1 bg-red-500 text-white rounded text-base"
            onClick={() => deleteItem(item.id)}
          >
            刪除此項
          </button>
        </div>
      </div>

      {/* ===== 主欄位 ===== */}
      <div className="grid grid-cols-4 gap-6">

  {/* 品名 */}
 <div className="col-span-1">
  <label className="block text-base font-semibold text-gray-700 mb-1">
    品名
  </label>

  <input
    type="text"
    list={`spec-list-${item.id}`}
    className="w-full border rounded-lg px-3 py-2"
    value={item.name || ""}
    onChange={(e) => {
      const value = e.target.value;
      handleChange("name", value);
    }}
    onBlur={(e) => {
      const value = e.target.value;

      const matched = specItems.find(
        r => (r["品名"] || "") === value
      );

      if (!matched) return;

      const materials = [
        matched["用料1"],
        matched["用料2"],
        matched["用料3"]
      ]
        .filter(v => typeof v === "string" && v.trim() !== "")
        .join("、");

      updateItem({
        name: matched["品名"] || "",
        unit: matched["單位"] || "",
        price: Number(matched["單價"] || 0),
        specMain: matched["規格"] || "",  
        specMaterial: materials           
      });
    }}
  />

  <datalist id={`spec-list-${item.id}`}>
    {specItems.map((r, i) => (
      <option key={i} value={r["品名"] || ""}>
        {r["規格"] ? `(${r["規格"]})` : ""}
      </option>
    ))}
  </datalist>
</div>

  {/* 規格說明（放右邊） */}
  <div className="col-span-3">
    <label className="block text-base font-semibold text-gray-700 mb-1">
      規格說明
    </label>
    <textarea
     className="w-full border rounded-lg px-3 py-2"
      rows="2"
      value={item.specMain || ""}
      onChange={(e) => handleChange("specMain", e.target.value)}
    />
  </div>

        <div>
          <label className="block text-base font-semibold text-gray-700 mb-1">單位</label>
          <input
            className="w-full border rounded-lg px-3 py-2"
            value={item.unit || ""}
            onChange={(e) => handleChange("unit", e.target.value)}
          />
        </div>

        <div>
          <label className="block text-base font-semibold text-gray-700 mb-1">數量</label>
          <input
            type="number"
            className="w-full border rounded-lg px-3 py-2 text-right"
            value={item.qty}
            onChange={(e) => handleChange("qty", Number(e.target.value))}
          />
        </div>

        <div>
  {/* ⭐ 德製 / 台製（只有有 variants 才顯示） */}
  {Array.isArray(item.variants) && (
    <>
      <label className="block text-base font-semibold text-gray-700 mb-1">
        品牌 / 產地
      </label>

      <select
        className="w-full border rounded-lg px-3 py-2 mb-2"
        value={item.selected}
        onChange={(e) => {
          const selectedKey = e.target.value;
          const variant = item.variants.find(v => v.key === selectedKey);

          updateItem({
            selected: selectedKey,
            price: variant ? variant.defaultPrice : item.price
          });
        }}
      >
        {item.variants.map(v => (
          <option key={v.key} value={v.key}>
            {v.label}
          </option>
        ))}
      </select>
    </>
  )}

  {/* 原本的單價（保留，可手動改） */}
  <label className="block text-base font-semibold text-gray-700 mb-1">
    單價
  </label>
  <input
    type="number"
    className="w-full border rounded-lg px-3 py-2 text-right"
    value={item.price}
    onChange={(e) => handleChange("price", Number(e.target.value))}
  />
</div>

        <div>
          <label className="block text-base font-semibold text-gray-700 mb-1">小計</label>
          <div className="w-full border rounded-lg px-3 py-2 bg-gray-100 text-right font-semibold">
            {formatMoney(calcAmount(item))}
          </div>
        </div>


        <div className="col-span-4">
          <label className="block text-base font-semibold text-gray-700 mb-1">
            用料明細（可修改，列印時會顯示在下方）
          </label>
          <textarea
            className="w-full border rounded-lg px-3 py-2"
            rows="2"
            value={item.specMaterial || ""}
            onChange={(e) => handleChange("specMaterial", e.target.value)}
          />
        </div>

        <div className="col-span-4">
          <label className="block text-base font-semibold text-gray-700 mb-1">備註</label>
          <textarea
            className="w-full border rounded-lg px-3 py-2"
            rows="2"
            value={item.remarks || ""}
            onChange={(e) => handleChange("remarks", e.target.value)}
          />
        </div>
      </div>

      {/* ===== 子項目 (編輯區顯示) ===== */}
      {showSub && (
        <div className="mt-4 border-t pt-4">
          
          <div className="space-y-4 mb-4">
            {(item.subItems || []).map((sub, idx) => (
              <div key={sub.id} className="border p-3 rounded-lg bg-gray-50 flex gap-4 items-start">
                <div className="mt-1 text-gray-500 font-bold">{idx + 1}.</div>
                
                {/* 圖片類型 */}
                {sub.type === "image" && (
                  <div className="flex-1">
                    <div className="font-semibold text-blue-600 mb-2">補充圖片</div>
                    <img src={sub.imageData} alt="upload" className="max-h-40 rounded border bg-white" />
                  </div>
                )}

                {/* 文字類型 */}
                {sub.type === "text" && (
                  <div className="flex-1">
                    <div className="font-semibold text-blue-600 mb-2">補充文字</div>
                    <input 
                      type="text" 
                      placeholder="標題..."
                      className="w-full border p-1 mb-1 rounded"
                      value={sub.name}
                      onChange={e => handleUpdateSub(sub.id, "name", e.target.value)}
                    />
                    <textarea 
                      placeholder="內容..."
                      className="w-full border p-1 rounded"
                      value={sub.remarks}
                      onChange={e => handleUpdateSub(sub.id, "remarks", e.target.value)}
                    />
                  </div>
                )}

                <button 
                  className="text-red-500 hover:text-red-700"
                  onClick={() => handleDeleteSub(sub.id)}
                >
                  刪除
                </button>
              </div>
            ))}
          </div>

          <div className="flex gap-3">
            <button
              className="px-4 py-2 bg-gray-200 rounded-lg text-base"
              onClick={handleAddSubText}
            >
              ＋ 補充文字
            </button>

            <label className="px-4 py-2 bg-gray-200 rounded-lg cursor-pointer text-base hover:bg-gray-300">
              ＋ 補充圖片
              <input
                type="file"
                accept="image/*"
                className="hidden"
                onChange={(e) => {
                  handleAddSubImage(e.target.files[0]);
                  // Reset input value to allow selecting same file again
                  e.target.value = '';
                }}
              />
            </label>
          </div>
        </div>
      )}
    </div>
  );
}

/***********************************************************
  * P4-3 — QuoteEditor / ExportButton / PrintButton / PrintLayout
 ***********************************************************/
// 報價單編輯主元件
function QuoteEditor() {
    const { activeQuote, updateQuote } = React.useContext(AppContext);
    const componentRef = React.useRef(null);

    if (!activeQuote) {
        return (
            <div className="p-8 text-center text-gray-500 text-xl">
                請從左側選擇一個報價單或新建一個報價單。
            </div>
        );
    }
    
    const handleChange = (field, value) => {
        updateQuote(activeQuote.id, { [field]: value });
    };

    const handleUpdateItem = (itemId, data) => {
        const newItems = activeQuote.items.map(item => 
            item.id === itemId ? { ...item, ...data } : item
        );
        updateQuote(activeQuote.id, { items: newItems });
    };

    const handleDeleteItem = (itemId) => {
        const newItems = activeQuote.items.filter(item => item.id !== itemId);
        updateQuote(activeQuote.id, { items: newItems });
    };

    const handleAddItem = () => {
        const newItem = {
            id: uuid(),
            name: "", 
            specMain: "",
            unit: "式",
            qty: 1,
            price: 0,
            subItems: [],
            remarks: "",
            specMaterial: ""
        };
        updateQuote(activeQuote.id, { items: [...activeQuote.items, newItem] });
    };
    
    const totalAmount = calcTotal(activeQuote.items);
    
    const negotiatedAmount = calcNegotiated(
        totalAmount,
        activeQuote.discountPercent,
        activeQuote.negotiatedPrice
    );

    // 判斷是否顯示最終報價（只要有折扣 OR 有自定義價格，就顯示）
    const showFinalPrice = (activeQuote.discountPercent > 0) || (activeQuote.negotiatedPrice > 0);

   return (
  <div className="quote-editor-root-container text-lg">
    {/* 編輯區 */}
    <div className="p-8 bg-gray-100 rounded-xl shadow-xl no-print">

      {/* ===== 標題 ===== */}
      <h1 className="text-3xl font-bold mb-6 border-b pb-3">
        編輯報價單：{activeQuote.title || "未命名"}
      </h1>

      {/* ===== 報價單基本資料（表頭卡） ===== */}
      <div className="bg-slate-50 p-6 rounded-xl mb-8 grid grid-cols-2 gap-x-6 gap-y-4 shadow-inner text-lg">

        <div className="col-span-2 flex items-center">
          <label className="font-semibold w-1/4 text-gray-700">報價單編號</label>
          <div className="text-xl font-mono text-blue-700">
            {activeQuote.quoteNo}
          </div>
        </div>

        <div className="col-span-2">
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            工程名稱 / 標題
          </label>
          <input
            type="text"
            value={activeQuote.title}
            onChange={(e) => handleChange("title", e.target.value)}
            className="w-full border rounded-lg px-3 py-2 text-base"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            客戶名稱
          </label>
          <input
            type="text"
            value={activeQuote.customerName}
            onChange={(e) => handleChange("customerName", e.target.value)}
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            聯絡人
          </label>
          <input
            type="text"
            value={activeQuote.contact}
            onChange={(e) => handleChange("contact", e.target.value)}
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            聯絡電話
          </label>
          <input
            type="text"
            value={activeQuote.phone}
            onChange={(e) => handleChange("phone", e.target.value)}
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            報價日期
          </label>
          <input
            type="date"
            value={activeQuote.date}
            onChange={(e) => handleChange("date", e.target.value)}
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        <div className="col-span-2">
          <label className="block text-sm font-semibold text-gray-700 mb-1">
            工程地點
          </label>
          <input
            type="text"
            value={activeQuote.location}
            onChange={(e) => handleChange("location", e.target.value)}
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        {/* ===== 金額摘要 ===== */}
        <div className="col-span-2 mt-4 p-4 bg-blue-100 rounded-lg">
          <div className="text-2xl font-bold text-blue-900">
            總計金額（未稅）：NT$ {formatMoney(totalAmount)}
          </div>
        </div>

        <div className="col-span-2 grid grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-1">
              折扣百分比（%）
            </label>
            <input
              type="number"
              value={activeQuote.discountPercent}
              onChange={(e) =>
                handleChange("discountPercent", Number(e.target.value))
              }
              className="w-full border rounded-lg px-3 py-2"
            />
          </div>

          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-1">
              最終報價（自定義）
            </label>
            <input
              type="number"
              value={activeQuote.negotiatedPrice}
              onChange={(e) =>
                handleChange("negotiatedPrice", Number(e.target.value))
              }
              className="w-full border rounded-lg px-3 py-2"
            />
          </div>
        </div>

        {showFinalPrice && (
          <div className="col-span-2 mt-2 p-4 bg-red-100 rounded-lg border-l-4 border-red-500">
            <div className="text-2xl font-bold text-red-800">
              最終報價金額（未稅）：NT$ {formatMoney(negotiatedAmount)}
            </div>
          </div>
        )}
      </div>

      {/* ===== 報價項目列表 ===== */}
      <h2 className="text-2xl font-bold mt-10 mb-4 border-b pb-2">
        報價項目列表
      </h2>

      <button
        className="bg-green-600 text-white px-5 py-2 rounded-lg mb-6 hover:bg-green-700 text-base"
        onClick={handleAddItem}
      >
        ＋ 新增工程大項
      </button>

      <div className="quote-items-container space-y-6">
        {activeQuote.items.map((item, index) => (
          <QuoteItem
            key={item.id}
            item={item}
            index={index}
            updateItem={(data) => handleUpdateItem(item.id, data)}
            deleteItem={handleDeleteItem}
          />
        ))}
      </div>

      {/* ===== 備註 / 付款條件 ===== */}
      <div className="mt-10 grid grid-cols-2 gap-8">
        <div>
          <h3 className="font-bold text-lg mb-2">備註（不含稅）</h3>
          <textarea
            value={activeQuote.notes}
            onChange={(e) => handleChange("notes", e.target.value)}
            rows="8"
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>

        <div>
          <h3 className="font-bold text-lg mb-2">付款條件</h3>
          <textarea
            value={activeQuote.payment}
            onChange={(e) => handleChange("payment", e.target.value)}
            rows="8"
            className="w-full border rounded-lg px-3 py-2"
          />
        </div>
      </div>

   {/* ===== 匯出 / 列印 ===== */}
<div className="mt-10 pt-6 border-t flex gap-4 justify-end">
  <ExportButton />
  <ExportWordButton componentRef={componentRef} />
  <PrintButton componentRef={componentRef} />
</div>

{/* ===== 即時預覽 ===== */}
<div className="live-preview-box mt-12 no-print">
  <h3 className="text-center font-bold text-2xl text-blue-700 mb-6">
    實時預覽區（非列印尺寸）
  </h3>
  <div className="print-page">
    <PrintLayout
      quote={activeQuote}
      totalAmount={totalAmount}
      negotiatedAmount={negotiatedAmount}
      isPreview={true}
    />
  </div>
</div>
</div>

{/* ===== 列印專用隱藏區（⚠️ 這裡一定要留，而且一定要包 print-page） ===== */}
<div
  ref={componentRef}
  className="print-only-layout"
  style={{ 
    position: "absolute", 
    top: -9999, 
    left: -9999,
    zIndex: -9999,
    pointerEvents: "none",
    width: 0,
    height: 0,
    overflow: "hidden"
  }}
>
  {/* ⭐ 關鍵修正：補上 print-page ⭐ */}
  <div className="print-page">
    <PrintLayout
      quote={activeQuote}
      totalAmount={totalAmount}
      negotiatedAmount={negotiatedAmount}
      isPreview={false}
    />
  </div>
</div>
</div>
);
}


// ===============================
// Excel 匯出
// ===============================
function ExportButton() {
  const { activeQuote } = React.useContext(AppContext);

  const handleExport = () => {
    if (!activeQuote || !activeQuote.items?.length) {
      alert("請先新增報價項目");
      return;
    }

    const companyKey = activeQuote.company || "herhsin";
    const company = COMPANY_DATA[companyKey];
    const total = calcTotal(activeQuote.items);
    const negotiated = calcNegotiated(total, activeQuote.discountPercent, activeQuote.negotiatedPrice);
    
    // 判斷是否顯示最終報價
    const showFinalPrice = (activeQuote.discountPercent > 0) || (activeQuote.negotiatedPrice > 0);

    const rows = [];
    let r = 0;

    rows[r++] = [company.name];
    rows[r++] = ["工程報價單"];
    rows[r++] = [];

    rows[r++] = ["報價單號", activeQuote.quoteNo, "", "", "報價日期", activeQuote.date];
    rows[r++] = ["工程名稱", activeQuote.title];
    rows[r++] = ["客戶名稱", activeQuote.customerName, "", "聯絡人", activeQuote.contact];
    rows[r++] = ["工程地點", activeQuote.location];
    rows[r++] = [];

    rows[r++] = ["項次","品名","規格 / 補充內容","單位","數量","單價","金額(小計)","備註","用料明細"];

    let index = 1;
    activeQuote.items.forEach(item => {
      rows[r++] = [
        index++,
        item.name || "",
        item.specMain || "",
        item.unit || "",
        item.qty || "",
        item.price || "",
        calcAmount(item),
        item.remarks || "",
        item.specMaterial || ""
      ];

      if (item.specMaterial) {
         rows[r++] = ["", `用料明細：${item.specMaterial}`, "", "", "", "", "", "", ""];
      }

      (item.subItems || []).forEach(sub => {
        if (sub.type === "text") {
          rows[r++] = ["", `補充：${sub.name || ""}`, sub.remarks || "", "", "", "", "", "", ""];
        }
        if (sub.type === "image") {
          rows[r++] = ["", "補充圖片", "（圖片請參考列印版）", "", "", "", "", "", ""];
        }
      });
    });

    rows[r++] = [];
    rows[r++] = ["", "", "", "", "", "總計", total];
    
    // ⭐ 如果沒有折扣/自定義價格，就不輸出這兩行
    if (showFinalPrice) {
        rows[r++] = ["", "", "", "", "", "折扣(%)", activeQuote.discountPercent || 0];
        rows[r++] = ["", "", "", "", "", "最終報價", negotiated];
    }
    
    rows[r++] = [];
    rows[r++] = ["備註"];
    rows[r++] = [activeQuote.notes || ""];
    rows[r++] = [];
    rows[r++] = ["付款條件"];
    rows[r++] = [activeQuote.payment || ""];

    const ws = XLSX.utils.aoa_to_sheet(rows);

    ws["!merges"] = [
      { s: { r: 0, c: 0 }, e: { r: 0, c: 8 } },
      { s: { r: 1, c: 0 }, e: { r: 1, c: 8 } },
      { s: { r: 4, c: 1 }, e: { r: 4, c: 8 } },
      { s: { r: 5, c: 1 }, e: { r: 5, c: 8 } },
    ];
    
    ws["!cols"] = [{ wch: 12 }, { wch: 26 }, { wch: 42 }, { wch: 8 }, { wch: 8 }, { wch: 16 }, { wch: 18 }, { wch: 22 }, { wch: 32 }];

    Object.keys(ws).forEach(key => {
      if (ws[key]?.v && typeof ws[key].v === "number") ws[key].z = "#,##0";
    });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "報價單");

    const filename = `${activeQuote.quoteNo}_${activeQuote.customerName || "未填客戶"}-${activeQuote.title || "未命名工程"} 報價單.xlsx`.replace(/[\\/:*?"<>|]/g,"");
    XLSX.writeFile(wb, filename);
  };

  return (
    <button
      onClick={handleExport}
      className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
    >
      匯出 Excel（報價單版型）
    </button>
  );
}

// ===============================
// Word 匯出
// ===============================
function ExportWordButton({ componentRef }) {
  const { activeQuote } = React.useContext(AppContext);

  const handleExportWord = () => {
    if (!componentRef?.current || !activeQuote) {
      alert("找不到報價單內容，請確認預覽已載入");
      return;
    }

    const htmlContent = componentRef.current.innerHTML;

    const wordHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>工程報價單</title>
  <style>
    @page { size: A4; margin: 15mm; margin-top: 80mm; }
    body { margin: 0; padding: 0; }
    .word-page { width: 794px; margin: 0 auto; padding: 20px; box-sizing: border-box; font-family: "Microsoft JhengHei", sans-serif; font-size: 15px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #000; padding: 6px; font-size: 15px; vertical-align: top; }
    img { display: block; margin: 10px auto; max-width: 80%; height: auto; }
  </style>
</head>
<body>
  <div class="word-page">${htmlContent}</div>
</body>
</html>`;

    const filename = `${activeQuote.quoteNo}_${activeQuote.customerName || "未填客戶"}-${activeQuote.title || "未命名工程"} 報價單.doc`.replace(/[\\/:*?"<>|]/g, "");
    const blob = new Blob(["\ufeff", wordHTML], { type: "application/msword;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <button onClick={handleExportWord} className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
      匯出 Word（報價單版型）
    </button>
  );
}
function PrintButton() {
  return (
    <button
      onClick={() => window.print()}
      className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
    >
      列印報價單
    </button>
  );
}

/***********************************************************
 * 列印排版組件（PrintLayout）— 多頁固定頁首【最終正確版】
 ***********************************************************/
function PrintLayout({ quote, totalAmount, negotiatedAmount }) {
  if (!quote || !COMPANY_DATA[quote.company]) {
    return (
      <div style={{ textAlign: "center", padding: 20, color: "#888" }}>
        請選擇或新增報價單以顯示預覽
      </div>
    );
  }

  const companyInfo = COMPANY_DATA[quote.company];
  const TH_TD = { border: "1px solid #000", padding: "6px", fontSize: "13px", verticalAlign: "top" };
  const TH = { ...TH_TD, background: "#f0f0f0", fontWeight: "bold", textAlign: "center" };
  const TD_RIGHT = { ...TH_TD, textAlign: "right" };

  // 判斷是否顯示最終報價（Print版）
  const showFinalPrice = (quote.discountPercent > 0) || (quote.negotiatedPrice > 0);

  return (
    <div className="print-page">

     


      {/* ===== 所有會換頁的內容一定要包在這 ===== */}
      <div className="print-content">
        {/* ===== 每一頁都要出現的公司 / 客戶資料 ===== */}
<table style={{ width: "100%", borderCollapse: "collapse", marginBottom: 10 }}>
  <tbody>
    <tr>
      <td style={{ textAlign: "center", paddingBottom: 6 }}>
        <h2 style={{ margin: 0 }}>{companyInfo.name}</h2>
        <div style={{ fontSize: 13 }}>
          統編 {companyInfo.taxId} ｜ 電話 {companyInfo.tel} ｜ 傳真 {companyInfo.fax}
        </div>
        <div style={{ fontSize: 13 }}>{companyInfo.address}</div>
        <h3 style={{ marginTop: 6 }}>工程報價單</h3>
      </td>
    </tr>
    <tr>
      <td style={{ fontSize: 13 }}>
        <div style={{ display: "flex", justifyContent: "space-between" }}>
          <div>報價單號：{quote.quoteNo}</div>
          <div>報價日期：{quote.date}</div>
        </div>
        <div>工程名稱：{quote.title}</div>
        <div style={{ display: "flex", justifyContent: "space-between" }}>
          <div>客戶名稱：{quote.customerName}</div>
          <div>聯絡人：{quote.contact}</div>
        </div>
        <div style={{ display: "flex", justifyContent: "space-between" }}>
          <div>聯絡電話：{quote.phone}</div>
          <div>工程地點：{quote.location}</div>
        </div>
      </td>
    </tr>
  </tbody>
</table>


        <table style={{ width: "100%", borderCollapse: "collapse" }}>
          <colgroup>
    <col style={{ width: "6%" }} />
    <col style={{ width: "18%" }} />
    <col style={{ width: "22%" }} />
    <col style={{ width: "6%" }} />
    <col style={{ width: "6%" }} />
    <col style={{ width: "14%" }} />
    <col style={{ width: "14%" }} />
    <col style={{ width: "14%" }} />
  </colgroup>
          <thead>

  {/* ===== 欄位標題（Chrome 會自動重複） ===== */}
  <tr>
    <th style={TH}>項次</th>
    <th style={TH}>品名</th>
    <th style={TH}>規格</th>
    <th style={TH}>單位</th>
    <th style={TH}>數量</th>
    <th style={TH}>單價</th>
    <th style={TH}>小計</th>
    <th style={TH}>備註</th>
  </tr>
</thead>
          <tbody>
            {quote.items.map((item, i) => (
              <React.Fragment key={item.id}>
                {/* 第一列：主要項目 */}
                <tr>
                  <td style={{ ...TH_TD, textAlign: "center" }}>{i + 1}</td>
                  <td style={TH_TD}>{item.name}</td>
                  <td style={TH_TD}>{item.specMain}</td>
                  <td style={{ ...TH_TD, textAlign: "center" }}>{item.unit}</td>
                  <td style={{ ...TH_TD, textAlign: "center" }}>{item.qty}</td>
                  <td style={TD_RIGHT}>{formatMoney(item.price)}</td>
                  <td style={{ ...TD_RIGHT, fontWeight: "bold" }}>
                    {formatMoney(calcAmount(item))}
                  </td>
                  <td style={TH_TD}>{item.remarks}</td>
                </tr>

                {/* 第二列：用料明細 */}
                {item.specMaterial && (
                  <tr>
                    <td style={{ ...TH_TD, borderTop: "none" }}></td>
                    <td colSpan="7" style={{ ...TH_TD, color: "#444", borderTop: "1px dashed #ccc" }}>
                      <span style={{ fontWeight: "bold" }}>用料明細：</span>
                      {item.specMaterial}
                    </td>
                  </tr>
                )}

                {/* 第三列：補充圖片（自動置中） */}
                {item.subItems && item.subItems.map(sub => {
                  if (sub.type === "image") {
                    return (
                      <tr key={sub.id}>
                         <td style={{ ...TH_TD, borderTop: "none" }}></td>
                         <td colSpan="7" style={{ ...TH_TD, textAlign: "center", padding: "10px" }}>
                            <img src={sub.imageData} alt="圖片" style={{ maxWidth: "60%", display: "block", margin: "0 auto" }} />
                         </td>
                      </tr>
                    )
                  }
                  if (sub.type === "text") {
                    return (
                      <tr key={sub.id}>
                         <td style={{ ...TH_TD, borderTop: "none" }}></td>
                         <td colSpan="7" style={{ ...TH_TD, color: "#666" }}>
                            <span style={{fontWeight: "bold"}}>{sub.name}</span>：{sub.remarks}
                         </td>
                      </tr>
                    )
                  }
                })}
              </React.Fragment>
            ))}
          </tbody>
        </table>

        {/* ===== 金額總結 ===== */}
        <table style={{ width: "100%", borderCollapse: "collapse", marginTop: 10 }}>
          <tbody>
            <tr>
              <td colSpan={6} style={{ ...TD_RIGHT, fontWeight: "bold" }}>
                總計金額（未稅）
              </td>
              <td style={{ ...TD_RIGHT, fontWeight: "bold" }}>
                {formatMoney(totalAmount)}
              </td>
              <td style={TH_TD}></td>
            </tr>
            
            {showFinalPrice && (
                <tr>
                  <td colSpan={6} style={{ ...TD_RIGHT, fontWeight: "bold" }}>
                    最終報價金額（未稅）
                  </td>
                  <td style={{ ...TD_RIGHT, fontWeight: "bold", color: "red" }}>
                    {formatMoney(negotiatedAmount)}
                  </td>
                  <td style={TH_TD}></td>
                </tr>
            )}
          </tbody>
        </table>
<div className="print-footer-block">

  {/* ===== 備註 / 付款條件 ===== */}
  <table style={{ width: "100%", borderCollapse: "collapse", marginTop: 15 }}>
    <tbody>
      <tr>
        <td style={{ ...TH_TD, width: "50%" }}>
          <strong>備註（不含稅）</strong>
          <div style={{ whiteSpace: "pre-wrap", marginTop: 6 }}>
            {quote.notes}
          </div>
        </td>
        <td style={{ ...TH_TD, width: "50%" }}>
          <strong>付款條件</strong>
          <div style={{ whiteSpace: "pre-wrap", marginTop: 6 }}>
            {quote.payment}
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  {/* ===== 簽章區 ===== */}
  <table
    className="print-signature-area"
    style={{ width: "100%", borderCollapse: "collapse", marginTop: 30 }}
  >
    <tbody>
      <tr>
        <td style={{ ...TH_TD, width: "50%", height: 120 }}>
          <strong>公司報價章</strong>
          {companyInfo.stamp && (
            <img
              src={companyInfo.stamp}
              alt="公司印章"
              style={{ display: "block", margin: "10px auto", maxHeight: 70 }}
            />
          )}
          <div style={{ borderTop: "1px solid #000", marginTop: 10 }}>
            代表人：
          </div>
        </td>
        <td style={{ ...TH_TD, width: "50%", height: 120 }}>
          <strong>客戶回簽</strong>
          <div style={{ borderTop: "1px solid #000", marginTop: 70 }}>
            代表人：
          </div>
        </td>
      </tr>
      <tr>
        <td style={TH_TD}>日期：</td>
        <td style={TH_TD}>日期：</td>
      </tr>
    </tbody>
  </table>

</div>
      </div>
    </div>
  );
}


/***********************************************************
  // P5 — App 根元件
 ***********************************************************/
function App() {
    return (
        <div className="min-h-screen bg-gray-50 flex">
            <div className="w-96 bg-white p-6 shadow-lg flex-shrink-0 text-lg sticky top-0 h-screen overflow-y-auto">
                <h1 className="text-2xl font-extrabold mb-6 text-center text-blue-700">工程報價系統</h1>
                <CompanySelector />
                <ModeSelector />
                <QuoteList />
            </div>
            
            <div className="flex-grow p-8 text-base">
                <QuoteEditor />
            </div>
        </div>
    );
}

/***********************************************************
 * P6 — React 18 啟動
 ***********************************************************/
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(
  <AppProvider>
    <App />
  </AppProvider>
);
</script>
</body>
</html>
